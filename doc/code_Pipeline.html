<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Bedtools" rel="Chapter" href="Bedtools.html">
<link title="Bwa" rel="Chapter" href="Bwa.html">
<link title="Common" rel="Chapter" href="Common.html">
<link title="Common_pipelines" rel="Chapter" href="Common_pipelines.html">
<link title="Cufflinks" rel="Chapter" href="Cufflinks.html">
<link title="Cycledash" rel="Chapter" href="Cycledash.html">
<link title="Gatk" rel="Chapter" href="Gatk.html">
<link title="Hisat" rel="Chapter" href="Hisat.html">
<link title="Mosaik" rel="Chapter" href="Mosaik.html">
<link title="Muse" rel="Chapter" href="Muse.html">
<link title="Mutect" rel="Chapter" href="Mutect.html">
<link title="Picard" rel="Chapter" href="Picard.html">
<link title="Pipeline" rel="Chapter" href="Pipeline.html">
<link title="Reference_genome" rel="Chapter" href="Reference_genome.html">
<link title="Region" rel="Chapter" href="Region.html">
<link title="Run_environment" rel="Chapter" href="Run_environment.html">
<link title="Samtools" rel="Chapter" href="Samtools.html">
<link title="Somaticsniper" rel="Chapter" href="Somaticsniper.html">
<link title="Star" rel="Chapter" href="Star.html">
<link title="Strelka" rel="Chapter" href="Strelka.html">
<link title="Stringtie" rel="Chapter" href="Stringtie.html">
<link title="Varscan" rel="Chapter" href="Varscan.html">
<link title="Vcftools" rel="Chapter" href="Vcftools.html">
<link title="Virmid" rel="Chapter" href="Virmid.html">
<link title="Workflow_utilities" rel="Chapter" href="Workflow_utilities.html"><title>Pipeline</title>
</head>
<body>
<code class="code"></code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Run_environment</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">File</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">type</span>&nbsp;json&nbsp;=&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json<br>
<br>
<span class="keyword">type</span>&nbsp;fastq_gz&nbsp;=&nbsp;<span class="constructor">Fastq_gz</span><br>
<span class="keyword">type</span>&nbsp;fastq&nbsp;=&nbsp;<span class="constructor">Fastq</span><br>
<span class="keyword">type</span>&nbsp;fastq_sample&nbsp;=&nbsp;<span class="constructor">Fastq_sample</span><br>
<span class="keyword">type</span>&nbsp;bam&nbsp;=&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node<br>
<span class="keyword">type</span>&nbsp;bam_pair&nbsp;=&nbsp;<span class="constructor">Bam_pair</span><br>
<span class="keyword">type</span>&nbsp;vcf&nbsp;=&nbsp;<span class="constructor">Vcf</span><br>
<br>
<span class="keyword">type</span>&nbsp;bwa_params&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;gap_open_penalty:&nbsp;int;<br>
&nbsp;&nbsp;gap_extension_penalty:&nbsp;int;<br>
}<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration_json:&nbsp;json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration_name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_target:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Reference_genome</span>.specification&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_with:<span class="constructor">Run_environment</span>.<span class="constructor">Machine</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_prefix:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges:&nbsp;<span class="constructor">KEDSL</span>.workflow_edge&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
&nbsp;&nbsp;}<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration_json:&nbsp;json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration_name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_target:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Reference_genome</span>.specification&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_with:<span class="constructor">Run_environment</span>.<span class="constructor">Machine</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_bam:&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_prefix:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges:&nbsp;<span class="constructor">KEDSL</span>.workflow_edge&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
&nbsp;&nbsp;}<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">type</span>&nbsp;_&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq_gz</span>:&nbsp;<span class="constructor">File</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_gz&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>:&nbsp;<span class="constructor">File</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;|&nbsp;List:&nbsp;'a&nbsp;t&nbsp;list&nbsp;-&gt;&nbsp;'a&nbsp;list&nbsp;t&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>:&nbsp;string&nbsp;*&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;]&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_sample&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>:&nbsp;string&nbsp;*&nbsp;fastq&nbsp;&nbsp;t&nbsp;*&nbsp;fastq&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_sample&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>:&nbsp;string&nbsp;*&nbsp;fastq&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_sample&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>:&nbsp;fastq_gz&nbsp;&nbsp;t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>:&nbsp;fastq&nbsp;&nbsp;t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>:&nbsp;fastq_sample&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>:&nbsp;fastq_sample&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>:&nbsp;bwa_params&nbsp;*&nbsp;fastq_sample&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>:&nbsp;bwa_params&nbsp;*&nbsp;fastq_sample&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>:&nbsp;fastq_sample&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>:&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>:&nbsp;<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.t&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>:&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>:&nbsp;bam&nbsp;&nbsp;t&nbsp;*&nbsp;bam&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam_pair&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>:&nbsp;<span class="constructor">Somatic_variant_caller</span>.t&nbsp;*&nbsp;bam_pair&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vcf&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>:&nbsp;<span class="constructor">Germline_variant_caller</span>.t&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vcf&nbsp;t<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Construct</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;input_fastq&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">File</span>.t&nbsp;list&nbsp;*&nbsp;<span class="constructor">File</span>.t&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">File</span>.t&nbsp;list<br>
&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_fastq&nbsp;~dataset&nbsp;(fastqs:&nbsp;input_fastq)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_fastq_gz&nbsp;p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;p&nbsp;<span class="string">"fastq.gz"</span>&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;p&nbsp;<span class="string">"fq.gz"</span>&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bring_to_single_fastq&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;l&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;h&nbsp;::&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;more&nbsp;<span class="keyword">when</span>&nbsp;is_fastq_gz&nbsp;h<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;more&nbsp;(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;f))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"for&nbsp;now,&nbsp;a&nbsp;sample&nbsp;must&nbsp;be&nbsp;a&nbsp;list&nbsp;of&nbsp;fastq.gz"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fastqs&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;(l1,&nbsp;l2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(dataset,&nbsp;bring_to_single_fastq&nbsp;l1,&nbsp;bring_to_single_fastq&nbsp;l2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;(dataset,&nbsp;bring_to_single_fastq&nbsp;l)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;~dataset&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(dataset,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_to_fastq&nbsp;how&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(how,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(gap_open_penalty=<span class="constructor">Bwa</span>.default_gap_open_penalty)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(gap_extension_penalty=<span class="constructor">Bwa</span>.default_gap_extension_penalty)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;params&nbsp;=&nbsp;{gap_open_penalty;&nbsp;gap_extension_penalty}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa</span>&nbsp;(params,&nbsp;fastq)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_mem<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(gap_open_penalty=<span class="constructor">Bwa</span>.default_gap_open_penalty)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(gap_extension_penalty=<span class="constructor">Bwa</span>.default_gap_extension_penalty)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;params&nbsp;=&nbsp;{gap_open_penalty;&nbsp;gap_extension_penalty}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;(params,&nbsp;fastq)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik&nbsp;fastq&nbsp;=&nbsp;<span class="constructor">Mosaik</span>&nbsp;fastq<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star&nbsp;fastq&nbsp;=&nbsp;<span class="constructor">Star</span>&nbsp;fastq<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat&nbsp;fastq&nbsp;=&nbsp;<span class="constructor">Hisat</span>&nbsp;fastq<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;bam<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_mark_duplicates<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(settings=<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.default)&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(settings,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_bqsr&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;bam<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair&nbsp;~normal&nbsp;~tumor&nbsp;=&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(normal,&nbsp;tumor)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;germline_variant_caller&nbsp;t&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(t,&nbsp;input_bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_haplotype_caller&nbsp;input_bam&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=&nbsp;<span class="string">"default"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~run_with&nbsp;~input_bam&nbsp;~result_prefix&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.haplotype_caller&nbsp;?more_edges&nbsp;~reference_build&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~input_bam&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;germline_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Germline_variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Gatk-HaplotypeCaller"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_bam<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somatic_variant_caller&nbsp;t&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(t,&nbsp;bam_pair)<br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=&nbsp;<span class="string">"default"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Mutect</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Somatic_variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Mutect"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somaticsniper<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(prior_probability=<span class="constructor">Somaticsniper</span>.default_prior_probability)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(theta=<span class="constructor">Somaticsniper</span>.default_theta)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"S%F-T%F"</span>&nbsp;prior_probability&nbsp;theta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Prior-probability"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Float</span>&nbsp;prior_probability;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Theta"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Float</span>&nbsp;theta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Somaticsniper</span>.run&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~minus_s:prior_probability&nbsp;~minus_T:theta<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Somatic_variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Somaticsniper"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_somatic&nbsp;?adjust_mapq&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"amq-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value_map&nbsp;~default:<span class="string">"NONE"</span>&nbsp;adjust_mapq&nbsp;~f:<span class="constructor">Int</span>.to_string)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Adjust_mapq"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;(<span class="constructor">Option</span>.value_map&nbsp;adjust_mapq&nbsp;~f:<span class="constructor">Int</span>.to_string&nbsp;~default:<span class="string">"None"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Somatic_variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Varscan-somatic"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;=&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~reference_build&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Varscan</span>.somatic_map_reduce&nbsp;~reference_build&nbsp;?adjust_mapq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;strelka&nbsp;~configuration&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Somatic_variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Strelka"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;=&nbsp;<span class="constructor">Strelka</span>.run&nbsp;~configuration;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid&nbsp;~configuration&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Somatic_variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Virmid"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;=&nbsp;<span class="constructor">Virmid</span>.run&nbsp;~configuration;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse&nbsp;~configuration&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Muse</span>.run&nbsp;~reference_build&nbsp;~configuration&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Somatic_variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Muse"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_file_prefix:<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;a.<br>
&nbsp;&nbsp;?is:[&nbsp;<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;?read:[&nbsp;<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">R2</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;?is&nbsp;?read&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_suffix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;is&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"-normal"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"-tumor"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;w&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;(name,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;name&nbsp;^&nbsp;is_suffix<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;(_&nbsp;::&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;read&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;is_suffix&nbsp;^&nbsp;<span class="string">"-cat"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;s)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s%s-R1-cat"</span>&nbsp;s&nbsp;is_suffix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">R2</span>&nbsp;s)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s%s-R2-cat"</span>&nbsp;s&nbsp;is_suffix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(name,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;name&nbsp;^&nbsp;is_suffix<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(how,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-b2fq-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;?is&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"PE"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"SE"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(name,&nbsp;_&nbsp;,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;^&nbsp;is_suffix<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;({&nbsp;gap_open_penalty;&nbsp;gap_extension_penalty&nbsp;},&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-bwa-gap%d-gep%d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;?is&nbsp;sample)&nbsp;gap_open_penalty&nbsp;gap_extension_penalty<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;({&nbsp;gap_open_penalty;&nbsp;gap_extension_penalty&nbsp;},&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-bwa-mem-gap%d-gep%d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;?is&nbsp;sample)&nbsp;gap_open_penalty&nbsp;gap_extension_penalty<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>&nbsp;(sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-star-aligned"</span>&nbsp;(to_file_prefix&nbsp;?is&nbsp;sample)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;(sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-hisat-aligned"</span>&nbsp;(to_file_prefix&nbsp;?is&nbsp;sample)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;(sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-mosaik"</span>&nbsp;(to_file_prefix&nbsp;?is&nbsp;sample)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-indelrealigned"</span>&nbsp;(to_file_prefix&nbsp;?is&nbsp;?read&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-bqsr"</span>&nbsp;(to_file_prefix&nbsp;?is&nbsp;?read&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(_,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;settings,&nbsp;for&nbsp;now,&nbsp;do&nbsp;not&nbsp;impact&nbsp;the&nbsp;result&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-dedup"</span>&nbsp;(to_file_prefix&nbsp;?is&nbsp;?read&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(nor,&nbsp;tum)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_file_prefix&nbsp;?is:<span class="constructor">None</span>&nbsp;tum<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(vc,&nbsp;bp)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prev&nbsp;=&nbsp;to_file_prefix&nbsp;bp&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s-%s"</span>&nbsp;prev<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Somatic_variant_caller</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Somatic_variant_caller</span>.configuration_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(vc,&nbsp;bp)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prev&nbsp;=&nbsp;to_file_prefix&nbsp;bp&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s-%s"</span>&nbsp;prev<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Germline_variant_caller</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Germline_variant_caller</span>.configuration_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_json:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;json&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_params&nbsp;{gap_open_penalty;&nbsp;gap_extension_penalty}&nbsp;input&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"gap_open_penalty"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Int</span>&nbsp;gap_open_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"gap_extension_penalty"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Int</span>&nbsp;gap_extension_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"input"</span>,&nbsp;input]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;call&nbsp;name&nbsp;(args&nbsp;:&nbsp;json&nbsp;list):&nbsp;json&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">List</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name&nbsp;::&nbsp;args)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;w&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;file&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;call&nbsp;<span class="string">"Fastq_gz"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;file<span class="keywordsign">#</span>target<span class="keywordsign">#</span>name]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;file&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;call&nbsp;<span class="string">"Fastq"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;file<span class="keywordsign">#</span>target<span class="keywordsign">#</span>name]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(name,&nbsp;file)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Bam-sample"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;file<span class="keywordsign">#</span>target<span class="keywordsign">#</span>name]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(how,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;how_string&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Paired"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Single"</span>&nbsp;<span class="keyword">in</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Bam-to-fastq"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;how_string;&nbsp;to_json&nbsp;bam]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(name,&nbsp;r1,&nbsp;r2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Paired-end"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;&nbsp;to_json&nbsp;r1;&nbsp;to_json&nbsp;r2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;(name,&nbsp;r)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Single-end"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;&nbsp;to_json&nbsp;r]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;fastq_gz_list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Gunzip-concat"</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:to_json&nbsp;fastq_gz_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>&nbsp;fastq_list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Concat"</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:to_json&nbsp;fastq_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;(params,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"BWA"</span>&nbsp;[bwa_params&nbsp;params&nbsp;input_json]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;(params,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"BWA-MEM"</span>&nbsp;[bwa_params&nbsp;params&nbsp;input_json]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>&nbsp;(input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"STAR"</span>&nbsp;[input_json]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;(input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"HISAT"</span>&nbsp;[input_json]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;(input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"MOSAIK"</span>&nbsp;[input_json]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Gatk_indel_realigner"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"input"</span>,&nbsp;input_json]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Gatk_bqsr"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"input"</span>,&nbsp;input_json]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(gvc,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;gvc.<span class="constructor">Germline_variant_caller</span>.name&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Configuration"</span>,&nbsp;gvc.<span class="constructor">Germline_variant_caller</span>.configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;to_json&nbsp;bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(settings,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;settings&nbsp;should&nbsp;not&nbsp;impact&nbsp;the&nbsp;output,&nbsp;so&nbsp;we&nbsp;don't&nbsp;dump&nbsp;them.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Picard_mark_duplicates"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"input"</span>,&nbsp;to_json&nbsp;bam]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(normal,&nbsp;tumor)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Bam-pair"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"normal"</span>,&nbsp;to_json&nbsp;normal;&nbsp;<span class="string">"tumor"</span>,&nbsp;to_json&nbsp;tumor]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(svc,&nbsp;bam_pair)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;svc.<span class="constructor">Somatic_variant_caller</span>.name&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Configuration"</span>,&nbsp;svc.<span class="constructor">Somatic_variant_caller</span>.configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;to_json&nbsp;bam_pair;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Compiler</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;pipeline&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;t<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;processors&nbsp;:&nbsp;int;<br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Reference_genome</span>.specification;<br>
&nbsp;&nbsp;&nbsp;&nbsp;work_dir:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;machine&nbsp;:&nbsp;<span class="constructor">Machine</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;wrap_bam_node:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam&nbsp;pipeline&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node;<br>
&nbsp;&nbsp;&nbsp;&nbsp;wrap_vcf_node:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vcf&nbsp;pipeline&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.single_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.single_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(wrap_bam_node&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(wrap_vcf_node&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~processors&nbsp;~reference_build&nbsp;~work_dir&nbsp;~machine&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{processors;&nbsp;reference_build;&nbsp;work_dir;&nbsp;machine;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrap_bam_node;&nbsp;wrap_vcf_node}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;compile_aligner_step<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~compiler&nbsp;?(is:[<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>]&nbsp;option)&nbsp;(pipeline&nbsp;:&nbsp;bam&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{processors&nbsp;;&nbsp;reference_build;&nbsp;work_dir;&nbsp;machine&nbsp;;}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip_concat&nbsp;?read&nbsp;(pipeline:&nbsp;fastq&nbsp;&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>&nbsp;(l:&nbsp;fastq&nbsp;pipeline&nbsp;list)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Concat_text:&nbsp;not&nbsp;implemented"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;(l:&nbsp;fastq_gz&nbsp;pipeline&nbsp;list)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastqs&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;l&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_path&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;?is&nbsp;?read&nbsp;pipeline&nbsp;^&nbsp;<span class="string">".fastq"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Path:&nbsp;%S"</span>&nbsp;result_path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Gunzip</span>.concat&nbsp;~run_with:machine&nbsp;fastqs&nbsp;~result_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;?is&nbsp;pipeline&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Prefix:&nbsp;%S"</span>&nbsp;result_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;compile_fastq_sample&nbsp;(fs&nbsp;:&nbsp;fastq_sample&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fs&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(how,&nbsp;what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;?is&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sample_type&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_prefix&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;?is&nbsp;?read:<span class="constructor">None</span>&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Picard</span>.bam_to_fastq&nbsp;~run_with:machine&nbsp;~processors&nbsp;~sample_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~output_prefix&nbsp;bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_pair<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(dataset,&nbsp;l1,&nbsp;l2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;gunzip_concat&nbsp;~read:(<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;dataset)&nbsp;l1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=&nbsp;gunzip_concat&nbsp;~read:(<span class="keywordsign">`</span><span class="constructor">R2</span>&nbsp;dataset)&nbsp;l2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;(fastq_reads&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;machine)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;(<span class="constructor">Some</span>&nbsp;r2<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"pairing&nbsp;%s&nbsp;and&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r2<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[&nbsp;depends_on&nbsp;r1;&nbsp;depends_on&nbsp;r2&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;(dataset,&nbsp;single)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;gunzip_concat&nbsp;~read:(<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;dataset)&nbsp;single&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;(fastq_reads&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;machine)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~equivalence:<span class="keywordsign">`</span><span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[&nbsp;depends_on&nbsp;r1&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"single-end&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(name,&nbsp;bam_target)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;?is&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">".bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.indel_realigner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~processors&nbsp;~reference_build&nbsp;~run_with:machine&nbsp;input_bam&nbsp;~compress:<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~output_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;?is&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">".bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.base_quality_score_recalibrator<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with:machine&nbsp;~processors&nbsp;~reference_build&nbsp;~input_bam&nbsp;~output_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(settings,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;?is&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">".bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Picard</span>.mark_duplicates&nbsp;~settings<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with:machine&nbsp;~input_bam&nbsp;output_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;({gap_open_penalty;&nbsp;gap_extension_penalty},&nbsp;what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;compile_fastq_sample&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa</span>.mem_align_to_sam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~gap_open_penalty&nbsp;~gap_extension_penalty<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~run_with:machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;({gap_open_penalty;&nbsp;gap_extension_penalty},&nbsp;what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;compile_fastq_sample&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa</span>.align_to_sam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~gap_open_penalty&nbsp;~gap_extension_penalty<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~run_with:machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;(what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;compile_fastq_sample&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Mosaik</span>.align&nbsp;~reference_build&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>&nbsp;(what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;compile_fastq_sample&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Star</span>.align&nbsp;~reference_build&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;(what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;compile_fastq_sample&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hisat</span>.align&nbsp;~reference_build&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~run_with:machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;compiler.wrap_bam_node&nbsp;pipeline&nbsp;bam_node<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;compile_variant_caller_step&nbsp;~compiler&nbsp;(pipeline:&nbsp;vcf&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{processors&nbsp;;&nbsp;reference_build;&nbsp;work_dir;&nbsp;machine&nbsp;;}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;pipeline&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Prefix:&nbsp;%S"</span>&nbsp;result_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcf_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(som_vc,&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(normal_t,&nbsp;tumor_t))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;~is:<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;normal_t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;~is:<span class="keywordsign">`</span><span class="constructor">Tumor</span>&nbsp;tumor_t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;som_vc.<span class="constructor">Somatic_variant_caller</span>.make_target&nbsp;~reference_build&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with:machine&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(gvc,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;~is:<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvc.<span class="constructor">Germline_variant_caller</span>.make_target&nbsp;~processors&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with:machine&nbsp;~input_bam&nbsp;~result_prefix&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;compiler.wrap_vcf_node&nbsp;pipeline&nbsp;vcf_node<br>
<br>
<span class="keyword">end</span><br>
</code></body></html>