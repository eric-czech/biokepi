<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of extensions" rel=Appendix href="index_extensions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Biokepi_run_environment" rel="Chapter" href="Biokepi_run_environment.html">
<link title="Biokepi_environment_setup" rel="Chapter" href="Biokepi_environment_setup.html">
<link title="Biokepi_bfx_tools" rel="Chapter" href="Biokepi_bfx_tools.html">
<link title="Biokepi_pipeline_edsl" rel="Chapter" href="Biokepi_pipeline_edsl.html">
<link title="All_downloads" rel="Chapter" href="All_downloads.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Ttfi_pipeline" rel="Chapter" href="Ttfi_pipeline.html">
<link title="Biokepi" rel="Chapter" href="Biokepi.html"><title>Biokepi API : Biokepi_run_environment</title>
</head>
<body>
<code class="code"><span class="comment">(*&nbsp;code&nbsp;generated&nbsp;with&nbsp;[/Volumes/Encrypted_zzz/dev/biokepi/tools/build-doc.sh&nbsp;ketrew,ppx_deriving.std]&nbsp;*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Common</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Module opened by default (like
<a href="http://caml.inria.fr/pub/docs/manual-ocaml/libref/Pervasives.html">Pervasives</a>)
for our library. *)</span></td></tr></table><code class="code"><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** A <a href="http://seb.mondet.org/software/nonstd/index.html">Non-standard mini
library</a>. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">include</span>&nbsp;<span class="constructor">Nonstd</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** A String module with more capabilities *)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">String</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Sosa</span>.<span class="constructor">Native_string</span><br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;(//)&nbsp;=&nbsp;<span class="constructor">Filename</span>.concat<br>
</code><table><tr><td></td><td><span class="comment">(** <code class="code">path // filename</code> will concat <code class="code">filename</code> to the end of <code class="code">path</code>. *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;debug_mode&nbsp;=&nbsp;<br>
&nbsp;&nbsp;ref&nbsp;(<span class="keyword">try</span>&nbsp;<span class="constructor">Sys</span>.getenv&nbsp;<span class="string">"BIOKEPI_DEBUG"</span>&nbsp;=&nbsp;<span class="string">"true"</span>&nbsp;<span class="keyword">with</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>)<br>
<span class="keyword">let</span>&nbsp;dbg&nbsp;fmt&nbsp;=&nbsp;ksprintf&nbsp;(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;!debug_mode<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;eprintf&nbsp;<span class="string">"biokepi-debug:&nbsp;%s\n%!"</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;()<br>
&nbsp;&nbsp;)&nbsp;fmt<br>
</code><table><tr><td></td><td><span class="comment">(** A consistent debugging mechanism. *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;failwithf&nbsp;fmt&nbsp;=&nbsp;ksprintf&nbsp;failwith&nbsp;fmt<br>
</code><table><tr><td></td><td><span class="comment">(** A formatted <code class="code">failwith</code>. *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Unique_id</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Ketrew_pure</span>.<span class="constructor">Internal_pervasives</span>.<span class="constructor">Unique_id</span><br>
<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(**
<p>

   This is an experimental extension of Ketrew's EDSL. If we're happy
   with it we'll push it upstream.
<p>

   The idea is carry around a type parameter to have arbitrary products.
<p>

*)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Ketrew</span>.<span class="constructor">EDSL</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Command</span>&nbsp;=&nbsp;<span class="constructor">Ketrew_pure</span>.<span class="constructor">Target</span>.<span class="constructor">Command</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;nothing&nbsp;=&nbsp;&lt;&nbsp;is_done&nbsp;:&nbsp;<span class="constructor">Condition</span>.t&nbsp;option&nbsp;&gt;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;nothing&nbsp;&nbsp;=&nbsp;<span class="keyword">object</span>&nbsp;<span class="keyword">method</span>&nbsp;is_done&nbsp;=&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target&nbsp;_&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Please_KEDSL_workflow</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;file_target&nbsp;_&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Please_KEDSL_workflow</span><br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;file_workflow&nbsp;=&nbsp;single_file&nbsp;workflow_node<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;phony_workflow&nbsp;=&nbsp;nothing&nbsp;workflow_node<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;fastq_reads&nbsp;=&nbsp;&lt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_done:&nbsp;<span class="constructor">Ketrew_pure</span>.<span class="constructor">Target</span>.<span class="constructor">Condition</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;paths&nbsp;:&nbsp;string&nbsp;*&nbsp;(string&nbsp;option);<br>
&nbsp;&nbsp;&nbsp;&nbsp;r1&nbsp;:&nbsp;single_file&nbsp;workflow_node;<br>
&nbsp;&nbsp;&nbsp;&nbsp;r2&nbsp;:&nbsp;single_file&nbsp;workflow_node&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sample_name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;escaped_sample_name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fragment_id:&nbsp;string&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fragment_id_forced:&nbsp;string;<br>
&nbsp;&nbsp;&gt;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_reads&nbsp;?host&nbsp;?name&nbsp;?fragment_id&nbsp;r1&nbsp;r2_opt&nbsp;:&nbsp;fastq_reads&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">object</span>&nbsp;(self)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;r1_file&nbsp;=&nbsp;single_file&nbsp;?host&nbsp;r1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;r2_file_opt&nbsp;=&nbsp;<span class="constructor">Option</span>.map&nbsp;r2_opt&nbsp;~f:(single_file&nbsp;?host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;r1&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;r1_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"File:&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1_file<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;r2&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.map&nbsp;r2_file_opt&nbsp;~f:(<span class="keyword">fun</span>&nbsp;r2_file&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;r2_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"File:&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r2_file<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;paths&nbsp;=&nbsp;(r1,&nbsp;r2_opt)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_done&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keyword">match</span>&nbsp;r2_file_opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;r2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">And</span>&nbsp;[r1_file<span class="keywordsign">#</span>exists;&nbsp;r2<span class="keywordsign">#</span>exists]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">And</span>&nbsp;[r1_file<span class="keywordsign">#</span>exists;&nbsp;r1_file<span class="keywordsign">#</span>exists;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;sample_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value&nbsp;name&nbsp;~default:(<span class="constructor">Filename</span>.basename&nbsp;r1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;fragment_id&nbsp;=&nbsp;fragment_id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;fragment_id_forced&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value&nbsp;fragment_id&nbsp;~default:(<span class="constructor">Filename</span>.basename&nbsp;r1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;escaped_sample_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.map&nbsp;self<span class="keywordsign">#</span>sample_name&nbsp;~f:(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'0'</span>&nbsp;..&nbsp;<span class="string">'9'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'a'</span>&nbsp;..&nbsp;<span class="string">'z'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'A'</span>&nbsp;..&nbsp;<span class="string">'Z'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'-'</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">'_'</span>&nbsp;<span class="keyword">as</span>&nbsp;c&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;c<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">'_'</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** Create a <code class="code">fastq_reads workflow_node</code> from one or two
      <code class="code">single_file workflow_node</code>(s).
  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_node_of_single_file_nodes<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~name&nbsp;?fragment_id&nbsp;fastq_r1&nbsp;fastq_r2&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=&nbsp;<span class="constructor">Option</span>.map&nbsp;fastq_r2&nbsp;~f:(<span class="keyword">fun</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;r<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_reads&nbsp;~host&nbsp;~name&nbsp;?fragment_id&nbsp;fastq_r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fastq_r2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;r2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[depends_on&nbsp;fastq_r1;&nbsp;depends_on&nbsp;r2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[depends_on&nbsp;fastq_r1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;product<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~equivalence:<span class="keywordsign">`</span><span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"Assembled-fastq:&nbsp;%s&nbsp;(%s)"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;(<span class="constructor">Option</span>.value&nbsp;fragment_id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~default:(<span class="constructor">Filename</span>.basename&nbsp;fastq_r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;bam_file&nbsp;=&nbsp;&lt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_done:&nbsp;<span class="constructor">Ketrew_pure</span>.<span class="constructor">Target</span>.<span class="constructor">Condition</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;host:&nbsp;<span class="constructor">Host</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sorting:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;]&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;string;<br>
&nbsp;&nbsp;&gt;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_file&nbsp;~host&nbsp;?sorting&nbsp;~reference_build&nbsp;path&nbsp;:&nbsp;bam_file&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;file&nbsp;=&nbsp;single_file&nbsp;~host&nbsp;path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;host&nbsp;=&nbsp;host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;=&nbsp;file<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_done&nbsp;=&nbsp;file<span class="keywordsign">#</span>is_done<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;sorting&nbsp;=&nbsp;sorting<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;reference_build&nbsp;=&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** Make a new bam sharing most of the metadata. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;transform_bam&nbsp;?change_sorting&nbsp;(bam&nbsp;:&nbsp;bam_file)&nbsp;~path&nbsp;:&nbsp;bam_file&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;bam_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host:bam<span class="keywordsign">#</span>host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?sorting:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;change_sorting&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;new_sorting&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;new_sorting<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam<span class="keywordsign">#</span>sorting<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build:bam<span class="keywordsign">#</span>reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;bam_list&nbsp;=&nbsp;&lt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;is_done:&nbsp;&nbsp;<span class="constructor">Ketrew_pure</span>.<span class="constructor">Target</span>.<span class="constructor">Condition</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;bams:&nbsp;bam_file&nbsp;list;<br>
&nbsp;&nbsp;&gt;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_list&nbsp;(bams&nbsp;:&nbsp;bam_file&nbsp;list)&nbsp;:&nbsp;bam_list&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">object</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;bams&nbsp;=&nbsp;bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_done&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">And</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b<span class="keywordsign">#</span>is_done<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg:<span class="string">"Bams&nbsp;should&nbsp;have&nbsp;a&nbsp;Condition.t"</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;explode_bam_list_node&nbsp;(bln&nbsp;:&nbsp;bam_list&nbsp;workflow_node)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;bln<span class="keywordsign">#</span>product<span class="keywordsign">#</span>bams&nbsp;~f:(<span class="keyword">fun</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(<span class="constructor">Filename</span>.basename&nbsp;bam<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="string">"expolode_bam_list_node"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[depends_on&nbsp;bln]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~equivalence:<span class="keywordsign">`</span><span class="constructor">None</span>)<br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;this&nbsp;may&nbsp;be&nbsp;overkill:&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;_&nbsp;bam_or_bams&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_bam</span>:&nbsp;bam_file&nbsp;workflow_node&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam_file&nbsp;workflow_node&nbsp;bam_or_bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_workflow_list</span>:&nbsp;bam_file&nbsp;workflow_node&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam_list&nbsp;workflow_node&nbsp;bam_or_bams<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;submit&nbsp;w&nbsp;=&nbsp;<span class="constructor">Ketrew</span>.<span class="constructor">Client</span>.submit_workflow&nbsp;w<br>
<br>
<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** and then we forbid any other access to Ketrew, to force everything
    to throught the above module. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Ketrew</span>&nbsp;=&nbsp;<span class="keyword">struct</span>&nbsp;<span class="keyword">end</span><br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** An attempt at standardizing “tags.” *)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Target_tags</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aligner&nbsp;=&nbsp;<span class="string">"aligner"</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;variant_caller&nbsp;=&nbsp;<span class="string">"variant-caller"</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;clean_up&nbsp;=&nbsp;<span class="string">"clean-up"</span><br>
<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Machine</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Tool</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Definition</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{name:&nbsp;string;&nbsp;version:&nbsp;string&nbsp;option}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create&nbsp;?version&nbsp;name&nbsp;&nbsp;=&nbsp;{name;&nbsp;version}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_opam_name&nbsp;{name;&nbsp;version}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;name&nbsp;(<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">"NOVERSION"</span>&nbsp;version)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_string&nbsp;=&nbsp;to_opam_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_directory_name&nbsp;=&nbsp;to_opam_name<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Default</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Definition</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa&nbsp;=&nbsp;create&nbsp;<span class="string">"bwa"</span>&nbsp;~version:<span class="string">"0.7.10"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;create&nbsp;<span class="string">"samtools"</span>&nbsp;~version:<span class="string">"1.3"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcftools&nbsp;=&nbsp;create&nbsp;<span class="string">"vcftools"</span>&nbsp;~version:<span class="string">"0.1.12b"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bedtools&nbsp;=&nbsp;create&nbsp;<span class="string">"bedtools"</span>&nbsp;~version:<span class="string">"2.23.0"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somaticsniper&nbsp;=&nbsp;create&nbsp;<span class="string">"somaticsniper"</span>&nbsp;~version:<span class="string">"1.0.3"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan&nbsp;=&nbsp;create&nbsp;<span class="string">"varscan"</span>&nbsp;~version:<span class="string">"2.3.5"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard&nbsp;=&nbsp;create&nbsp;<span class="string">"picard"</span>&nbsp;~version:<span class="string">"1.127"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect&nbsp;=&nbsp;create&nbsp;<span class="string">"mutect"</span>&nbsp;<span class="comment">(*&nbsp;We&nbsp;don't&nbsp;know&nbsp;the&nbsp;versions&nbsp;of&nbsp;the&nbsp;users'&nbsp;GATKs&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk&nbsp;=&nbsp;create&nbsp;<span class="string">"gatk"</span>&nbsp;<span class="comment">(*&nbsp;idem,&nbsp;because&nbsp;of&nbsp;their&nbsp;non-open-source&nbsp;licenses&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;strelka&nbsp;=&nbsp;create&nbsp;<span class="string">"strelka"</span>&nbsp;~version:<span class="string">"1.0.14"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid&nbsp;=&nbsp;create&nbsp;<span class="string">"virmid"</span>&nbsp;~version:<span class="string">"1.1.1"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse&nbsp;=&nbsp;create&nbsp;<span class="string">"muse"</span>&nbsp;~version:<span class="string">"1.0b"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star&nbsp;=&nbsp;create&nbsp;<span class="string">"star"</span>&nbsp;~version:<span class="string">"2.4.1d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stringtie&nbsp;=&nbsp;create&nbsp;<span class="string">"stringtie"</span>&nbsp;~version:<span class="string">"1.2.2"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cufflinks&nbsp;=&nbsp;create&nbsp;<span class="string">"cufflinks"</span>&nbsp;~version:<span class="string">"2.2.1"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat&nbsp;=&nbsp;create&nbsp;<span class="string">"hisat"</span>&nbsp;~version:<span class="string">"0.1.6-beta"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat2&nbsp;=&nbsp;create&nbsp;<span class="string">"hisat"</span>&nbsp;~version:<span class="string">"2.0.2-beta"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik&nbsp;=&nbsp;create&nbsp;<span class="string">"mosaik"</span>&nbsp;~version:<span class="string">"2.2.3"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kallisto&nbsp;=&nbsp;create&nbsp;<span class="string">"kallisto"</span>&nbsp;~version:<span class="string">"0.42.3"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bowtie&nbsp;=&nbsp;create&nbsp;<span class="string">"bowtie"</span>&nbsp;~version:<span class="string">"1.1.2"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;optitype&nbsp;=&nbsp;create&nbsp;<span class="string">"optitype"</span>&nbsp;~version:<span class="string">"1.0.0"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;seq2hla&nbsp;=&nbsp;create&nbsp;<span class="string">"seq2hla"</span>&nbsp;~version:<span class="string">"2.2"</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;definition:&nbsp;<span class="constructor">Definition</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;init:&nbsp;<span class="constructor">Program</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ensure:&nbsp;phony_workflow;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create&nbsp;?init&nbsp;?ensure&nbsp;definition&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;definition;<br>
&nbsp;&nbsp;&nbsp;&nbsp;init&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value&nbsp;init<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~default:(<span class="constructor">Program</span>.shf&nbsp;<span class="string">"echo&nbsp;'Tool&nbsp;%s:&nbsp;default&nbsp;init'"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Definition</span>.to_string&nbsp;definition));<br>
&nbsp;&nbsp;&nbsp;&nbsp;ensure&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ensure<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:<span class="constructor">KEDSL</span>.forget_product<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~default:(workflow_node&nbsp;nothing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"%s-ensured"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Definition</span>.to_string&nbsp;definition)));<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;init&nbsp;t&nbsp;=&nbsp;t.init<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ensure&nbsp;t&nbsp;=&nbsp;t.ensure<br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Kit</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;tool&nbsp;=&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Definition</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;tool&nbsp;option<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;:&nbsp;t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;def&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find_map&nbsp;l&nbsp;~f:(<span class="keyword">fun</span>&nbsp;kit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;kit&nbsp;def)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;of_list&nbsp;l&nbsp;:&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;def&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find&nbsp;l&nbsp;~f:(<span class="keyword">fun</span>&nbsp;{definition;&nbsp;_}&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;definition&nbsp;=&nbsp;def)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_exn&nbsp;t&nbsp;tool&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t&nbsp;tool&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Toolkit&nbsp;cannot&nbsp;provide&nbsp;the&nbsp;tool&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Definition</span>.to_string&nbsp;tool)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Jobs in Biokepi ask the computing environment (defined below in
    <code class="code"><span class="constructor">Machine</span></code>) for resources.
<p>

    The implementation of the <code class="code"><span class="constructor">Make_fun</span>.t</code> function defined by the user
    is free to interpret those requirements according to the user's
    computing infrastructure.
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Make_fun</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Requirement</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Processors</span>&nbsp;<span class="keyword">of</span>&nbsp;int&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** A number of cores on a shared-memory setting. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Internet_access</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Able to access public HTTP(S) or FTP URLs. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Memory</span>&nbsp;<span class="keyword">of</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">GB</span>&nbsp;<span class="keyword">of</span>&nbsp;float&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Ask for a specific amount of memory. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Small</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Tell that the program does not expect HPC-like memory
                       usage (i.e. not more than 2 GB or your usual laptop). *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Big</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Tell that the program may ask for a lot of memory
                     but you don't know how much precisely. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Quick_run</span>&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Programs that run fast, with little resources.  Usually,
                       you can interpret this as "OK to run on the login node
                       of my cluster." *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Spark</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;list&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Ask for a Spark (on-YARN) environment with
                                  custom parameters (not in use for now,
                                  <code class="code"><span class="string">"#WIP"</span></code>). *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Custom</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Pass arbitrary data (useful for temporary
                              extensions/experiements outside of Biokepi). *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Self_identification</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Set of names or tags for a workflow-node program to identify
            itself to the <code class="code"><span class="constructor">Machine</span>.t</code>.
            This is useful for quickly bypassing incorrect requirements set
            in the library (please also report an issue if you need this).  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;[@@deriving&nbsp;yojson,&nbsp;show]<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;?name:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?requirements:&nbsp;<span class="constructor">Requirement</span>.t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.<span class="constructor">Build_process</span>.t<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** The type of the “run function” used across the library. *)</span></td></tr></table><code class="code"><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** A stream processor, for this purpose, is a program that runs on one core
      and does not grow in memory arbitrarily. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stream_processor&nbsp;requirements&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Processors</span>&nbsp;1&nbsp;::&nbsp;<span class="keywordsign">`</span><span class="constructor">Memory</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Small</span>&nbsp;::&nbsp;requirements<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;quick&nbsp;requirements&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Quick_run</span>&nbsp;::&nbsp;requirements<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;downloading&nbsp;requirements&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Internet_access</span>&nbsp;::&nbsp;stream_processor&nbsp;requirements&nbsp;<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;with_self_ids&nbsp;?self_ids&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;self_ids&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;tags&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Self_identification</span>&nbsp;tags&nbsp;::&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;l<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;with_requirements&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Requirement</span>.t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;?name&nbsp;?(requirements&nbsp;=&nbsp;[])&nbsp;prog&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;?name&nbsp;~requirements:(l&nbsp;@&nbsp;requirements)&nbsp;prog<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;host:&nbsp;<span class="constructor">Host</span>.t;<br>
&nbsp;&nbsp;get_reference_genome:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Reference_genome</span>.t;<br>
&nbsp;&nbsp;toolkit:&nbsp;<span class="constructor">Tool</span>.<span class="constructor">Kit</span>.t;<br>
&nbsp;&nbsp;run_program:&nbsp;<span class="constructor">Make_fun</span>.t;<br>
&nbsp;&nbsp;work_dir:&nbsp;string;<br>
&nbsp;&nbsp;max_processors:&nbsp;int;<br>
}<br>
<span class="keyword">let</span>&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~get_reference_genome&nbsp;~toolkit<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_program&nbsp;~work_dir&nbsp;~max_processors&nbsp;&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;{name;&nbsp;toolkit;&nbsp;get_reference_genome;&nbsp;host;<br>
&nbsp;&nbsp;&nbsp;run_program;&nbsp;work_dir;&nbsp;max_processors}<br>
<br>
<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
<span class="keyword">let</span>&nbsp;as_host&nbsp;t&nbsp;=&nbsp;t.host<br>
<span class="keyword">let</span>&nbsp;get_reference_genome&nbsp;t&nbsp;=&nbsp;t.get_reference_genome<br>
<span class="keyword">let</span>&nbsp;get_tool&nbsp;t&nbsp;tool&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.toolkit&nbsp;tool&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;s<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Machine&nbsp;%S&nbsp;cannot&nbsp;provide&nbsp;the&nbsp;tool&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.name&nbsp;(<span class="constructor">Tool</span>.<span class="constructor">Definition</span>.to_string&nbsp;tool)<br>
<br>
<span class="keyword">let</span>&nbsp;run_program&nbsp;t&nbsp;=&nbsp;t.run_program<br>
<br>
<span class="keyword">let</span>&nbsp;max_processors&nbsp;t&nbsp;=&nbsp;t.max_processors<br>
</code><table><tr><td></td><td><span class="comment">(** Get the maximum number of processors that a single job can use in the
    <code class="code"><span class="constructor">Machine</span>.t</code> (i.e. usually the “number-of-threads” paramters of most tools)
*)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;quick_run_program&nbsp;t&nbsp;:&nbsp;<span class="constructor">Make_fun</span>.t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Make_fun</span>.with_requirements&nbsp;t.run_program&nbsp;(<span class="constructor">Make_fun</span>.quick&nbsp;[])<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Run a program that does not use much memory and runs on one core. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;run_stream_processor&nbsp;?self_ids&nbsp;t&nbsp;:&nbsp;<span class="constructor">Make_fun</span>.t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Make_fun</span>.with_requirements&nbsp;t.run_program<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Make_fun</span>.stream_processor&nbsp;[]&nbsp;|&gt;&nbsp;<span class="constructor">Make_fun</span>.with_self_ids&nbsp;?self_ids)<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Run a program that does not use much memory, runs on one core, and needs
    the internet. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;run_download_program&nbsp;t&nbsp;:&nbsp;<span class="constructor">Make_fun</span>.t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Make_fun</span>.with_requirements&nbsp;t.run_program&nbsp;(<span class="constructor">Make_fun</span>.downloading&nbsp;[])<br>
<br>
<span class="keyword">let</span>&nbsp;run_big_program&nbsp;t&nbsp;:<br>
&nbsp;&nbsp;?processors:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;?self_ids&nbsp;:&nbsp;string&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Make_fun</span>.t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;?(processors&nbsp;=&nbsp;1)&nbsp;?self_ids&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Make_fun</span>.with_requirements<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.run_program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Make_fun</span>.with_self_ids&nbsp;?self_ids&nbsp;[<span class="keywordsign">`</span><span class="constructor">Memory</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Big</span>;&nbsp;<span class="keywordsign">`</span><span class="constructor">Processors</span>&nbsp;processors])<br>
<br>
<span class="keyword">let</span>&nbsp;work_dir&nbsp;t&nbsp;=&nbsp;t.work_dir<br>
<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Metadata</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(** Metadata generated at compile-time *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;version&nbsp;=&nbsp;<span class="keyword">lazy</span>&nbsp;<span class="string">"0.0.0+master"</span><br>
<span class="keyword">let</span>&nbsp;git_commit&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;<span class="string">"99877df6dfa2fe64cd2071aa691bda7bbf4f0de7"</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Reference_genome</span>&nbsp;<br>
:&nbsp;<span class="keyword">sig</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Representation of Reference Genomes *)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">type</span>&nbsp;name&nbsp;=&nbsp;string<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Specification</span>&nbsp;:&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Location</span>&nbsp;:&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Url</span>&nbsp;<span class="keyword">of</span>&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf_concat</span>&nbsp;<span class="keyword">of</span>&nbsp;(string&nbsp;*&nbsp;t)&nbsp;list&nbsp;<span class="comment">(*&nbsp;name&nbsp;×&nbsp;location&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Concat</span>&nbsp;<span class="keyword">of</span>&nbsp;t&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Gunzip</span>&nbsp;<span class="keyword">of</span>&nbsp;t&nbsp;<span class="comment">(*&nbsp;Should&nbsp;this&nbsp;be&nbsp;guessed&nbsp;from&nbsp;the&nbsp;URL&nbsp;extension?&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Untar</span>&nbsp;<span class="keyword">of</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;url&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&gt;&nbsp;<span class="keywordsign">`</span><span class="constructor">Url</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;vcf_concat&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&gt;&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf_concat</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;concat&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&gt;&nbsp;<span class="keywordsign">`</span><span class="constructor">Concat</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;gunzip&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&gt;&nbsp;<span class="keywordsign">`</span><span class="constructor">Gunzip</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;untar&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&gt;&nbsp;<span class="keywordsign">`</span><span class="constructor">Untar</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="keyword">private</span>&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;:&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;metadata&nbsp;:&nbsp;string&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fasta&nbsp;:&nbsp;<span class="constructor">Location</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;dbsnp&nbsp;:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cosmic&nbsp;:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;exome_gtf&nbsp;:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cdna&nbsp;:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;major_contigs&nbsp;:&nbsp;string&nbsp;list&nbsp;option;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;create&nbsp;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?metadata:string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;fasta:<span class="constructor">Location</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?dbsnp:<span class="constructor">Location</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?cosmic:<span class="constructor">Location</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?exome_gtf:<span class="constructor">Location</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?cdna:<span class="constructor">Location</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?major_contigs:string&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Default</span>&nbsp;:<br>
&nbsp;&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Name</span>&nbsp;:&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** The “names” of the default genomes; the values are provided to
          simplify code and make it less typo-error-prone but the string can be
          ipused directly (e.g. <code class="code">b37</code> is just <code class="code"><span class="string">"b37"</span></code>). *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;b37&nbsp;:&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;b37decoy&nbsp;:&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;b38&nbsp;:&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;hg18&nbsp;:&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;hg19&nbsp;:&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;mm10&nbsp;:&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;b37&nbsp;:&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;b37decoy&nbsp;:&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;b38&nbsp;:&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;hg18&nbsp;:&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;hg19&nbsp;:&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;mm10&nbsp;:&nbsp;t<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="keyword">private</span>&nbsp;{<br>
&nbsp;&nbsp;specification:&nbsp;<span class="constructor">Specification</span>.t;<br>
&nbsp;&nbsp;location&nbsp;:&nbsp;<span class="constructor">KEDSL</span>.file_workflow;<br>
&nbsp;&nbsp;cosmic&nbsp;:&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
&nbsp;&nbsp;dbsnp&nbsp;:&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
&nbsp;&nbsp;gtf&nbsp;:&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
&nbsp;&nbsp;cdna&nbsp;:&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
}<br>
</code><table><tr><td></td><td><span class="comment">(** A reference genome has a name (for display/matching) and a
     cluster-dependent path.
     Corresponding Cosmic and dbSNP databases (VCFs) can be added to the mix.
*)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="keyword">val</span>&nbsp;create&nbsp;:<br>
&nbsp;&nbsp;?cosmic:<span class="constructor">KEDSL</span>.file_workflow&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;?dbsnp:<span class="constructor">KEDSL</span>.file_workflow&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;?gtf:<span class="constructor">KEDSL</span>.file_workflow&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;?cdna:<span class="constructor">KEDSL</span>.file_workflow&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;<span class="constructor">Specification</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
</code><table><tr><td></td><td><span class="comment">(** Build a <code class="code"><span class="constructor">Reference_genome</span>.t</code> record. *)</span></td></tr></table><code class="code"><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <h5 id="5_UsualAccessors">Usual Accessors </h5> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">val</span>&nbsp;name&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;name<br>
<span class="keyword">val</span>&nbsp;path&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
<span class="keyword">val</span>&nbsp;cosmic_path_exn&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
<span class="keyword">val</span>&nbsp;dbsnp_path_exn&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
<span class="keyword">val</span>&nbsp;gtf_path_exn&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
<span class="keyword">val</span>&nbsp;cdna_path_exn&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string<br>
<br>
<span class="keyword">val</span>&nbsp;major_contigs&nbsp;:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Region</span>.t&nbsp;list<br>
</code><table><tr><td></td><td><span class="comment">(** <h5 id="5_Targets">Targets</h5> *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">val</span>&nbsp;fasta:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
<span class="keyword">val</span>&nbsp;cosmic_exn:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
<span class="keyword">val</span>&nbsp;dbsnp_exn:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
<span class="keyword">val</span>&nbsp;gtf_exn:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
<span class="keyword">val</span>&nbsp;gtf:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option<br>
<span class="keyword">val</span>&nbsp;cdna_exn:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
<span class="keyword">end</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">type</span>&nbsp;name&nbsp;=&nbsp;string<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Specification</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Location</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Url</span>&nbsp;<span class="keyword">of</span>&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf_concat</span>&nbsp;<span class="keyword">of</span>&nbsp;(string&nbsp;*&nbsp;t)&nbsp;list&nbsp;<span class="comment">(*&nbsp;name&nbsp;×&nbsp;location&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Concat</span>&nbsp;<span class="keyword">of</span>&nbsp;t&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Gunzip</span>&nbsp;<span class="keyword">of</span>&nbsp;t&nbsp;<span class="comment">(*&nbsp;Should&nbsp;this&nbsp;be&nbsp;guessed&nbsp;from&nbsp;the&nbsp;URL&nbsp;extension?&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Untar</span>&nbsp;<span class="keyword">of</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;url&nbsp;u&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Url</span>&nbsp;u<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcf_concat&nbsp;l&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf_concat</span>&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;l&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Concat</span>&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip&nbsp;l&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Gunzip</span>&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;untar&nbsp;l&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Untar</span>&nbsp;l<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;metadata:&nbsp;string&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fasta:&nbsp;<span class="constructor">Location</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;dbsnp:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cosmic:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;exome_gtf:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;&nbsp;<span class="comment">(*&nbsp;maybe&nbsp;desrves&nbsp;a&nbsp;better&nbsp;name?&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;cdna:&nbsp;<span class="constructor">Location</span>.t&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;major_contigs:&nbsp;string&nbsp;list&nbsp;option;<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?metadata<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fasta<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?dbsnp<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?cosmic<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?exome_gtf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?cdna<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?major_contigs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;metadata;<br>
&nbsp;&nbsp;&nbsp;&nbsp;fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;dbsnp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cosmic;<br>
&nbsp;&nbsp;&nbsp;&nbsp;exome_gtf;<br>
&nbsp;&nbsp;&nbsp;&nbsp;cdna;<br>
&nbsp;&nbsp;&nbsp;&nbsp;major_contigs;<br>
&nbsp;&nbsp;}<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Default</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;major_contigs_b37&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.init&nbsp;22&nbsp;(<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%d"</span>&nbsp;(i&nbsp;+&nbsp;1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<span class="string">"X"</span>;&nbsp;<span class="string">"Y"</span>;&nbsp;<span class="string">"MT"</span>;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;major_contigs_hg_family&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.init&nbsp;22&nbsp;(<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"chr%d"</span>&nbsp;(i&nbsp;+&nbsp;1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"chrX"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"chrY"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"chrM"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;major_contigs_mm10&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.init&nbsp;19&nbsp;(<span class="keyword">fun</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%d"</span>&nbsp;(i&nbsp;+&nbsp;1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[&nbsp;<span class="string">"X"</span>;&nbsp;<span class="string">"Y"</span>&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Name</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37&nbsp;=&nbsp;<span class="string">"b37"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37decoy&nbsp;=&nbsp;<span class="string">"b37decoy"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b38&nbsp;=&nbsp;<span class="string">"b38"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hg18&nbsp;=&nbsp;<span class="string">"hg18"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hg19&nbsp;=&nbsp;<span class="string">"hg19"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mm10&nbsp;=&nbsp;<span class="string">"mm10"</span><br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Used&nbsp;by&nbsp;both&nbsp;B37&nbsp;and&nbsp;B37decoy&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37_dbsnp_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/2.8/b37/dbsnp_138.b37.vcf.gz"</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37_cosmic_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"http://www.broadinstitute.org/cancer/cga/sites/default/files/data/tools/mutect/b37_cosmic_v54_120711.vcf"</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37_exome_gtf_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"http://ftp.ensembl.org/pub/release-75/gtf/homo_sapiens/Homo_sapiens.GRCh37.75.gtf.gz"</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37_cdna_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"http://ftp.ensembl.org/pub/release-75/fasta/homo_sapiens/cdna/Homo_sapiens.GRCh37.75.cdna.all.fa.gz"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;<span class="constructor">Name</span>.b37<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~metadata:<span class="string">"Provided&nbsp;by&nbsp;the&nbsp;Biokepi&nbsp;library"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~major_contigs:major_contigs_b37<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fasta:<span class="constructor">Location</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;<span class="string">"ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/2.8/b37/human_g1k_v37.fasta.gz"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~dbsnp:<span class="constructor">Location</span>.(url&nbsp;b37_dbsnp_url&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Alternate?<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ftp://ftp.ncbi.nlm.nih.gov/snp/organisms/human_9606/VCF/v4.0/00-All.vcf.gz"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~cosmic:<span class="constructor">Location</span>.(url&nbsp;b37_cosmic_url)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~exome_gtf:<span class="constructor">Location</span>.(url&nbsp;b37_exome_gtf_url&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~cdna:<span class="constructor">Location</span>.(url&nbsp;b37_cdna_url&nbsp;|&gt;&nbsp;gunzip)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b37decoy&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;<span class="constructor">Name</span>.b37decoy<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~metadata:<span class="string">"Provided&nbsp;by&nbsp;the&nbsp;Biokepi&nbsp;library"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~major_contigs:major_contigs_b37<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fasta:<span class="constructor">Location</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/technical/reference/phase2_reference_assembly_sequence/hs37d5.fa.gz"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~dbsnp:<span class="constructor">Location</span>.(url&nbsp;b37_dbsnp_url&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~exome_gtf:<span class="constructor">Location</span>.(url&nbsp;b37_exome_gtf_url&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~cosmic:<span class="constructor">Location</span>.(url&nbsp;b37_cosmic_url)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~cdna:<span class="constructor">Location</span>.(url&nbsp;b37_cdna_url&nbsp;|&gt;&nbsp;gunzip)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b38&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Release&nbsp;79&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;b38_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://ftp.ensembl.org/pub/release-79/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna.primary_assembly.fa.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp_b38&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"http://ftp.ncbi.nlm.nih.gov/snp/organisms/human_9606_b142_GRCh38/VCF/00-All.vcf.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gtf_b38_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"http://ftp.ensembl.org/pub/release-79/gtf/homo_sapiens/Homo_sapiens.GRCh38.79.gtf.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cdna_b38_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"http://ftp.ensembl.org/pub/release-79/fasta/homo_sapiens/cdna/Homo_sapiens.GRCh38.cdna.all.fa.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;<span class="constructor">Name</span>.b38<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~metadata:<span class="string">"Provided&nbsp;by&nbsp;the&nbsp;Biokepi&nbsp;library"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~major_contigs:major_contigs_b37<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fasta:<span class="constructor">Location</span>.(url&nbsp;b38_url|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~dbsnp:<span class="constructor">Location</span>.(url&nbsp;dbsnp_b38&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~exome_gtf:<span class="constructor">Location</span>.(url&nbsp;gtf_b38_url&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~cdna:<span class="constructor">Location</span>.(url&nbsp;cdna_b38_url&nbsp;|&gt;&nbsp;gunzip)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hg18&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hg18_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/2.8/hg18/Homo_sapiens_assembly18.fasta.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp_hg18_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/2.8/hg18/dbsnp_138.hg18.vcf.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;<span class="constructor">Name</span>.hg18<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~metadata:<span class="string">"Provided&nbsp;by&nbsp;the&nbsp;Biokepi&nbsp;library"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~major_contigs:major_contigs_hg_family<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fasta:<span class="constructor">Location</span>.(url&nbsp;hg18_url|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~dbsnp:<span class="constructor">Location</span>.(url&nbsp;dbsnp_hg18_url&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hg19&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hg19_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/2.8/hg19/ucsc.hg19.fasta.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp_hg19_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://gsapubftp-anonymous@ftp.broadinstitute.org/bundle/2.8/hg19/dbsnp_138.hg19.vcf.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;<span class="constructor">Name</span>.hg19<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~metadata:<span class="string">"Provided&nbsp;by&nbsp;the&nbsp;Biokepi&nbsp;library"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~major_contigs:major_contigs_hg_family<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fasta:<span class="constructor">Location</span>.(url&nbsp;hg19_url|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~dbsnp:<span class="constructor">Location</span>.(url&nbsp;dbsnp_hg19_url&nbsp;|&gt;&nbsp;gunzip)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mm10&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mm10_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://ftp.ensembl.org/pub/release-84/fasta/mus_musculus/dna/Mus_musculus.GRCm38.dna_sm.primary_assembly.fa.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp_mm10_snps_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://ftp-mouse.sanger.ac.uk/REL-1303-SNPs_Indels-GRCm38/mgp.v3.snps.rsIDdbSNPv137.vcf.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp_mm10_indels_url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://ftp-mouse.sanger.ac.uk/REL-1303-SNPs_Indels-GRCm38/mgp.v3.indels.rsIDdbSNPv137.vcf.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gene_annotations_gtf&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ftp://ftp.ensembl.org/pub/release-79/gtf/mus_musculus/Mus_musculus.GRCm38.79.gtf.gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;<span class="constructor">Name</span>.mm10<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~metadata:<span class="string">"Provided&nbsp;by&nbsp;the&nbsp;Biokepi&nbsp;Library"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~major_contigs:major_contigs_mm10<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fasta:<span class="constructor">Location</span>.(url&nbsp;mm10_url&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~dbsnp:<span class="constructor">Location</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vcf_concat&nbsp;[<span class="string">"db_snps.vcf"</span>,&nbsp;url&nbsp;dbsnp_mm10_snps_url&nbsp;|&gt;&nbsp;gunzip;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"db_indels.vcf"</span>,&nbsp;url&nbsp;dbsnp_mm10_indels_url&nbsp;|&gt;&nbsp;gunzip]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~exome_gtf:<span class="constructor">Location</span>.(url&nbsp;gene_annotations_gtf&nbsp;|&gt;&nbsp;gunzip)<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">end</span><br>
<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** A reference genome has a name (for display/matching) and a
     cluster-dependent path.
     Corresponding Cosmic and dbSNP databases (VCFs) can be added to the mix.
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;specification:&nbsp;<span class="constructor">Specification</span>.t;<br>
&nbsp;&nbsp;location:&nbsp;<span class="constructor">KEDSL</span>.file_workflow;<br>
&nbsp;&nbsp;cosmic:&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
&nbsp;&nbsp;dbsnp:&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
&nbsp;&nbsp;gtf:&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
&nbsp;&nbsp;cdna:&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;option;<br>
}<br>
<br>
<span class="keyword">let</span>&nbsp;create&nbsp;?cosmic&nbsp;?dbsnp&nbsp;?gtf&nbsp;?cdna&nbsp;specification&nbsp;location&nbsp;=<br>
&nbsp;&nbsp;{specification;&nbsp;location;&nbsp;cosmic;&nbsp;dbsnp;&nbsp;gtf;&nbsp;cdna}<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.specification.<span class="constructor">Specification</span>.name<br>
<span class="keyword">let</span>&nbsp;path&nbsp;t&nbsp;=&nbsp;t.location<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
<span class="keyword">let</span>&nbsp;cosmic_path_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"cosmic_path_exn&nbsp;of&nbsp;%s"</span>&nbsp;(name&nbsp;t)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cosmic&nbsp;=&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg&nbsp;t.cosmic&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;cosmic<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
<br>
<span class="keyword">let</span>&nbsp;dbsnp_path_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"dbsnp_path_exn&nbsp;of&nbsp;%s"</span>&nbsp;(name&nbsp;t)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;trgt&nbsp;=&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg&nbsp;t.dbsnp&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;trgt<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
<br>
<span class="keyword">let</span>&nbsp;gtf_path_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"gtf_path_exn&nbsp;of&nbsp;%s"</span>&nbsp;(name&nbsp;t)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;trgt&nbsp;=&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg&nbsp;t.gtf&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;trgt<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
<br>
<span class="keyword">let</span>&nbsp;cdna_path_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;msg&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"cdna_path_exn&nbsp;of&nbsp;%s"</span>&nbsp;(name&nbsp;t)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target&nbsp;=&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg&nbsp;t.cdna&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;target<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
<br>
<span class="keyword">let</span>&nbsp;fasta:&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.file_workflow&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t.location<br>
<span class="keyword">let</span>&nbsp;cosmic_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg:(sprintf&nbsp;<span class="string">"%s:&nbsp;no&nbsp;COSMIC"</span>&nbsp;(name&nbsp;t))&nbsp;t.cosmic<br>
<span class="keyword">let</span>&nbsp;dbsnp_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg:(sprintf&nbsp;<span class="string">"%s:&nbsp;no&nbsp;DBSNP"</span>&nbsp;(name&nbsp;t))&nbsp;t.dbsnp<br>
<span class="keyword">let</span>&nbsp;gtf_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg:(sprintf&nbsp;<span class="string">"%s:&nbsp;no&nbsp;GTF"</span>&nbsp;(name&nbsp;t))&nbsp;t.gtf<br>
<span class="keyword">let</span>&nbsp;gtf&nbsp;t&nbsp;=&nbsp;t.gtf<br>
<span class="keyword">let</span>&nbsp;cdna_exn&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg:(sprintf&nbsp;<span class="string">"%s:&nbsp;no&nbsp;cDNA&nbsp;fasta&nbsp;file"</span>&nbsp;(name&nbsp;t))&nbsp;t.cdna<br>
<br>
<span class="keyword">let</span>&nbsp;major_contigs&nbsp;t&nbsp;:&nbsp;<span class="constructor">Region</span>.t&nbsp;list&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.specification.<span class="constructor">Specification</span>.major_contigs&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Reference&nbsp;%S&nbsp;does&nbsp;have&nbsp;major-contigs/chromosomes&nbsp;defined"</span>&nbsp;(name&nbsp;t)<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">List</span>.map&nbsp;l&nbsp;~f:(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome</span>&nbsp;s)<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Region</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Positions are 1-based *)</span></td></tr></table><code class="code"><br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome</span>&nbsp;<span class="keyword">of</span>&nbsp;string<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome_interval</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;int&nbsp;*&nbsp;int<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Full</span><br>
]<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Make a filename-compliant string out of a region specification. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;to_filename&nbsp;=&nbsp;<span class="keyword">function</span><br>
<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Full</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Full"</span><br>
<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s"</span>&nbsp;s<br>
<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome_interval</span>&nbsp;(s,&nbsp;b,&nbsp;e)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s_%d-%d"</span>&nbsp;s&nbsp;b&nbsp;e<br>
<br>
<span class="keyword">let</span>&nbsp;to_samtools_specification&nbsp;=&nbsp;<span class="keyword">function</span><br>
<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Full</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;s<br>
<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome_interval</span>&nbsp;(s,&nbsp;b,&nbsp;e)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;(sprintf&nbsp;<span class="string">"%s:%d-%d"</span>&nbsp;s&nbsp;b&nbsp;e)<br>
<br>
<span class="keyword">let</span>&nbsp;to_samtools_option&nbsp;r&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;to_samtools_specification&nbsp;r&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"-r&nbsp;%s"</span>&nbsp;s<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
<br>
<span class="keyword">let</span>&nbsp;to_gatk_option&nbsp;r&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;to_samtools_specification&nbsp;r&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"--intervals&nbsp;%s"</span>&nbsp;s<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
<br>
<span class="keyword">let</span>&nbsp;parse_samtools&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">':'</span>)&nbsp;s&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[one]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome</span>&nbsp;one<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[one;&nbsp;two]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">String</span>.split&nbsp;~on:(<span class="keywordsign">`</span><span class="constructor">Character</span>&nbsp;<span class="string">'-'</span>)&nbsp;two&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[left;&nbsp;right]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Int</span>.of_string&nbsp;left,&nbsp;<span class="constructor">Int</span>.of_string&nbsp;right&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;b,&nbsp;<span class="constructor">Some</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Chromosome_interval</span>&nbsp;(one,&nbsp;b,&nbsp;e)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwithf&nbsp;<span class="string">"Cannot&nbsp;parse&nbsp;%S&nbsp;into&nbsp;2&nbsp;loci"</span>&nbsp;two<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwithf&nbsp;<span class="string">"Not&nbsp;one&nbsp;'-'&nbsp;in&nbsp;%S"</span>&nbsp;two<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwithf&nbsp;<span class="string">"Not&nbsp;one&nbsp;or&nbsp;zero&nbsp;':'&nbsp;in&nbsp;%S"</span>&nbsp;s<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;cmdliner_term&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Cmdliner</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Term</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;pure&nbsp;(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Full</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;parse_samtools&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;$&nbsp;<span class="constructor">Arg</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value&nbsp;<span class="keywordsign">&amp;</span>&nbsp;opt&nbsp;(some&nbsp;string)&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;</span>&nbsp;info&nbsp;[<span class="string">"R"</span>;&nbsp;<span class="string">"region"</span>]&nbsp;~docv:<span class="string">"REGION"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~doc:<span class="string">"Specify&nbsp;a&nbsp;region;&nbsp;using&nbsp;samtools'&nbsp;format"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;)<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Tool_parameters</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;parameters:&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list;<br>
}<br>
<br>
<span class="keyword">let</span>&nbsp;to_json&nbsp;t:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{name;&nbsp;parameters}&nbsp;=&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"parameters"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;b));<br>
&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;render&nbsp;{parameters;&nbsp;_}&nbsp;=<br>
&nbsp;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[a;&nbsp;b])<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Workflow_utilities</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(** Small/useful workflow-nodes. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;file&nbsp;~run_with&nbsp;path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;nothing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"rm-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~done_when:(<span class="keywordsign">`</span><span class="constructor">Is_verified</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Command_returns</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Command</span>.shell&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"ls&nbsp;%s"</span>&nbsp;path),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.quick_run_program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_with&nbsp;<span class="constructor">Program</span>.(exec&nbsp;[<span class="string">"rm"</span>;&nbsp;<span class="string">"-f"</span>;&nbsp;path]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.clean_up]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;directory&nbsp;~run_with&nbsp;path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;nothing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"rmdir-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~done_when:(<span class="keywordsign">`</span><span class="constructor">Is_verified</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Command_returns</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Command</span>.shell&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"ls&nbsp;%s"</span>&nbsp;path),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.quick_run_program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_with&nbsp;<span class="constructor">Program</span>.(exec&nbsp;[<span class="string">"rm"</span>;&nbsp;<span class="string">"-rf"</span>;&nbsp;path]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.clean_up]<br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;one&nbsp;is&nbsp;dirtier,&nbsp;it&nbsp;does&nbsp;not&nbsp;check&nbsp;its&nbsp;result&nbsp;and&nbsp;uses&nbsp;the&nbsp;`Host.t`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directly,&nbsp;it&nbsp;should&nbsp;be&nbsp;used&nbsp;only&nbsp;when&nbsp;the&nbsp;`Machine.t`&nbsp;is&nbsp;not&nbsp;available<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(i.e.&nbsp;while&nbsp;defining&nbsp;a&nbsp;`Machine.t`).&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;path_on_host&nbsp;~host&nbsp;path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;nothing<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"rm-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(daemonize&nbsp;~using:<span class="keywordsign">`</span><span class="constructor">Python_daemon</span>&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(exec&nbsp;[<span class="string">"rm"</span>;&nbsp;<span class="string">"-rf"</span>;&nbsp;path]))<br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Gunzip</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(**
     Example: call <code class="code"><span class="string">"gunzip &lt;list of fastq.gz files&gt; &gt; some_name_cat.fastq"</span></code>.
  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;bunch_of_dot_gzs&nbsp;~result_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;result_path]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"gunzip&nbsp;-c&nbsp;&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;bunch_of_dot_gzs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Filename</span>.quote&nbsp;o<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>)&nbsp;result_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"gunzipcat-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;result_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;result_path&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_stream_processor&nbsp;~name&nbsp;run_with&nbsp;&nbsp;program)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;<span class="constructor">Remove</span>.(file&nbsp;~run_with&nbsp;result_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;<span class="constructor">List</span>.map&nbsp;~f:depends_on&nbsp;bunch_of_dot_gzs)<br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Cat</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;bunch_of_files&nbsp;~result_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;result_path]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cat&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;bunch_of_files<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Filename</span>.quote&nbsp;o<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>)&nbsp;result_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"concat-all-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;result_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;result_path&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;<span class="constructor">Remove</span>.(file&nbsp;~run_with&nbsp;result_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;<span class="constructor">List</span>.map&nbsp;~f:depends_on&nbsp;bunch_of_files)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_stream_processor&nbsp;run_with&nbsp;~name&nbsp;&nbsp;program)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cat_folder&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(depends_on=[])&nbsp;~files_gzipped&nbsp;~folder&nbsp;~destination&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;deps&nbsp;=&nbsp;depends_on&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"cat-folder-"</span>&nbsp;^&nbsp;<span class="constructor">Filename</span>.quote&nbsp;folder&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.path_on_host&nbsp;~host&nbsp;destination)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;<span class="constructor">List</span>.map&nbsp;~f:depends_on&nbsp;deps&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;files_gzipped&nbsp;<span class="keyword">then</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;(single_file&nbsp;destination&nbsp;~host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"gunzip&nbsp;-c&nbsp;%s/*&nbsp;&gt;&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;folder)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;destination)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">else</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;destination&nbsp;~host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"cat&nbsp;%s/*&nbsp;&gt;&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;folder)&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;destination)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Download</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wget_program&nbsp;?output_filename&nbsp;url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.<span class="constructor">Program</span>.exec&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"wget"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-O"</span>;&nbsp;<span class="constructor">Option</span>.value&nbsp;output_filename&nbsp;~default:<span class="constructor">Filename</span>.(basename&nbsp;url);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wget_to_folder<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~test_file&nbsp;~destination&nbsp;url&nbsp;&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"wget-"</span>&nbsp;^&nbsp;<span class="constructor">Filename</span>.basename&nbsp;destination&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test_target&nbsp;=&nbsp;destination&nbsp;//&nbsp;test_file&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;(single_file&nbsp;test_target&nbsp;~host)&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~requirements:(<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.downloading&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;destination]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"wget&nbsp;%s&nbsp;-P&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;url)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;destination)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.path_on_host&nbsp;~host&nbsp;destination);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wget<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;destination&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"wget-"</span>&nbsp;^&nbsp;<span class="constructor">Filename</span>.basename&nbsp;destination&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;destination&nbsp;~host)&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~requirements:(<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.downloading&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;destination]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"wget&nbsp;%s&nbsp;-O&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;url)&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;destination)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.path_on_host&nbsp;~host&nbsp;destination);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wget_gunzip<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~destination&nbsp;url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_gz&nbsp;=&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;url&nbsp;<span class="string">".gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;is_gz&nbsp;<span class="keyword">then</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"gunzip-"</span>&nbsp;^&nbsp;<span class="constructor">Filename</span>.basename&nbsp;(destination&nbsp;^&nbsp;<span class="string">".gz"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wgot&nbsp;=&nbsp;wget&nbsp;~host&nbsp;~run_program&nbsp;url&nbsp;(destination&nbsp;^&nbsp;<span class="string">".gz"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;destination&nbsp;~host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(wgot);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.path_on_host&nbsp;~host&nbsp;destination);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~requirements:(<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.stream_processor&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(shf&nbsp;<span class="string">"gunzip&nbsp;-c&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;wgot<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;destination)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">else</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wget&nbsp;~host&nbsp;~run_program&nbsp;url&nbsp;destination<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wget_untar<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~destination_folder&nbsp;~tar_contains&nbsp;url&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;zip_flags&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_gz&nbsp;=&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;url&nbsp;<span class="string">".gz"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_bzip&nbsp;=&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;url&nbsp;<span class="string">".bz2"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;is_gz&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"z"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="keyword">if</span>&nbsp;is_bzip&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"j"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tar_filename&nbsp;=&nbsp;(destination_folder&nbsp;^&nbsp;<span class="string">".tar"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"untar-"</span>&nbsp;^&nbsp;tar_filename&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wgot&nbsp;=&nbsp;wget&nbsp;~host&nbsp;~run_program&nbsp;url&nbsp;tar_filename&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;file_in_tar&nbsp;=&nbsp;(destination_folder&nbsp;//&nbsp;tar_contains)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;file_in_tar&nbsp;~host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(wgot);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.path_on_host&nbsp;~host&nbsp;destination_folder);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~requirements:(<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.stream_processor&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;destination_folder]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"tar&nbsp;-x%s&nbsp;-f&nbsp;%s&nbsp;-C&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zip_flags<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;wgot<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;destination_folder)))<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Vcftools</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** 
     Call a command on a list of <code class="code">~vcfs</code> to produce a given <code class="code">~final_vcf</code> (hence
     the <i>n-to-1</i> naming).
  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcf_process_n_to_1_no_machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~vcftools<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(more_edges&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~vcfs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~final_vcf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s-%s"</span>&nbsp;command_prefix&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;final_vcf)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;vcftools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"%s&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;vcfs&nbsp;~f:(<span class="keyword">fun</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Filename</span>.quote&nbsp;t<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final_vcf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;final_vcf&nbsp;~host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Remove</span>.path_on_host&nbsp;~host&nbsp;final_vcf)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;vcftools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;<span class="constructor">List</span>.map&nbsp;~f:depends_on&nbsp;vcfs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;more_edges)<br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(**
     Concatenate VCF files. 
<p>

     We use this version where we don't yet have a Machine.t, as in
     <code class="code"><span class="string">"download_reference_genome.ml"</span></code>.
  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcf_concat_no_machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~vcftools<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vcfs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~final_vcf&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;vcf_process_n_to_1_no_machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~vcftools&nbsp;~run_program&nbsp;?more_edges&nbsp;~vcfs&nbsp;~final_vcf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"vcf-concat"</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(**
     Sort a VCF file by choromosome position (it uses <code class="code"><span class="string">"vcf-sort"</span></code> which itself
     relies on the <code class="code"><span class="string">"sort"</span></code> unix tool having the <code class="code"><span class="string">"--version-sort"</span></code> option). 
<p>

     We use this version where we don't yet have a Machine.t, as in
     <code class="code"><span class="string">"download_reference_genome.ml"</span></code>.
  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcf_sort_no_machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~vcftools<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~(run_program&nbsp;:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~src&nbsp;~dest&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.with_requirements&nbsp;run_program&nbsp;[<span class="keywordsign">`</span><span class="constructor">Memory</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Big</span>]&nbsp;<span class="keyword">in</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;vcf_process_n_to_1_no_machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~vcftools&nbsp;~run_program&nbsp;?more_edges&nbsp;~vcfs:[src]&nbsp;~final_vcf:dest<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"vcf-sort&nbsp;-c"</span><br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
</code></body></html>