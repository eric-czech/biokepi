<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of extensions" rel=Appendix href="index_extensions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Biokepi_run_environment" rel="Chapter" href="Biokepi_run_environment.html">
<link title="Biokepi_environment_setup" rel="Chapter" href="Biokepi_environment_setup.html">
<link title="Biokepi_bfx_tools" rel="Chapter" href="Biokepi_bfx_tools.html">
<link title="Biokepi_pipeline_edsl" rel="Chapter" href="Biokepi_pipeline_edsl.html">
<link title="All_downloads" rel="Chapter" href="All_downloads.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Ttfi_pipeline" rel="Chapter" href="Ttfi_pipeline.html">
<link title="Biokepi" rel="Chapter" href="Biokepi.html"><title>Biokepi API : Biokepi_pipeline_edsl</title>
</head>
<body>
<code class="code"><span class="comment">(*&nbsp;code&nbsp;generated&nbsp;with&nbsp;[/Volumes/Encrypted_zzz/dev/biokepi/tools/build-doc.sh&nbsp;ketrew,ppx_deriving.std]&nbsp;*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Common_pipelines</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2015,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_bfx_tools</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Somatic</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;from_fastqs&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;normal_fastqs:<span class="constructor">Pipeline</span>.<span class="constructor">Construct</span>.input_fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor_fastqs:<span class="constructor">Pipeline</span>.<span class="constructor">Construct</span>.input_fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dataset:string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Pipeline</span>.vcf&nbsp;<span class="constructor">Pipeline</span>.t&nbsp;list<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;crazy_example&nbsp;~normal_fastqs&nbsp;~tumor_fastqs&nbsp;~dataset&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Pipeline</span>.<span class="constructor">Construct</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal&nbsp;=&nbsp;input_fastq&nbsp;~dataset&nbsp;normal_fastqs&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor&nbsp;=&nbsp;input_fastq&nbsp;~dataset&nbsp;tumor_fastqs&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_pair&nbsp;?configuration&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bwa&nbsp;?configuration&nbsp;normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;gatk_indel_realigner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;picard_mark_duplicates<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;gatk_bqsr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bwa&nbsp;?configuration&nbsp;tumor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;gatk_indel_realigner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;picard_mark_duplicates<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;gatk_bqsr<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pair&nbsp;~normal&nbsp;~tumor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_pairs&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;non_default&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span class="string">"config42"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gap_open_penalty&nbsp;=&nbsp;10;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gap_extension_penalty&nbsp;=&nbsp;7&nbsp;}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair&nbsp;~configuration:non_default&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcfs&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;bam_pairs&nbsp;~f:(<span class="keyword">fun</span>&nbsp;bam_pair&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutect&nbsp;bam_pair;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;somaticsniper&nbsp;bam_pair;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;somaticsniper<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration:<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span class="string">"example0001-095"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prior_probability&nbsp;=&nbsp;0.001;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;theta&nbsp;=&nbsp;0.95;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;bam_pair;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;varscan_somatic&nbsp;bam_pair;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strelka&nbsp;~configuration:<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.exome_default&nbsp;bam_pair;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;vcfs<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;from_fastqs_with_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~variant_caller&nbsp;~normal_fastqs&nbsp;~tumor_fastqs&nbsp;~dataset&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Pipeline</span>.<span class="constructor">Construct</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal&nbsp;=&nbsp;input_fastq&nbsp;~dataset&nbsp;normal_fastqs&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor&nbsp;=&nbsp;input_fastq&nbsp;~dataset&nbsp;tumor_fastqs&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_bam&nbsp;data&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;|&gt;&nbsp;bwa_mem&nbsp;|&gt;&nbsp;gatk_indel_realigner&nbsp;|&gt;&nbsp;picard_mark_duplicates&nbsp;|&gt;&nbsp;gatk_bqsr<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vc_input&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pair&nbsp;~normal:(make_bam&nbsp;normal)&nbsp;~tumor:(make_bam&nbsp;tumor)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[variant_caller&nbsp;vc_input]<br>
<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Optimization_framework</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(**
   QueL-like Compiler Optimization Framework
<p>

   This is “stolen” from <code class="code"><span class="string">"quel_o.ml"</span></code> …
   i.e. the “Query optimization framework in tagless-final.”
<p>

   The code is reusable for any optimization pass.
<p>

*)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="constructor">Trans_base</span>&nbsp;=&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;from<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;term<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;fwd&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;from&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;term&nbsp;<span class="comment">(*&nbsp;reflection&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;bwd&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;from&nbsp;<span class="comment">(*&nbsp;reification&nbsp;*)</span><br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="constructor">Transformation</span>&nbsp;=&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Trans_base</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;fmap&nbsp;&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;from&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;from)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;term)<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;fmap2&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;from&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;from&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>c&nbsp;from)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">'</span>a&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>c&nbsp;term)<br>
<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Add the default implementations of the mapping functions *)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Define_transformation</span>(<span class="constructor">X</span>&nbsp;:&nbsp;<span class="constructor">Trans_base</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">X</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fmap&nbsp;&nbsp;f&nbsp;term&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;fwd&nbsp;(f&nbsp;(bwd&nbsp;term))<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fmap2&nbsp;f&nbsp;term1&nbsp;term2&nbsp;=&nbsp;fwd&nbsp;(f&nbsp;(bwd&nbsp;term1)&nbsp;(bwd&nbsp;term2))<br>
<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** The default, generic optimizer.
<p>

    Concrete optimizers are built by overriding the interpretations
    of some DSL forms.
<p>

    See the module <code class="code"><span class="constructor">Transform_applications</span></code> for an example of use.
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Generic_optimizer</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">X</span>:&nbsp;<span class="constructor">Transformation</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Input</span>:&nbsp;<span class="constructor">Semantics</span>.<span class="constructor">Bioinformatics_base</span>&nbsp;<span class="keyword">with</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">X</span>.from)<br>
&nbsp;&nbsp;:&nbsp;<span class="constructor">Semantics</span>.<span class="constructor">Bioinformatics_base</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">X</span>.term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">Input</span>.observation<br>
=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Tools</span>&nbsp;=&nbsp;<span class="constructor">Biokepi_bfx_tools</span><br>
&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">X</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;term<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">Input</span>.observation<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lambda&nbsp;f&nbsp;=&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.lambda&nbsp;(<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bwd&nbsp;(f&nbsp;(fwd&nbsp;x))))<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;apply&nbsp;e1&nbsp;e2&nbsp;=&nbsp;fmap2&nbsp;<span class="constructor">Input</span>.apply&nbsp;e1&nbsp;e2<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;observe&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Input</span>.observe&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bwd&nbsp;(f&nbsp;()))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.list&nbsp;(<span class="constructor">List</span>.map&nbsp;bwd&nbsp;l))<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list_map&nbsp;l&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.list_map&nbsp;(bwd&nbsp;l)&nbsp;(bwd&nbsp;f))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_unit&nbsp;x&nbsp;=&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.to_unit&nbsp;(bwd&nbsp;x))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair&nbsp;a&nbsp;b&nbsp;=&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.pair&nbsp;(bwd&nbsp;a)&nbsp;(bwd&nbsp;b))<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_first&nbsp;x&nbsp;=&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.pair_first&nbsp;(bwd&nbsp;x))<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_second&nbsp;x&nbsp;=&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.pair_second&nbsp;(bwd&nbsp;x))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;())<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_gz&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.fastq_gz&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;())<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;~path&nbsp;?sorting&nbsp;~reference_build&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.bam&nbsp;~path&nbsp;?sorting&nbsp;~reference_build&nbsp;())<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_aln&nbsp;?configuration&nbsp;~reference_build&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.bwa_aln&nbsp;?configuration&nbsp;~reference_build&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_mem&nbsp;?configuration&nbsp;~reference_build&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.bwa_mem&nbsp;?configuration&nbsp;~reference_build&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star&nbsp;?configuration&nbsp;~reference_build&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.star&nbsp;?configuration&nbsp;~reference_build&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat&nbsp;?configuration&nbsp;~reference_build&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.hisat&nbsp;?configuration&nbsp;~reference_build&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik&nbsp;~reference_build&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.mosaik&nbsp;~reference_build&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stringtie&nbsp;?configuration&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.stringtie&nbsp;?configuration&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner&nbsp;?configuration&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.gatk_indel_realigner&nbsp;?configuration&nbsp;(bwd&nbsp;bam))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner_joint&nbsp;?configuration&nbsp;pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.gatk_indel_realigner_joint&nbsp;?configuration&nbsp;(bwd&nbsp;pair))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_mark_duplicates&nbsp;?configuration&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.picard_mark_duplicates&nbsp;?configuration&nbsp;(bwd&nbsp;bam))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_bqsr&nbsp;?configuration&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.gatk_bqsr&nbsp;?configuration&nbsp;(bwd&nbsp;bam))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;seq2hla&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.seq2hla&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;optitype&nbsp;how&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.optitype&nbsp;how&nbsp;(bwd&nbsp;fq))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_haplotype_caller&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.gatk_haplotype_caller&nbsp;(bwd&nbsp;bam))<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip&nbsp;gz&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.gunzip&nbsp;(bwd&nbsp;gz))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip_concat&nbsp;gzl&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.gunzip_concat&nbsp;(bwd&nbsp;gzl))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.concat&nbsp;(bwd&nbsp;l))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;merge_bams&nbsp;bl&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.merge_bams&nbsp;(bwd&nbsp;bl))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_to_fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;se_or_pe&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.bam_to_fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;se_or_pe&nbsp;(bwd&nbsp;bam))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect&nbsp;?configuration&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.mutect&nbsp;?configuration&nbsp;~normal:(bwd&nbsp;normal)&nbsp;~tumor:(bwd&nbsp;tumor)&nbsp;())<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect2&nbsp;?configuration&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.mutect2&nbsp;?configuration&nbsp;~normal:(bwd&nbsp;normal)&nbsp;~tumor:(bwd&nbsp;tumor)&nbsp;())<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somaticsniper&nbsp;?configuration&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.somaticsniper&nbsp;?configuration&nbsp;~normal:(bwd&nbsp;normal)&nbsp;~tumor:(bwd&nbsp;tumor)&nbsp;())<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;strelka&nbsp;?configuration&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.strelka&nbsp;?configuration&nbsp;~normal:(bwd&nbsp;normal)&nbsp;~tumor:(bwd&nbsp;tumor)&nbsp;())<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_somatic&nbsp;?adjust_mapq&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.varscan_somatic<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?adjust_mapq&nbsp;~normal:(bwd&nbsp;normal)&nbsp;~tumor:(bwd&nbsp;tumor)&nbsp;())<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse&nbsp;?configuration&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.muse&nbsp;?configuration&nbsp;~normal:(bwd&nbsp;normal)&nbsp;~tumor:(bwd&nbsp;tumor)&nbsp;())<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid&nbsp;?configuration&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;fwd&nbsp;(<span class="constructor">Input</span>.virmid&nbsp;?configuration&nbsp;~normal:(bwd&nbsp;normal)&nbsp;~tumor:(bwd&nbsp;tumor)&nbsp;())<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Pipeline</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<span class="comment">(*&nbsp;&nbsp;Copyright&nbsp;2014,&nbsp;Sebastien&nbsp;Mondet&nbsp;&lt;seb@mondet.org&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Licensed&nbsp;under&nbsp;the&nbsp;Apache&nbsp;License,&nbsp;Version&nbsp;2.0&nbsp;(the&nbsp;"License");&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;you&nbsp;may&nbsp;not&nbsp;use&nbsp;this&nbsp;file&nbsp;except&nbsp;in&nbsp;compliance&nbsp;with&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;You&nbsp;may&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;License&nbsp;at&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://www.apache.org/licenses/LICENSE-2.0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;Unless&nbsp;required&nbsp;by&nbsp;applicable&nbsp;law&nbsp;or&nbsp;agreed&nbsp;to&nbsp;in&nbsp;writing,&nbsp;software&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;distributed&nbsp;under&nbsp;the&nbsp;License&nbsp;is&nbsp;distributed&nbsp;on&nbsp;an&nbsp;"AS&nbsp;IS"&nbsp;BASIS,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;WITHOUT&nbsp;WARRANTIES&nbsp;OR&nbsp;CONDITIONS&nbsp;OF&nbsp;ANY&nbsp;KIND,&nbsp;either&nbsp;express&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;implied.&nbsp;&nbsp;See&nbsp;the&nbsp;License&nbsp;for&nbsp;the&nbsp;specific&nbsp;language&nbsp;governing&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
<span class="comment">(*&nbsp;&nbsp;permissions&nbsp;and&nbsp;limitations&nbsp;under&nbsp;the&nbsp;License.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
</code><table><tr><td></td><td><span class="comment">(**************************************************************************)</span></td></tr></table><code class="code"><br>
<br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_bfx_tools</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">File</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">type</span>&nbsp;json&nbsp;=&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json<br>
<br>
<span class="keyword">type</span>&nbsp;fastq_gz&nbsp;=&nbsp;<span class="constructor">Fastq_gz</span><br>
<span class="keyword">type</span>&nbsp;fastq&nbsp;=&nbsp;<span class="constructor">Fastq</span><br>
<span class="keyword">type</span>&nbsp;fastq_sample&nbsp;=&nbsp;<span class="constructor">Fastq_sample</span><br>
<span class="keyword">type</span>&nbsp;bam&nbsp;=&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node<br>
<span class="keyword">type</span>&nbsp;bam_pair&nbsp;=&nbsp;<span class="constructor">Bam_pair</span><br>
<span class="keyword">type</span>&nbsp;vcf&nbsp;=&nbsp;<span class="constructor">Vcf</span><br>
<span class="keyword">type</span>&nbsp;gtf&nbsp;=&nbsp;<span class="constructor">Gtf</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Seq2HLA &amp; Optitype have unique return file formats *)</span></td></tr></table><code class="code"><br>
<span class="keyword">type</span>&nbsp;seq2hla_hla_types&nbsp;=&nbsp;<span class="constructor">Seq2HLA_hla_types</span><br>
<span class="keyword">type</span>&nbsp;optitype_hla_types&nbsp;=&nbsp;<span class="constructor">Optitype_hla_types</span><br>
<br>
<br>
<span class="keyword">type</span>&nbsp;somatic&nbsp;=&nbsp;{&nbsp;normal&nbsp;:&nbsp;bam;&nbsp;tumor&nbsp;:&nbsp;bam&nbsp;}<br>
<span class="keyword">type</span>&nbsp;germline&nbsp;=&nbsp;bam<br>
<br>
<span class="keyword">type</span>&nbsp;fastq_sample_info&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;sample_name:&nbsp;string;<br>
&nbsp;&nbsp;fragment_id:&nbsp;string;<br>
}<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Variant_caller</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;_&nbsp;input&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic</span>:&nbsp;somatic&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;somatic&nbsp;input<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline</span>:&nbsp;germline&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;germline&nbsp;input<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration_json:&nbsp;json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;configuration_name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_target:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_with:&nbsp;<span class="constructor">Machine</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input:&nbsp;<span class="keywordsign">'</span>a&nbsp;input&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_prefix:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges:&nbsp;<span class="constructor">KEDSL</span>.workflow_edge&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.file_workflow<br>
&nbsp;&nbsp;}<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">type</span>&nbsp;metadata_spec&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Add_tags</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;list<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Add_tags_rec</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;list<br>
]<br>
<br>
<span class="keyword">type</span>&nbsp;_&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq_gz</span>:&nbsp;<span class="constructor">File</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_gz&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>:&nbsp;<span class="constructor">File</span>.t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq&nbsp;&nbsp;t<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;|&nbsp;List:&nbsp;'a&nbsp;t&nbsp;list&nbsp;-&gt;&nbsp;'a&nbsp;list&nbsp;t&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>:&nbsp;string&nbsp;*&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>:&nbsp;fastq_sample_info&nbsp;option&nbsp;*&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;]&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_sample&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>:&nbsp;fastq_sample_info&nbsp;*&nbsp;fastq&nbsp;t&nbsp;*&nbsp;fastq&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_sample&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>:&nbsp;fastq_sample_info&nbsp;*&nbsp;fastq&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_sample&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>:&nbsp;fastq_gz&nbsp;t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>:&nbsp;fastq&nbsp;t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>:&nbsp;<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.t&nbsp;*&nbsp;fastq_sample&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>:&nbsp;<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.t&nbsp;*&nbsp;fastq_sample&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Stringtie</span>:&nbsp;<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.t&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;gtf&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>:&nbsp;<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.t&nbsp;*&nbsp;fastq_sample&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>:&nbsp;<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.t&nbsp;*&nbsp;fastq_sample&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>:&nbsp;fastq_sample&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>:&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.indel_realigner&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>:&nbsp;<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.t&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>:&nbsp;(<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.bqsr&nbsp;*&nbsp;bam&nbsp;t)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>:&nbsp;bam&nbsp;t&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam_pair&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>:&nbsp;somatic&nbsp;<span class="constructor">Variant_caller</span>.t&nbsp;*&nbsp;bam_pair&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vcf&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>:&nbsp;germline&nbsp;<span class="constructor">Variant_caller</span>.t&nbsp;*&nbsp;bam&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;vcf&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2HLA</span>:&nbsp;fastq_sample&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;seq2hla_hla_types&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype</span>:&nbsp;([<span class="keywordsign">`</span><span class="constructor">DNA</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">RNA</span>]&nbsp;*&nbsp;fastq_sample&nbsp;t)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;optitype_hla_types&nbsp;t<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>:&nbsp;metadata_spec&nbsp;*&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;t<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Construct</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;input_fastq&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">File</span>.t&nbsp;list&nbsp;*&nbsp;<span class="constructor">File</span>.t&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">File</span>.t&nbsp;list<br>
&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_fastq&nbsp;~dataset&nbsp;(fastqs:&nbsp;input_fastq)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_fastq_gz&nbsp;p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;p&nbsp;<span class="string">"fastq.gz"</span>&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;p&nbsp;<span class="string">"fq.gz"</span>&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_fastq&nbsp;p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;p&nbsp;<span class="string">"fastq"</span>&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;p&nbsp;<span class="string">"fq"</span>&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;theyre_all&nbsp;l&nbsp;f&nbsp;=&nbsp;<span class="constructor">List</span>.for_all&nbsp;l&nbsp;~f:(<span class="keyword">fun</span>&nbsp;file&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bring_to_single_fastq&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;l&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwithf&nbsp;<span class="string">"Dataset&nbsp;%S&nbsp;seems&nbsp;empty"</span>&nbsp;dataset<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;gzs&nbsp;<span class="keyword">when</span>&nbsp;theyre_all&nbsp;gzs&nbsp;is_fastq_gz&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;gzs&nbsp;(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;f))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;fqs&nbsp;<span class="keyword">when</span>&nbsp;theyre_all&nbsp;fqs&nbsp;is_fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Concat_text</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;fqs&nbsp;(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;f))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;not_supported&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"For&nbsp;now,&nbsp;a&nbsp;sample&nbsp;must&nbsp;be&nbsp;a&nbsp;uniform&nbsp;list&nbsp;of&nbsp;fastq.gz/fq.gz&nbsp;or&nbsp;.fq/.fastq&nbsp;files.&nbsp;Dataset&nbsp;%S&nbsp;does&nbsp;not&nbsp;qualify:&nbsp;[%s]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataset<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;not_supported&nbsp;~f:(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Filename</span>.basename&nbsp;f<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">",&nbsp;"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sample_info&nbsp;=&nbsp;{sample_name&nbsp;=&nbsp;dataset;&nbsp;fragment_id&nbsp;=&nbsp;dataset}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fastqs&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;(l1,&nbsp;l2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(sample_info,&nbsp;bring_to_single_fastq&nbsp;l1,&nbsp;bring_to_single_fastq&nbsp;l2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;(sample_info,&nbsp;bring_to_single_fastq&nbsp;l)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;~dataset&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(dataset,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_to_fastq&nbsp;?sample_name&nbsp;how&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(sample_name,&nbsp;how,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.default)&nbsp;fastq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa</span>&nbsp;(configuration,&nbsp;fastq)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_aln&nbsp;=&nbsp;bwa<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_mem&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.default)&nbsp;fastq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;(configuration,&nbsp;fastq)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik&nbsp;fastq&nbsp;=&nbsp;<span class="constructor">Mosaik</span>&nbsp;fastq<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.default)&nbsp;fastq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Star</span>&nbsp;(configuration,&nbsp;fastq)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.default_v1)&nbsp;fastq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hisat</span>&nbsp;(configuration,&nbsp;fastq)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stringtie&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.default)&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Stringtie</span>&nbsp;(configuration,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration=<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.default_indel_realigner)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;(configuration,&nbsp;bam)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_mark_duplicates<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(settings=<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.default)&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(settings,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_bqsr&nbsp;?(configuration=<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.default_bqsr)&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;(configuration,&nbsp;bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair&nbsp;~normal&nbsp;~tumor&nbsp;=&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(normal,&nbsp;tumor)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;germline_variant_caller&nbsp;t&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(t,&nbsp;input_bam)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_haplotype_caller&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=&nbsp;<span class="string">"default"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~input&nbsp;~result_prefix&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Germline</span>&nbsp;input_bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.haplotype_caller&nbsp;?more_edges&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~input_bam&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;germline_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Gatk-HaplotypeCaller"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_bam<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somatic_variant_caller&nbsp;t&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(t,&nbsp;bam_pair)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect&nbsp;?(configuration=<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.default)&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~input&nbsp;~result_prefix&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Mutect</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Mutect"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect2&nbsp;?(configuration=<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.default)&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.to_json&nbsp;configuration&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~input&nbsp;~result_prefix&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.mutect2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;?more_edges&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~input_normal_bam:normal&nbsp;~input_tumor_bam:tumor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Mutect"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somaticsniper<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.default)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~input&nbsp;~result_prefix&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Somaticsniper</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Somaticsniper"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name&nbsp;=&nbsp;<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.name&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_somatic&nbsp;?adjust_mapq&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"amq-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value_map&nbsp;~default:<span class="string">"NONE"</span>&nbsp;adjust_mapq&nbsp;~f:<span class="constructor">Int</span>.to_string)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration_json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Adjust_mapq"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;(<span class="constructor">Option</span>.value_map&nbsp;adjust_mapq&nbsp;~f:<span class="constructor">Int</span>.to_string&nbsp;~default:<span class="string">"None"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Varscan-somatic"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;=&nbsp;<span class="keyword">begin</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~run_with&nbsp;~input&nbsp;~result_prefix&nbsp;?more_edges&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Varscan</span>.somatic_map_reduce&nbsp;?adjust_mapq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;strelka&nbsp;~configuration&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Strelka"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~run_with&nbsp;~input&nbsp;~result_prefix&nbsp;?more_edges&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Strelka</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~normal&nbsp;~tumor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid&nbsp;~configuration&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Virmid"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~run_with&nbsp;~input&nbsp;~result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Virmid</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~normal&nbsp;~tumor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse&nbsp;~configuration&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;~input&nbsp;~result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?more_edges&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Muse</span>.run&nbsp;~configuration&nbsp;?more_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_variant_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<span class="constructor">Variant_caller</span>.name&nbsp;=&nbsp;<span class="string">"Muse"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_json&nbsp;=&nbsp;<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.to_json&nbsp;configuration;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration_name&nbsp;=&nbsp;configuration.<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_target&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_pair<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;seq2hla&nbsp;fastq_sample&nbsp;=&nbsp;<span class="constructor">Seq2HLA</span>&nbsp;fastq_sample<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;optitype&nbsp;kind&nbsp;fastq_sample&nbsp;=&nbsp;<span class="constructor">Optitype</span>&nbsp;(kind,&nbsp;fastq_sample)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;add_tags&nbsp;?(recursively&nbsp;=&nbsp;<span class="keyword">false</span>)&nbsp;tags&nbsp;pipeline&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">With_metadata</span>&nbsp;((<span class="keyword">if</span>&nbsp;recursively&nbsp;<span class="keyword">then</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Add_tags_rec</span>&nbsp;tags&nbsp;<span class="keyword">else</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Add_tags</span>&nbsp;tags),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pipeline)<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_file_prefix:<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;a.<br>
&nbsp;&nbsp;?read:[&nbsp;<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">R2</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;?read&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;w&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(_,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_file_prefix&nbsp;?read&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;(info,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;info.fragment_id<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;(_&nbsp;::&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;read&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"-cat"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;s)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s-R1-cat"</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">R2</span>&nbsp;s)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s-R2-cat"</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"TODO"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(name,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Filename</span>.basename&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(_,&nbsp;how,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-b2fq-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"PE"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"SE"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(info,&nbsp;_&nbsp;,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;info.fragment_id<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;(configuration,&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-bwa-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;sample)&nbsp;(<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.name&nbsp;configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;(configuration,&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-bwa-mem-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;sample)&nbsp;(<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.name&nbsp;configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>&nbsp;(configuration,&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s-star-aligned"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;sample)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.name&nbsp;configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;(conf,&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-hisat-%s-aligned"</span>&nbsp;(to_file_prefix&nbsp;sample)&nbsp;(conf.<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Stringtie</span>&nbsp;(conf,&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s-stringtie"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;sample)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(conf.<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;(sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-mosaik"</span>&nbsp;(to_file_prefix&nbsp;sample)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;((indel_cfg,&nbsp;target_cfg),&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-indelrealigned-%s-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;?read&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel_cfg.<span class="constructor">Indel_realigner</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target_cfg.<span class="constructor">Realigner_target_creator</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;((bqsr_cfg,&nbsp;print_reads_cfg),&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-bqsr-%s-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;?read&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bqsr_cfg.<span class="constructor">Bqsr</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print_reads_cfg.<span class="constructor">Print_reads</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(_,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;settings,&nbsp;for&nbsp;now,&nbsp;do&nbsp;not&nbsp;impact&nbsp;the&nbsp;result&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-dedup"</span>&nbsp;(to_file_prefix&nbsp;?read&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(nor,&nbsp;tum)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_file_prefix&nbsp;tum<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(vc,&nbsp;bp)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prev&nbsp;=&nbsp;to_file_prefix&nbsp;bp&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s-%s"</span>&nbsp;prev<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Variant_caller</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Variant_caller</span>.configuration_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(vc,&nbsp;bp)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;prev&nbsp;=&nbsp;to_file_prefix&nbsp;bp&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s-%s"</span>&nbsp;prev<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Variant_caller</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vc.<span class="constructor">Variant_caller</span>.configuration_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2HLA</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"seq2hla-%s"</span>&nbsp;(to_file_prefix&nbsp;?read&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype</span>&nbsp;(kind,&nbsp;s)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"optitype-%s-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;kind&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">DNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"DNA"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">RNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"RNA"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_file_prefix&nbsp;?read&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_json:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;json&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;w&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;call&nbsp;name&nbsp;(args&nbsp;:&nbsp;json&nbsp;list):&nbsp;json&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">List</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name&nbsp;::&nbsp;args)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;w&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;file&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;call&nbsp;<span class="string">"Fastq_gz"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;file&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;call&nbsp;<span class="string">"Fastq"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(name,&nbsp;file)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Bam-sample"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(name,&nbsp;how,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;how_string&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Paired"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Single"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Bam-to-fastq"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;how_string;&nbsp;to_json&nbsp;bam]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;({sample_name;&nbsp;fragment_id},&nbsp;r1,&nbsp;r2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Paired-end"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;sample_name;&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;fragment_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_json&nbsp;r1;&nbsp;to_json&nbsp;r2]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;({sample_name;&nbsp;fragment_id},&nbsp;r)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Single-end"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;sample_name;&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;fragment_id;&nbsp;to_json&nbsp;r]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;fastq_gz_list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Gunzip-concat"</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:to_json&nbsp;fastq_gz_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>&nbsp;fastq_list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Concat"</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:to_json&nbsp;fastq_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;(config,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"BWA"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"configuration"</span>,&nbsp;<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.to_json&nbsp;config];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to_json&nbsp;input<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;(params,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"BWA-MEM"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"configuration"</span>,&nbsp;<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.to_json&nbsp;params];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_json<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>&nbsp;(conf,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"STAR"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"configuration"</span>,&nbsp;<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.to_json&nbsp;conf];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;(conf,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"HISAT"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"configuration"</span>,&nbsp;<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.to_json&nbsp;conf];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Stringtie</span>&nbsp;(conf,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Stringtie"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"configuration"</span>,&nbsp;<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.to_json&nbsp;conf];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;(input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;input&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"MOSAIK"</span>&nbsp;[input_json]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;((indel_cfg,&nbsp;target_cfg),&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;indel_cfg_json&nbsp;=&nbsp;<span class="constructor">Indel_realigner</span>.to_json&nbsp;indel_cfg&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target_cfg_json&nbsp;=&nbsp;<span class="constructor">Realigner_target_creator</span>.to_json&nbsp;target_cfg&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Gatk_indel_realigner"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Configuration"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"IndelRealigner&nbsp;Configuration"</span>,&nbsp;indel_cfg_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"RealignerTargetCreator&nbsp;Configuration"</span>,&nbsp;target_cfg_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;input_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;((bqsr_cfg,&nbsp;print_reads_cfg),&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_json&nbsp;=&nbsp;to_json&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Gatk_bqsr"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Configuration"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Bqsr"</span>,&nbsp;<span class="constructor">Bqsr</span>.to_json&nbsp;bqsr_cfg;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Print_reads"</span>,&nbsp;<span class="constructor">Print_reads</span>.to_json&nbsp;print_reads_cfg;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;input_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(gvc,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;gvc.<span class="constructor">Variant_caller</span>.name&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Configuration"</span>,&nbsp;gvc.<span class="constructor">Variant_caller</span>.configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;to_json&nbsp;bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(settings,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;settings&nbsp;should&nbsp;not&nbsp;impact&nbsp;the&nbsp;output,&nbsp;so&nbsp;we&nbsp;don't&nbsp;dump&nbsp;them.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Picard_mark_duplicates"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"input"</span>,&nbsp;to_json&nbsp;bam]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(normal,&nbsp;tumor)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Bam-pair"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<span class="string">"normal"</span>,&nbsp;to_json&nbsp;normal;&nbsp;<span class="string">"tumor"</span>,&nbsp;to_json&nbsp;tumor]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(svc,&nbsp;bam_pair)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;svc.<span class="constructor">Variant_caller</span>.name&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Configuration"</span>,&nbsp;svc.<span class="constructor">Variant_caller</span>.configuration_json;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;to_json&nbsp;bam_pair;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2HLA</span>&nbsp;input&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Seq2HLA"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;to_json&nbsp;input<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype</span>&nbsp;(kind,&nbsp;input)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;<span class="string">"Optitype"</span>&nbsp;[<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Input"</span>,&nbsp;to_json&nbsp;input;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"Kind"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;(<span class="keyword">match</span>&nbsp;kind&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">DNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"DNA"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">RNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"RNA"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(_,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;to_json&nbsp;p<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Compiler</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;pipeline&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;t<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;workflow_option_failure_mode&nbsp;=&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Silent</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Fail_if_not_happening</span>&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;workflow_option&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Multi_sample_indel_realignment</span>&nbsp;<span class="keyword">of</span>&nbsp;workflow_option_failure_mode<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Parallel_alignment_over_fastq_fragments</span>&nbsp;<span class="keyword">of</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bwa_mem</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Bwa</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Mosaik</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Star</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Hisat</span>&nbsp;]&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;workflow_option_failure_mode<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keyword">of</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gatk_indel_realigner</span>&nbsp;]<br>
&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Reference_genome</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;work_dir:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;machine&nbsp;:&nbsp;<span class="constructor">Machine</span>.t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;options:&nbsp;workflow_option&nbsp;list;<br>
&nbsp;&nbsp;&nbsp;&nbsp;wrap_bam_node:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam&nbsp;pipeline&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node;<br>
&nbsp;&nbsp;&nbsp;&nbsp;wrap_vcf_node:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vcf&nbsp;pipeline&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.single_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.single_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node;<br>
&nbsp;&nbsp;&nbsp;&nbsp;wrap_gtf_node:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gtf&nbsp;pipeline&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.single_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.single_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(wrap_bam_node&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(wrap_vcf_node&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(wrap_gtf_node&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;_&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(options=[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~work_dir&nbsp;~machine&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{reference_build;&nbsp;work_dir;&nbsp;machine;&nbsp;options;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wrap_bam_node;&nbsp;wrap_vcf_node;&nbsp;wrap_gtf_node}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;has_option&nbsp;{options;&nbsp;_}&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.exists&nbsp;options&nbsp;~f<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;apply_with_metadata&nbsp;~metadata_spec&nbsp;wf&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;metadata_spec&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Add_tags</span>&nbsp;tgs&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.add_tags&nbsp;~recursive:<span class="keyword">false</span>&nbsp;wf&nbsp;tgs<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Add_tags_rec</span>&nbsp;tgs&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">KEDSL</span>.add_tags&nbsp;~recursive:<span class="keyword">true</span>&nbsp;wf&nbsp;tgs<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;wf<br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;compiler&nbsp;variable&nbsp;name&nbsp;is&nbsp;confusing,&nbsp;perhaps&nbsp;'state'&nbsp;is&nbsp;better?&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;fastq_step&nbsp;~read&nbsp;~compiler&nbsp;(pipeline:&nbsp;fastq&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{work_dir;&nbsp;machine&nbsp;;&nbsp;_&nbsp;}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Concat_text</span>&nbsp;(l:&nbsp;fastq&nbsp;pipeline&nbsp;list)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"Compilation&nbsp;of&nbsp;Biokepi.Pipeline.Concat_text:&nbsp;not&nbsp;implemented"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;(l:&nbsp;fastq_gz&nbsp;pipeline&nbsp;list)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastqs&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;f&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;apply_with_metadata&nbsp;~metadata_spec&nbsp;(f&nbsp;p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;l&nbsp;~f&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_path&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;~read&nbsp;pipeline&nbsp;^&nbsp;<span class="string">".fastq"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Path:&nbsp;%S"</span>&nbsp;result_path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Gunzip</span>.concat&nbsp;~run_with:machine&nbsp;fastqs&nbsp;~result_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;pipeline)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_step&nbsp;~read&nbsp;~compiler&nbsp;pipeline&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;fastq_sample_step&nbsp;~compiler&nbsp;(fs&nbsp;:&nbsp;fastq_sample&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{work_dir;&nbsp;machine&nbsp;;&nbsp;_&nbsp;}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fs&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_to_fastq</span>&nbsp;(info_opt,&nbsp;how,&nbsp;what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sample_type&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_prefix&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;?read:<span class="constructor">None</span>&nbsp;what&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sample_name&nbsp;=&nbsp;<span class="constructor">Option</span>.map&nbsp;info_opt&nbsp;(<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x.sample_name)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Picard</span>.bam_to_fastq&nbsp;~run_with:machine&nbsp;~sample_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~output_prefix&nbsp;bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_pair<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(info,&nbsp;l1,&nbsp;l2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;fastq_step&nbsp;~compiler&nbsp;~read:(<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;info.fragment_id)&nbsp;l1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=&nbsp;fastq_step&nbsp;~compiler&nbsp;~read:(<span class="keywordsign">`</span><span class="constructor">R2</span>&nbsp;info.fragment_id)&nbsp;l2&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;(fastq_reads&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;machine)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:info.sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;(<span class="constructor">Some</span>&nbsp;r2<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"Pairing&nbsp;sample&nbsp;%s&nbsp;(%s&nbsp;and&nbsp;%s)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info.sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r2<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[&nbsp;depends_on&nbsp;r1;&nbsp;depends_on&nbsp;r2&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_end_sample</span>&nbsp;(info,&nbsp;single)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;fastq_step&nbsp;~compiler&nbsp;~read:(<span class="keywordsign">`</span><span class="constructor">R1</span>&nbsp;info.fragment_id)&nbsp;single&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;(fastq_reads&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;machine)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:info.sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~equivalence:<span class="keywordsign">`</span><span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[&nbsp;depends_on&nbsp;r1&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"single-end&nbsp;%s&nbsp;(%s)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;info.sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_sample_step&nbsp;~compiler&nbsp;p&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;(pipeline&nbsp;:&nbsp;bam&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{reference_build;&nbsp;work_dir;&nbsp;machine;&nbsp;_}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;pipeline&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Prefix:&nbsp;%S"</span>&nbsp;result_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;parallelize_alignment&nbsp;~make_aligner&nbsp;sample&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;sample&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(info,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;r1_list,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;r2_list)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;exploded&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;count&nbsp;=&nbsp;ref&nbsp;0&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map2&nbsp;r1_list&nbsp;r2_list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;r1&nbsp;r2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r1,&nbsp;r2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">Fastq_gz</span>&nbsp;wf1,&nbsp;<span class="constructor">Fastq_gz</span>&nbsp;wf2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;new_info&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;count;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{info&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragment_id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;fragmenting&nbsp;=&nbsp;creating&nbsp;fragments&nbsp;of&nbsp;previous&nbsp;fragment&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-fragment-%d"</span>&nbsp;info.fragment_id&nbsp;!count}&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_aligner&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(new_info,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;[r1],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;[r2]))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwith&nbsp;<span class="string">"compile_aligner_step:&nbsp;not&nbsp;implemented"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bams&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;exploded&nbsp;~f:(compile_aligner_step&nbsp;~compiler)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.merge_bams&nbsp;~run_with:machine&nbsp;bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(result_prefix&nbsp;^&nbsp;<span class="string">"-merged.bam"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parallelize_alignment&nbsp;~make_aligner&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<span class="string">"parallelize_alignment:&nbsp;Not&nbsp;fully&nbsp;implemented"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;catch_parallelize_aligner&nbsp;aligner&nbsp;sample&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;option&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.find_map&nbsp;compiler.options<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Parallel_alignment_over_fastq_fragments</span>&nbsp;(al,&nbsp;todo)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">List</span>.mem&nbsp;~set:al&nbsp;aligner&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;todo<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;sample&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;r1_list,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;r2_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">List</span>.length&nbsp;r1_list&nbsp;&gt;&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;option&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Caught</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_caught</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Paired_end_sample</span>&nbsp;(name,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;r1_list,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gunzip_concat</span>&nbsp;r2_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">List</span>.length&nbsp;r1_list&nbsp;=&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_caught</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;option&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Silent</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_caught</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Fail_if_not_happening</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Option&nbsp;Parallel_alignment_over_fastq_fragments&nbsp;is&nbsp;set&nbsp;to&nbsp;Fail_if_not_happening&nbsp;and&nbsp;it&nbsp;didn't&nbsp;happen:\n%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_json&nbsp;other&nbsp;|&gt;&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.pretty_to_string)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;perform_aligner_parallelization&nbsp;aligner_tag&nbsp;~make_aligner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow&nbsp;sample&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;catch_parallelize_aligner&nbsp;aligner_tag&nbsp;sample&nbsp;&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Caught</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;parallelize_alignment&nbsp;~make_aligner&nbsp;sample<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Not_caught</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;fastq_sample_step&nbsp;~compiler&nbsp;sample&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_workflow&nbsp;fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(name,&nbsp;bam_target)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;(configuration,&nbsp;bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span>&nbsp;has_option&nbsp;compiler&nbsp;((=)&nbsp;(<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Gatk_indel_realigner</span>))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.indel_realigner_map_reduce&nbsp;~run_with:machine&nbsp;~compress:<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;(<span class="constructor">KEDSL</span>.<span class="constructor">Single_bam</span>&nbsp;input_bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;(configuration,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.indel_realigner&nbsp;~run_with:machine&nbsp;~compress:<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;(<span class="constructor">KEDSL</span>.<span class="constructor">Single_bam</span>&nbsp;input_bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;(configuration,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">".bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.base_quality_score_recalibrator<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with:machine&nbsp;~input_bam&nbsp;~output_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Picard_mark_duplicates</span>&nbsp;(settings,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">".bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Picard</span>.mark_duplicates&nbsp;~settings<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with:machine&nbsp;~input_bam&nbsp;output_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;(bwa_mem_config,&nbsp;fq_sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perform_aligner_parallelization<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Bwa_mem</span>&nbsp;~make_aligner:(<span class="keyword">fun</span>&nbsp;pe&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Bwa_mem</span>&nbsp;(bwa_mem_config,&nbsp;pe))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fq_sample<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<span class="keyword">fun</span>&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa</span>.mem_align_to_sam&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration:bwa_mem_config<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~reference_build&nbsp;~run_with:machine)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;(bwa_config,&nbsp;what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perform_aligner_parallelization<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Bwa</span>&nbsp;~make_aligner:(<span class="keyword">fun</span>&nbsp;pe&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;(bwa_config,&nbsp;pe))&nbsp;what<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<span class="keyword">fun</span>&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bwa</span>.align_to_sam&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration:bwa_config<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~reference_build&nbsp;~run_with:machine)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;(what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perform_aligner_parallelization<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Mosaik</span>&nbsp;~make_aligner:(<span class="keyword">fun</span>&nbsp;pe&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;(pe))&nbsp;what<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<span class="keyword">fun</span>&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Mosaik</span>.align&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Star</span>&nbsp;(configuration,&nbsp;what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perform_aligner_parallelization<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Star</span>&nbsp;~make_aligner:(<span class="keyword">fun</span>&nbsp;pe&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Star</span>&nbsp;(configuration,&nbsp;pe))&nbsp;what<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<span class="keyword">fun</span>&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Star</span>.align&nbsp;~configuration&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;(configuration,&nbsp;what)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perform_aligner_parallelization<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Hisat</span>&nbsp;~make_aligner:(<span class="keyword">fun</span>&nbsp;pe&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;(configuration,&nbsp;pe))&nbsp;what<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<span class="keyword">fun</span>&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hisat</span>.align&nbsp;~configuration&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~reference_build&nbsp;~run_with:machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;compiler.wrap_bam_node&nbsp;pipeline&nbsp;bam_node<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;compile_bam_pair&nbsp;~compiler&nbsp;(pipeline&nbsp;:&nbsp;bam_pair&nbsp;pipeline)&nbsp;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;]&nbsp;*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;]&nbsp;*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Pipeline</span>&nbsp;<span class="keyword">of</span>&nbsp;bam_pair&nbsp;pipeline&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{reference_build;&nbsp;work_dir;&nbsp;machine;&nbsp;_}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Gatk_bqsr</span>&nbsp;(n_bqsr_config,&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;(n_gir_conf,&nbsp;n_bam)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Gatk_bqsr</span>&nbsp;(t_bqsr_config,&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;(t_gir_conf,&nbsp;t_bam)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_option&nbsp;compiler<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">function</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Multi_sample_indel_realignment</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;n_gir_conf&nbsp;=&nbsp;t_gir_conf&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;n_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;t_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_list_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;has_option&nbsp;compiler&nbsp;((=)&nbsp;(<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Gatk_indel_realigner</span>))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.indel_realigner_map_reduce&nbsp;~run_with:machine&nbsp;~compress:<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration:n_gir_conf&nbsp;(<span class="constructor">KEDSL</span>.<span class="constructor">Bam_workflow_list</span>&nbsp;[normal;&nbsp;tumor])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk</span>.indel_realigner&nbsp;~run_with:machine&nbsp;~compress:<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration:n_gir_conf&nbsp;(<span class="constructor">KEDSL</span>.<span class="constructor">Bam_workflow_list</span>&nbsp;[normal;&nbsp;tumor])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">KEDSL</span>.explode_bam_list_node&nbsp;bam_list_node&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[realigned_normal;&nbsp;realigned_tumor]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;new_pipeline&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;(n_bqsr_config,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(<span class="constructor">Filename</span>.chop_extension&nbsp;realigned_normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;realigned_normal)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;(t_bqsr_config,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam_sample</span>&nbsp;(<span class="constructor">Filename</span>.chop_extension&nbsp;realigned_tumor<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;realigned_tumor)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compile_bam_pair&nbsp;~compiler&nbsp;new_pipeline<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Gatk.indel_realigner&nbsp;did&nbsp;not&nbsp;return&nbsp;the&nbsp;correct&nbsp;list&nbsp;of&nbsp;length&nbsp;2&nbsp;(tumor,&nbsp;normal):&nbsp;it&nbsp;gave&nbsp;%d&nbsp;bams"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.length&nbsp;other)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;(_,&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;(_,&nbsp;_)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gatk_bqsr</span>&nbsp;(_,&nbsp;<span class="constructor">Gatk_indel_realigner</span>&nbsp;(_,&nbsp;_)))&nbsp;<span class="keyword">as</span>&nbsp;bam_pair<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">when</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;has_option&nbsp;compiler<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((=)&nbsp;(<span class="keywordsign">`</span><span class="constructor">Multi_sample_indel_realignment</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Fail_if_not_happening</span>))&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Option&nbsp;(`Multi_sample_indel_realignment&nbsp;`Fail_if_not_happening)&nbsp;is&nbsp;set&nbsp;and&nbsp;this&nbsp;pipeline&nbsp;does&nbsp;not&nbsp;qualify:\n%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(to_json&nbsp;bam_pair&nbsp;|&gt;&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.pretty_to_string)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_pair</span>&nbsp;(normal_t,&nbsp;tumor_t)&nbsp;<span class="keyword">as</span>&nbsp;final_pipeline&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;normal_t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;tumor_t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;normal,&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>&nbsp;tumor,&nbsp;<span class="keywordsign">`</span><span class="constructor">Pipeline</span>&nbsp;final_pipeline)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;normal,&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>&nbsp;tumor,&nbsp;<span class="keywordsign">`</span><span class="constructor">Pipeline</span>&nbsp;p&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compile_bam_pair&nbsp;~compiler&nbsp;p&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;(apply_with_metadata&nbsp;~metadata_spec&nbsp;normal),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>&nbsp;(apply_with_metadata&nbsp;~metadata_spec&nbsp;tumor),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Pipeline</span>&nbsp;p)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;compile_variant_caller_step&nbsp;~compiler&nbsp;(pipeline:&nbsp;vcf&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{reference_build;&nbsp;work_dir;&nbsp;machine;&nbsp;_}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;result&nbsp;prefix&nbsp;ignore&nbsp;optimizations&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcf_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Somatic_variant_caller</span>&nbsp;(som_vc,&nbsp;bam_pair)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Normal</span>&nbsp;normal,&nbsp;<span class="keywordsign">`</span><span class="constructor">Tumor</span>&nbsp;tumor,&nbsp;<span class="keywordsign">`</span><span class="constructor">Pipeline</span>&nbsp;new_bam_pair)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compile_bam_pair&nbsp;~compiler&nbsp;bam_pair&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;to_file_prefix&nbsp;(<span class="constructor">Somatic_variant_caller</span>&nbsp;(som_vc,&nbsp;new_bam_pair))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Prefix:&nbsp;%S"</span>&nbsp;result_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;som_vc.<span class="constructor">Variant_caller</span>.make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with:machine&nbsp;~input:(<span class="constructor">Variant_caller</span>.<span class="constructor">Somatic</span>&nbsp;{normal;&nbsp;tumor})<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Germline_variant_caller</span>&nbsp;(gvc,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;pipeline&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Prefix:&nbsp;%S"</span>&nbsp;result_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gvc.<span class="constructor">Variant_caller</span>.make_target<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with:machine&nbsp;~input:(<span class="constructor">Variant_caller</span>.<span class="constructor">Germline</span>&nbsp;input_bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compile_variant_caller_step&nbsp;~compiler&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;compiler.wrap_vcf_node&nbsp;pipeline&nbsp;vcf_node<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;compile_gtf_step&nbsp;~compiler&nbsp;(pipeline:&nbsp;gtf&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{reference_build;&nbsp;work_dir;&nbsp;machine;&nbsp;_}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;to_file_prefix&nbsp;pipeline&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dbg&nbsp;<span class="string">"Result_Prefix:&nbsp;%S"</span>&nbsp;result_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gtf_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Stringtie</span>&nbsp;(configuration,&nbsp;bam)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;=&nbsp;compile_aligner_step&nbsp;~compiler&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Stringtie</span>.run&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~bam&nbsp;~result_prefix&nbsp;~run_with:machine&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;compile_gtf_step&nbsp;~compiler&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;compiler.wrap_gtf_node&nbsp;pipeline&nbsp;gtf_node<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;seq2hla_hla_types_step&nbsp;~compiler&nbsp;(pipeline&nbsp;:&nbsp;seq2hla_hla_types&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{&nbsp;machine&nbsp;;&nbsp;work_dir;&nbsp;_&nbsp;}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2HLA</span>&nbsp;sample&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;work_dir&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;(to_file_prefix&nbsp;pipeline)&nbsp;^&nbsp;<span class="string">"_work_dir"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;TODO:&nbsp;Seq2HLA&nbsp;can&nbsp;actually&nbsp;take&nbsp;the&nbsp;gzipped&nbsp;version&nbsp;too,&nbsp;so&nbsp;we'd<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;need&nbsp;a&nbsp;unique&nbsp;type&nbsp;for&nbsp;that.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_pair&nbsp;=&nbsp;fastq_sample_step&nbsp;~compiler&nbsp;sample&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sample_name&nbsp;=&nbsp;fastq_pair<span class="keywordsign">#</span>product<span class="keywordsign">#</span>sample_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;fastq_pair<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;fastq_pair<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;r2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;failwithf&nbsp;<span class="string">"Seq2HLA&nbsp;doesn't&nbsp;support&nbsp;Single_end_sample(s)."</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Seq2HLA</span>.hla_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~work_dir&nbsp;~run_with:machine&nbsp;~run_name:sample_name&nbsp;~r1&nbsp;~r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;seq2hla_hla_types_step&nbsp;~compiler&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;optitype_hla_types_step&nbsp;~compiler&nbsp;(pipeline&nbsp;:&nbsp;optitype_hla_types&nbsp;pipeline)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{&nbsp;machine&nbsp;;&nbsp;work_dir;&nbsp;_&nbsp;}&nbsp;=&nbsp;compiler&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;pipeline&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype</span>&nbsp;(kind,&nbsp;sample)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;work_dir&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;(to_file_prefix&nbsp;pipeline)&nbsp;^&nbsp;<span class="string">"_work_dir"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;fastq_sample_step&nbsp;~compiler&nbsp;sample&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sample_name&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>sample_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Optitype</span>.hla_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~work_dir&nbsp;~run_with:machine&nbsp;~run_name:sample_name&nbsp;~fastq&nbsp;kind<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">With_metadata</span>&nbsp;(metadata_spec,&nbsp;p)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;optitype_hla_types_step&nbsp;~compiler&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;apply_with_metadata&nbsp;~metadata_spec<br>
<br>
<span class="keyword">end</span>&nbsp;<span class="comment">(*&nbsp;Compiler&nbsp;*)</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Pipeline_library</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(** Reusable and useful pieces of pipeline.
<p>

*)</span></td></tr></table><code class="code"><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span>.<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Input</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;<span class="keyword">of</span>&nbsp;fastq<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;fastq&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;sample_name&nbsp;:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;files&nbsp;:&nbsp;(string&nbsp;option&nbsp;*&nbsp;fastq_data)&nbsp;list;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">and</span>&nbsp;fastq_data&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">PE</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">SE</span>&nbsp;<span class="keyword">of</span>&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Of_bam</span>&nbsp;<span class="keyword">of</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">PE</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">SE</span>&nbsp;]&nbsp;*&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;]&nbsp;option&nbsp;*&nbsp;string&nbsp;*&nbsp;string<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pe&nbsp;?fragment_id&nbsp;a&nbsp;b&nbsp;=&nbsp;(fragment_id,&nbsp;<span class="constructor">PE</span>&nbsp;(a,&nbsp;b))<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;se&nbsp;?fragment_id&nbsp;a&nbsp;=&nbsp;(fragment_id,&nbsp;<span class="constructor">SE</span>&nbsp;a)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;of_bam&nbsp;?fragment_id&nbsp;?sorted&nbsp;~reference_build&nbsp;how&nbsp;s&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;(fragment_id,&nbsp;<span class="constructor">Of_bam</span>&nbsp;(how,&nbsp;sorted,&nbsp;reference_build,&nbsp;&nbsp;s))<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_sample&nbsp;~sample_name&nbsp;files&nbsp;=&nbsp;<span class="constructor">Fastq</span>&nbsp;{sample_name;&nbsp;files}<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Make</span>&nbsp;(<span class="constructor">Bfx</span>&nbsp;:&nbsp;<span class="constructor">Semantics</span>.<span class="constructor">Bioinformatics_base</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** 
     This functions guesses whether to use <code class="code">fastq</code> or <code class="code">fastq_gz</code> given the
     file name extension. If <code class="code">r1</code> and <code class="code">r2</code> dot match, it fails with an
     exception.
  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_of_files&nbsp;&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is_gz&nbsp;r&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;r1&nbsp;<span class="string">".gz"</span>&nbsp;<span class="keywordsign">||</span>&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;r1&nbsp;<span class="string">".fqz"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;is_gz&nbsp;r1,&nbsp;is_gz&nbsp;r2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>,&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bfx</span>.(fastq_gz&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;|&gt;&nbsp;gunzip)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>,&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bfx</span>.(fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"fastq_of_files:&nbsp;cannot&nbsp;handle&nbsp;mixed&nbsp;gzipped&nbsp;and&nbsp;non-gzipped&nbsp;fastq&nbsp;pairs&nbsp;(for&nbsp;a&nbsp;given&nbsp;same&nbsp;fragment)"</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Transform a value of type <code class="code"><span class="constructor">Input</span>.t</code> into a pipeline returning FASTQ data,
    providing the necessary intermediary steps. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_of_input&nbsp;u&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Input</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;u&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;{sample_name;&nbsp;files}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;files&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(fragment_id,&nbsp;source)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;source&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">PE</span>&nbsp;(r1,&nbsp;r2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_of_files&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;~r2&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">SE</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_of_files&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1:r&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Of_bam</span>&nbsp;(how,&nbsp;sorting,&nbsp;reference_build,&nbsp;path)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;=&nbsp;<span class="constructor">Bfx</span>.bam&nbsp;~path&nbsp;?sorting&nbsp;~reference_build&nbsp;()&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bfx</span>.bam_to_fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;how&nbsp;bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Bfx</span>.list<br>
<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Semantics</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="constructor">Lambda_calculus</span>&nbsp;=&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;&nbsp;<span class="comment">(*&nbsp;representation&nbsp;type&nbsp;*)</span><br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;lambda&nbsp;abstract&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;lambda&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;repr)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;application&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;apply&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;observe&nbsp;:&nbsp;(unit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="constructor">Lambda_with_list_operations</span>&nbsp;=&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Lambda_calculus</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;list:&nbsp;(<span class="keywordsign">'</span>a&nbsp;repr)&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;list&nbsp;repr<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;list_map:&nbsp;(<span class="keywordsign">'</span>a&nbsp;list&nbsp;repr)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f:(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>b&nbsp;list&nbsp;repr)<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="constructor">Bioinformatics_base</span>&nbsp;=&nbsp;<span class="keyword">sig</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Lambda_with_list_operations</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_bfx_tools</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;pair:&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;*&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;pair_first:&nbsp;(<span class="keywordsign">'</span>a&nbsp;*&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;pair_second:&nbsp;(<span class="keywordsign">'</span>a&nbsp;*&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;repr<br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** This is used to opacify the type of the expression. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;to_unit:&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;fastq&nbsp;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;sample_name&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?fragment_id&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;r1:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?r2:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;fastq_gz:<br>
&nbsp;&nbsp;&nbsp;&nbsp;sample_name&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?fragment_id&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;r1:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;?r2:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gz</span>&nbsp;<span class="keyword">of</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;bam&nbsp;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?sorting:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;gunzip:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gz</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;gunzip_concat:&nbsp;([&nbsp;<span class="keywordsign">`</span><span class="constructor">Gz</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a]&nbsp;list)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;concat:&nbsp;(<span class="keywordsign">'</span>a&nbsp;list)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;merge_bams:&nbsp;([&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;list)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;bam_to_fastq:<br>
&nbsp;&nbsp;&nbsp;&nbsp;sample_name&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;?fragment_id&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">SE</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">PE</span>&nbsp;]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;bwa_aln:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Biokepi_bfx_tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Biokepi_run_environment</span>.<span class="constructor">Reference_genome</span>.name&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;bwa_mem:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Biokepi_bfx_tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Biokepi_run_environment</span>.<span class="constructor">Reference_genome</span>.name&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;star:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Biokepi_run_environment</span>.<span class="constructor">Reference_genome</span>.name&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;hisat:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Biokepi_run_environment</span>.<span class="constructor">Reference_genome</span>.name&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;mosaik:<br>
&nbsp;&nbsp;&nbsp;&nbsp;reference_build:&nbsp;<span class="constructor">Biokepi_run_environment</span>.<span class="constructor">Reference_genome</span>.name&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;stringtie:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gtf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;gatk_indel_realigner:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration&nbsp;:&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.indel_realigner&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;gatk_indel_realigner_joint:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration&nbsp;:&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.indel_realigner&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;([&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;*&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;])&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;([&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;*&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;])&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;picard_mark_duplicates:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration&nbsp;:&nbsp;<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;gatk_bqsr:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration&nbsp;:&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.bqsr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;seq2hla:<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Seq2hla_result</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;optitype:&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="keywordsign">`</span><span class="constructor">DNA</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">RNA</span>]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Optitype_result</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;gatk_haplotype_caller:<br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;mutect:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Biokepi_bfx_tools</span>.<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;mutect2:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;somaticsniper:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;varscan_somatic:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?adjust_mapq&nbsp;:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;strelka:&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;virmid:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;muse:<br>
&nbsp;&nbsp;&nbsp;&nbsp;?configuration:&nbsp;<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;normal:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;tumor:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;repr<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">To_display</span>&nbsp;<br>
:&nbsp;<span class="keyword">sig</span><br>
</code><table><tr><td></td><td><span class="comment">(** Compiler from EDSL representations to <code class="code"><span class="constructor">SmartPrint</span>.t</code> pretty printing. *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">include</span><br>
&nbsp;&nbsp;<span class="constructor">Semantics</span>.<span class="constructor">Bioinformatics_base</span><br>
&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;var_count:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">SmartPrint</span>.t<br>
&nbsp;&nbsp;&nbsp;<span class="keyword">and</span><br>
&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;<span class="constructor">SmartPrint</span>.t<br>
<br>
<span class="keyword">end</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Nonstd</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Tools</span>&nbsp;=&nbsp;<span class="constructor">Biokepi_bfx_tools</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">SP</span>&nbsp;=&nbsp;<span class="constructor">SmartPrint</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">OCaml</span>&nbsp;=&nbsp;<span class="constructor">SmartPrint</span>.<span class="constructor">OCaml</span><br>
<span class="keyword">let</span>&nbsp;entity&nbsp;sp&nbsp;=&nbsp;<span class="constructor">SP</span>.(nest&nbsp;(parens&nbsp;&nbsp;(sp)))<br>
<br>
<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;var_count:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">SP</span>.t<br>
<br>
<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;<span class="constructor">SP</span>.t<br>
<br>
<span class="keyword">let</span>&nbsp;lambda&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"var%d"</span>&nbsp;var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_repr&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">SP</span>.string&nbsp;var_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;applied&nbsp;=&nbsp;f&nbsp;var_repr&nbsp;~var_count:(var_count&nbsp;+&nbsp;1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;<span class="constructor">SP</span>.(string&nbsp;<span class="string">"λ"</span>&nbsp;^^&nbsp;string&nbsp;var_name&nbsp;^^&nbsp;string&nbsp;<span class="string">"→"</span>&nbsp;^^&nbsp;applied)<br>
<br>
<span class="keyword">let</span>&nbsp;apply&nbsp;f&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;(<span class="constructor">SP</span>.separate&nbsp;<span class="constructor">SP</span>.space&nbsp;[f&nbsp;~var_count;&nbsp;v&nbsp;~var_count])<br>
<br>
<span class="keyword">let</span>&nbsp;observe&nbsp;f&nbsp;=&nbsp;f&nbsp;()&nbsp;~var_count:0<br>
<br>
<span class="keyword">let</span>&nbsp;to_unit&nbsp;x&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;entity&nbsp;<span class="constructor">SP</span>.(x&nbsp;~var_count&nbsp;^^&nbsp;string&nbsp;<span class="string">":&gt;&nbsp;unit"</span>)<br>
<br>
<span class="keyword">let</span>&nbsp;list&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">SP</span>.nest&nbsp;(<span class="constructor">OCaml</span>.list&nbsp;(<span class="keyword">fun</span>&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;~var_count)&nbsp;l)<br>
<br>
<span class="keyword">let</span>&nbsp;list_map&nbsp;l&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">SP</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class="string">"List.map"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^&nbsp;nest&nbsp;(string&nbsp;<span class="string">"~f:"</span>&nbsp;^^&nbsp;f&nbsp;~var_count)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^&nbsp;l&nbsp;~var_count<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
<span class="keyword">include</span>&nbsp;<span class="constructor">To_json</span>.<span class="constructor">Make_serializer</span>&nbsp;(<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">SP</span>.t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_value&nbsp;name&nbsp;kv&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">SP</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;string&nbsp;<span class="string">"input-%s"</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^&nbsp;(<span class="constructor">OCaml</span>.list&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(k,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;parens&nbsp;(string&nbsp;k&nbsp;^-^&nbsp;string&nbsp;<span class="string">":"</span>&nbsp;^^&nbsp;string&nbsp;v))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kv)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;function_call&nbsp;name&nbsp;params&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">SP</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;entity&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;string&nbsp;<span class="string">"%s"</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^&nbsp;(<span class="constructor">OCaml</span>.list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;(k,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;parens&nbsp;(string&nbsp;k&nbsp;^-^&nbsp;string&nbsp;<span class="string">":"</span>&nbsp;^^&nbsp;v))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;string&nbsp;=&nbsp;<span class="constructor">SP</span>.string<br>
&nbsp;&nbsp;<span class="keyword">end</span>)<br>
<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">To_dot</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Nonstd</span><br>
<span class="keyword">let</span>&nbsp;failwithf&nbsp;fmt&nbsp;=&nbsp;ksprintf&nbsp;failwith&nbsp;fmt<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Tree</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;box&nbsp;=&nbsp;{&nbsp;id:&nbsp;string;&nbsp;name&nbsp;:&nbsp;string;&nbsp;attributes:&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list}<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;arrow&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;label:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;points_to:&nbsp;t<br>
&nbsp;&nbsp;}&nbsp;<span class="keyword">and</span>&nbsp;t&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Variable</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Lambda</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;string&nbsp;*&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Apply</span>&nbsp;<span class="keyword">of</span>&nbsp;string&nbsp;*&nbsp;t&nbsp;*&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;<span class="keyword">of</span>&nbsp;string<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Input_value</span>&nbsp;<span class="keyword">of</span>&nbsp;box<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Node</span>&nbsp;<span class="keyword">of</span>&nbsp;box&nbsp;*&nbsp;arrow&nbsp;list<br>
&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;node_count&nbsp;=&nbsp;ref&nbsp;0<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id_style&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Hash</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_id&nbsp;a&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;a,&nbsp;id_style&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_,&nbsp;<span class="keywordsign">`</span><span class="constructor">Unique</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Unique</span>,&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;incr&nbsp;node_count;&nbsp;sprintf&nbsp;<span class="string">"node%03d"</span>&nbsp;!node_count<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Of</span>&nbsp;v,&nbsp;<span class="keywordsign">`</span><span class="constructor">Hash</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Hashtbl</span>.hash&nbsp;v&nbsp;|&gt;&nbsp;sprintf&nbsp;<span class="string">"id%d"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;arrow&nbsp;label&nbsp;points_to&nbsp;=&nbsp;{label;&nbsp;points_to}<br>
<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;[id]&nbsp;is&nbsp;just&nbsp;an&nbsp;argument&nbsp;used&nbsp;for&nbsp;hashing&nbsp;an&nbsp;identifier&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;variable&nbsp;id&nbsp;name&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Variable</span>&nbsp;(make_id&nbsp;(<span class="keywordsign">`</span><span class="constructor">Of</span>&nbsp;id),&nbsp;name)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lambda&nbsp;varname&nbsp;expr&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Lambda</span>&nbsp;(make_id&nbsp;(<span class="keywordsign">`</span><span class="constructor">Of</span>&nbsp;(varname,&nbsp;expr)),&nbsp;varname,&nbsp;expr)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;apply&nbsp;f&nbsp;v&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Apply</span>&nbsp;(make_id&nbsp;(<span class="keywordsign">`</span><span class="constructor">Of</span>&nbsp;(f,v)),&nbsp;f,&nbsp;v)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;string&nbsp;s&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;node&nbsp;?id&nbsp;?(a&nbsp;=&nbsp;[])&nbsp;name&nbsp;l&nbsp;:&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;id&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;i&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;i<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;make_id&nbsp;(<span class="keywordsign">`</span><span class="constructor">Of</span>&nbsp;(name,&nbsp;a,&nbsp;l))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Node</span>&nbsp;({id;&nbsp;name;&nbsp;attributes&nbsp;=&nbsp;a},&nbsp;l)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_value&nbsp;?(a&nbsp;=&nbsp;[])&nbsp;name&nbsp;:&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id&nbsp;=&nbsp;make_id&nbsp;(<span class="keywordsign">`</span><span class="constructor">Of</span>&nbsp;(name,&nbsp;a))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Input_value</span>&nbsp;{id;&nbsp;name;&nbsp;attributes&nbsp;=&nbsp;a}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_dot&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">SmartPrint</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;semicolon&nbsp;=&nbsp;string&nbsp;<span class="string">";"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sentence&nbsp;sp&nbsp;=&nbsp;sp&nbsp;^-^&nbsp;semicolon&nbsp;^-^&nbsp;newline&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dot_attributes&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;brakets&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;l&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(k,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;k&nbsp;^^&nbsp;string&nbsp;<span class="string">"="</span>&nbsp;^^&nbsp;v)&nbsp;|&gt;&nbsp;separate&nbsp;(semicolon)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_quotes&nbsp;s&nbsp;=&nbsp;ksprintf&nbsp;string&nbsp;<span class="string">"\"%s\""</span>&nbsp;s&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;label_attribute&nbsp;lab&nbsp;=&nbsp;(<span class="string">"label"</span>,&nbsp;in_quotes&nbsp;lab)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;font_name&nbsp;<span class="keywordsign">`</span><span class="constructor">Mono</span>&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="string">"fontname"</span>,&nbsp;in_quotes&nbsp;<span class="string">"monospace"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;font_size&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Small</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"fontsize"</span>,&nbsp;in_quotes&nbsp;<span class="string">"12"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Default</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"fontsize"</span>,&nbsp;in_quotes&nbsp;<span class="string">"16"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dot_arrow&nbsp;src&nbsp;dest&nbsp;=&nbsp;string&nbsp;src&nbsp;^^&nbsp;string&nbsp;<span class="string">"-&gt;"</span>&nbsp;^^&nbsp;string&nbsp;dest&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id_of&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Lambda</span>&nbsp;(id,&nbsp;_,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Apply</span>&nbsp;(id,&nbsp;_,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Variable</span>&nbsp;(id,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Input_value</span>&nbsp;{id;&nbsp;_}&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Node</span>&nbsp;({id;&nbsp;_},&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;id&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;label&nbsp;name&nbsp;attributes&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;attributes&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"{&lt;f0&gt;%s&nbsp;|&lt;f1&gt;&nbsp;%s\\l&nbsp;}"</span>&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;attributes&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(k,v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s:&nbsp;%s"</span>&nbsp;k&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">"\\l"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;one&nbsp;o&nbsp;=&nbsp;[o]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;go&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Variable</span>&nbsp;(_,&nbsp;s)&nbsp;<span class="keyword">as</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;id&nbsp;=&nbsp;id_of&nbsp;v&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sentence&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;id&nbsp;^^&nbsp;dot_attributes&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label_attribute&nbsp;(label&nbsp;s&nbsp;[]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font_name&nbsp;<span class="keywordsign">`</span><span class="constructor">Mono</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"shape"</span>,&nbsp;in_quotes&nbsp;<span class="string">"hexagon"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;one<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Lambda</span>&nbsp;(id,&nbsp;v,&nbsp;expr)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;To&nbsp;be&nbsp;displayed&nbsp;subgraphs&nbsp;need&nbsp;to&nbsp;be&nbsp;called&nbsp;“clusterSomething”&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class="string">"subgraph"</span>&nbsp;^^&nbsp;ksprintf&nbsp;string&nbsp;<span class="string">"cluster_%s"</span>&nbsp;id&nbsp;^^&nbsp;braces&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sentence&nbsp;(string&nbsp;<span class="string">"color=grey"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;sentence&nbsp;(string&nbsp;<span class="string">"style=rounded"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;sentence&nbsp;(string&nbsp;<span class="string">"penwidth=4"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;go&nbsp;(node&nbsp;~id&nbsp;(sprintf&nbsp;<span class="string">"Lambda&nbsp;%s"</span>&nbsp;v)&nbsp;[arrow&nbsp;<span class="string">"Expr"</span>&nbsp;expr])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.dedup&nbsp;|&gt;&nbsp;separate&nbsp;empty<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;^-^&nbsp;newline<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Apply</span>&nbsp;(id,&nbsp;f,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;go&nbsp;(node&nbsp;~id&nbsp;<span class="string">"Apply&nbsp;F(X)"</span>&nbsp;[arrow&nbsp;<span class="string">"F"</span>&nbsp;f;&nbsp;arrow&nbsp;<span class="string">"X"</span>&nbsp;v])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"`String&nbsp;%S&nbsp;-&gt;&nbsp;should&nbsp;have&nbsp;been&nbsp;eliminated"</span>&nbsp;s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Input_value</span>&nbsp;{id;&nbsp;name;&nbsp;attributes}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sentence&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;id&nbsp;^^&nbsp;dot_attributes&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label_attribute&nbsp;(label&nbsp;name&nbsp;attributes);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font_name&nbsp;<span class="keywordsign">`</span><span class="constructor">Mono</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"shape"</span>,&nbsp;in_quotes&nbsp;<span class="string">"Mrecord"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;one<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Node</span>&nbsp;({id;&nbsp;name;&nbsp;attributes},&nbsp;trees)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sentence&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;id&nbsp;^^&nbsp;dot_attributes&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label_attribute&nbsp;(label&nbsp;name&nbsp;attributes);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font_name&nbsp;<span class="keywordsign">`</span><span class="constructor">Mono</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"shape"</span>,&nbsp;in_quotes&nbsp;<span class="string">"Mrecord"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;<span class="constructor">List</span>.concat_map&nbsp;trees&nbsp;~f:(<span class="keyword">fun</span>&nbsp;{label;&nbsp;points_to}&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sentence&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dot_arrow&nbsp;(id_of&nbsp;points_to)&nbsp;id&nbsp;^^&nbsp;dot_attributes&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;label_attribute&nbsp;label;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font_size&nbsp;<span class="keywordsign">`</span><span class="constructor">Small</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;go&nbsp;points_to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dot&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class="string">"digraph&nbsp;target_graph"</span>&nbsp;^^&nbsp;braces&nbsp;(nest&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sentence&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class="string">"graph"</span>&nbsp;^^&nbsp;dot_attributes&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"rankdir"</span>,&nbsp;in_quotes&nbsp;<span class="string">"LR"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font_size&nbsp;<span class="keywordsign">`</span><span class="constructor">Default</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^-^&nbsp;(go&nbsp;t&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.dedup&nbsp;|&gt;&nbsp;separate&nbsp;empty)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;dot<br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;var_count:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Tree</span>.t<br>
<br>
<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;<span class="constructor">SmartPrint</span>.t<br>
<br>
<span class="keyword">let</span>&nbsp;lambda&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"Var_%d"</span>&nbsp;var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Here&nbsp;is&nbsp;the&nbsp;hack&nbsp;that&nbsp;makes&nbsp;nodes&nbsp;containing&nbsp;variables&nbsp;“semi-unique.”<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[var_repr_fake]&nbsp;is&nbsp;a&nbsp;first&nbsp;version&nbsp;of&nbsp;the&nbsp;variable&nbsp;representation,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;we&nbsp;feed&nbsp;to&nbsp;the&nbsp;the&nbsp;function&nbsp;[f]&nbsp;a&nbsp;first&nbsp;time.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;resulting&nbsp;tree&nbsp;is&nbsp;used&nbsp;to&nbsp;create&nbsp;the&nbsp;real&nbsp;variable&nbsp;representation,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;first&nbsp;argument&nbsp;[applied_once]&nbsp;will&nbsp;be&nbsp;hashed&nbsp;to&nbsp;create&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unique-for-this-subtree&nbsp;identifier.<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Finally&nbsp;get&nbsp;the&nbsp;normal&nbsp;[applied]&nbsp;subtree&nbsp;and&nbsp;feed&nbsp;it&nbsp;to&nbsp;[Tree.lambda].<br>
&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_repr_fake&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Tree</span>.string&nbsp;var_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;applied_once&nbsp;=&nbsp;f&nbsp;var_repr_fake&nbsp;~var_count:(var_count&nbsp;+&nbsp;1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_repr&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Tree</span>.variable&nbsp;applied_once&nbsp;var_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;applied&nbsp;=&nbsp;f&nbsp;var_repr&nbsp;~var_count:(var_count&nbsp;+&nbsp;1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.lambda&nbsp;var_name&nbsp;applied<br>
<br>
<span class="keyword">let</span>&nbsp;apply&nbsp;f&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;func&nbsp;=&nbsp;f&nbsp;~var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;arg&nbsp;=&nbsp;v&nbsp;~var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.apply&nbsp;func&nbsp;arg<br>
<br>
<span class="keyword">let</span>&nbsp;observe&nbsp;f&nbsp;=&nbsp;f&nbsp;()&nbsp;~var_count:0&nbsp;|&gt;&nbsp;<span class="constructor">Tree</span>.to_dot<br>
<br>
<span class="keyword">let</span>&nbsp;to_unit&nbsp;x&nbsp;=&nbsp;x<br>
<br>
<span class="keyword">let</span>&nbsp;list&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.node&nbsp;<span class="string">"List.make"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.mapi&nbsp;~f:(<span class="keyword">fun</span>&nbsp;i&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Tree</span>.arrow&nbsp;(sprintf&nbsp;<span class="string">"L%d"</span>&nbsp;i)&nbsp;(a&nbsp;~var_count))&nbsp;l)<br>
<br>
<span class="keyword">let</span>&nbsp;list_map&nbsp;l&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.node&nbsp;<span class="string">"List.map"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.arrow&nbsp;<span class="string">"list"</span>&nbsp;(l&nbsp;~var_count);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.arrow&nbsp;<span class="string">"function"</span>&nbsp;(f&nbsp;~var_count);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">include</span>&nbsp;<span class="constructor">To_json</span>.<span class="constructor">Make_serializer</span>&nbsp;(<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;<span class="constructor">Tree</span>.t<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_value&nbsp;name&nbsp;a&nbsp;~var_count&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.input_value&nbsp;name&nbsp;~a<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;function_call&nbsp;name&nbsp;params&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;a,&nbsp;arrows&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.partition_map&nbsp;params&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(k,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;v&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Fst</span>&nbsp;(k,&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Snd</span>&nbsp;(k,&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tree</span>.node&nbsp;~a&nbsp;name&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(k,v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Tree</span>.arrow&nbsp;k&nbsp;v)&nbsp;arrows)<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;string&nbsp;s&nbsp;=&nbsp;<span class="constructor">Tree</span>.string&nbsp;s<br>
&nbsp;&nbsp;<span class="keyword">end</span>)<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">To_json</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Nonstd</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Tools</span>&nbsp;=&nbsp;<span class="constructor">Biokepi_bfx_tools</span><br>
<br>
<span class="keyword">type</span>&nbsp;json&nbsp;=&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json<br>
<br>
<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;var_count&nbsp;:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;json<br>
<br>
<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;json<br>
<br>
<span class="keyword">let</span>&nbsp;lambda&nbsp;f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"var%d"</span>&nbsp;var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;var_repr&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;var_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;applied&nbsp;=&nbsp;f&nbsp;var_repr&nbsp;~var_count:(var_count&nbsp;+&nbsp;1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"lambda"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;var_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"body"</span>,&nbsp;applied;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;apply&nbsp;f&nbsp;v&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;func&nbsp;=&nbsp;f&nbsp;~var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;arg&nbsp;=&nbsp;v&nbsp;~var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"function"</span>,&nbsp;func;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"argument"</span>,&nbsp;arg;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;observe&nbsp;f&nbsp;=&nbsp;f&nbsp;()&nbsp;~var_count:0<br>
<br>
<span class="keyword">let</span>&nbsp;to_unit&nbsp;j&nbsp;=&nbsp;j<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;list&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">List</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;~var_count)&nbsp;l)<br>
<br>
<span class="keyword">let</span>&nbsp;list_map&nbsp;l&nbsp;~f&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"list-map"</span>,&nbsp;f&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"argument"</span>,&nbsp;l&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Make_serializer</span>&nbsp;(<span class="constructor">How</span>&nbsp;:&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;input_value&nbsp;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;var_count:int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;function_call&nbsp;:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(string&nbsp;*&nbsp;t)&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;string&nbsp;:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;t<br>
&nbsp;&nbsp;<span class="keyword">end</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">How</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_value&nbsp;<span class="string">"fastq"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sample_name"</span>,&nbsp;sample_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"fragment_id"</span>,&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">"NONE"</span>&nbsp;fragment_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"R1"</span>,&nbsp;r1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"R2"</span>,&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">"NONE"</span>&nbsp;r2;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_gz<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_value&nbsp;<span class="string">"fastq.gz"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sample_name"</span>,&nbsp;sample_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"fragment_id"</span>,&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">"NONE"</span>&nbsp;fragment_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"R1"</span>,&nbsp;r1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"R2"</span>,&nbsp;<span class="constructor">Option</span>.value&nbsp;~default:<span class="string">"NONE"</span>&nbsp;r2;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;~path&nbsp;?sorting&nbsp;~reference_build&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_value&nbsp;<span class="string">"bam"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"path"</span>,&nbsp;path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sorting"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:<span class="string">"NONE"</span>&nbsp;sorting<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">function</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Coordinate"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Read-name"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"reference_build"</span>,&nbsp;reference_build;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair&nbsp;a&nbsp;b&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"make-pair"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"first"</span>,&nbsp;a&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"second"</span>,&nbsp;b&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_first&nbsp;p&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"pair-first"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"pair"</span>,&nbsp;p&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_second&nbsp;p&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"pair-second"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"pair"</span>,&nbsp;p&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;aligner&nbsp;name&nbsp;conf_name&nbsp;~reference_build&nbsp;fq&nbsp;:&nbsp;var_count:&nbsp;int&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">How</span>.t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fq_compiled&nbsp;=&nbsp;fq&nbsp;~var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;name&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"configuration"</span>,&nbsp;string&nbsp;conf_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"reference_build"</span>,&nbsp;string&nbsp;reference_build;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"input"</span>,&nbsp;fq_compiled;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;one_to_one&nbsp;name&nbsp;conf_name&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bamc&nbsp;=&nbsp;bam&nbsp;~var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;name&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"configuration"</span>,&nbsp;string&nbsp;conf_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"input"</span>,&nbsp;bamc;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_aln<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;aligner&nbsp;<span class="string">"bwa-aln"</span>&nbsp;(<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.name&nbsp;configuration)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_mem<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;aligner&nbsp;<span class="string">"bwa-mem"</span>&nbsp;(<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.name&nbsp;configuration)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip&nbsp;gz&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"gunzip"</span>&nbsp;[<span class="string">"input"</span>,&nbsp;gz&nbsp;~var_count]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip_concat&nbsp;gzl&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"gunzip-concat"</span>&nbsp;[<span class="string">"input-list"</span>,&nbsp;gzl&nbsp;~var_count]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;l&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"concat"</span>&nbsp;[<span class="string">"input-list"</span>,&nbsp;l&nbsp;~var_count]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;merge_bams&nbsp;bl&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"merge-bams"</span>&nbsp;[<span class="string">"input-list"</span>,&nbsp;bl&nbsp;~var_count]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;aligner&nbsp;<span class="string">"star"</span>&nbsp;(<span class="constructor">Tools</span>.<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.name&nbsp;configuration)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.default_v1)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;aligner&nbsp;<span class="string">"hisat"</span>&nbsp;(configuration.<span class="constructor">Tools</span>.<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.name)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;aligner&nbsp;<span class="string">"mosaik"</span>&nbsp;<span class="string">"default"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stringtie&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one&nbsp;<span class="string">"stringtie"</span>&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.name<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;indel_real_config&nbsp;(indel,&nbsp;target)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"I%s-TC%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel.<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Indel_realigner</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target.<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Realigner_target_creator</span>.name)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.default_indel_realigner)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one&nbsp;<span class="string">"gatk_indel_realigner"</span>&nbsp;(indel_real_config&nbsp;configuration)<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner_joint<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.default_indel_realigner)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one&nbsp;<span class="string">"gatk_indel_realigner_joint"</span>&nbsp;(indel_real_config&nbsp;configuration)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_mark_duplicates<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"picard_mark_duplicates"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_bqsr&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.default_bqsr)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(bqsr,&nbsp;preads)&nbsp;=&nbsp;configuration&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one&nbsp;<span class="string">"gatk_bqsr"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"B%s-PR%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bqsr.<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Bqsr</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preads.<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Print_reads</span>.name)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;seq2hla&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one&nbsp;<span class="string">"seq2hla"</span>&nbsp;<span class="string">"default"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;optitype&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one&nbsp;<span class="string">"optitype"</span>&nbsp;(<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">DNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"DNA"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">RNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"RNA"</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_haplotype_caller&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;one_to_one&nbsp;<span class="string">"gatk_haplotype_caller"</span>&nbsp;<span class="string">"default"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_to_fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;se_or_pe&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bamc&nbsp;=&nbsp;bam&nbsp;~var_count&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;<span class="string">"bam_to_fastq"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sample_name"</span>,&nbsp;string&nbsp;sample_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"fragment_id"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~f:string&nbsp;~default:(string&nbsp;<span class="string">"N/A"</span>)&nbsp;fragment_id;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"endness"</span>,&nbsp;string&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;se_or_pe&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">SE</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"SE"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">PE</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"PE"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"input"</span>,&nbsp;bamc;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;variant_caller&nbsp;name&nbsp;conf_name&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;~(var_count&nbsp;:&nbsp;int)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;function_call&nbsp;name&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"configuration"</span>,&nbsp;string&nbsp;conf_name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"normal"</span>,&nbsp;normal&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"tumor"</span>,&nbsp;tumor&nbsp;~var_count;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;variant_caller&nbsp;<span class="string">"mutect"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect2&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;variant_caller&nbsp;<span class="string">"mutect2"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somaticsniper&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;variant_caller&nbsp;<span class="string">"somaticsniper"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;strelka&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;variant_caller&nbsp;<span class="string">"strelka"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_somatic&nbsp;?adjust_mapq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;variant_caller&nbsp;<span class="string">"varscan_somatic"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value_map&nbsp;~f:(sprintf&nbsp;<span class="string">"amap%d"</span>)&nbsp;~default:<span class="string">"default"</span>&nbsp;adjust_mapq)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.default&nbsp;<span class="keywordsign">`</span><span class="constructor">WGS</span>)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;variant_caller&nbsp;<span class="string">"muse"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;variant_caller&nbsp;<span class="string">"virmid"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;configuration.<span class="constructor">Tools</span>.<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.name<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">include</span>&nbsp;<span class="constructor">Make_serializer</span>&nbsp;(<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;json<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_value&nbsp;name&nbsp;kv&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~var_count&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="string">"input-value"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;<span class="constructor">List</span>.map&nbsp;kv&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(k,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;k,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;function_call&nbsp;name&nbsp;params&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(&nbsp;(<span class="string">"function-call"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name)&nbsp;::&nbsp;params)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;string&nbsp;s&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s<br>
&nbsp;&nbsp;<span class="keyword">end</span>)<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">To_workflow</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Nonstd</span><br>
<span class="keyword">let</span>&nbsp;(//)&nbsp;=&nbsp;<span class="constructor">Filename</span>.concat<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** The link between <code class="code"><span class="constructor">Biokepi</span>.<span class="constructor">KEDSL</span></code> values and EDSL expression types. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">File_type_specification</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span>.<span class="constructor">Common</span>.<span class="constructor">KEDSL</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;=&nbsp;..<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;+=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">To_unit</span>:&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unit&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>:&nbsp;fastq_reads&nbsp;workflow_node&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam</span>:&nbsp;bam_file&nbsp;workflow_node&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Vcf</span>:&nbsp;single_file&nbsp;workflow_node&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gtf</span>:&nbsp;single_file&nbsp;workflow_node&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gtf</span>&nbsp;]&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2hla_result</span>:&nbsp;list_of_files&nbsp;workflow_node&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Seq2hla_result</span>&nbsp;]&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype_result</span>:&nbsp;unknown_product&nbsp;workflow_node&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Optitype_result</span>&nbsp;]&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gz</span>:&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gz</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;]&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>:&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;list&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Pair</span>:&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;*&nbsp;<span class="keywordsign">'</span>b&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;*&nbsp;<span class="keywordsign">'</span>b)&nbsp;t<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Lambda</span>:&nbsp;(<span class="keywordsign">'</span>a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;t)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;t<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;to_string&nbsp;:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;a&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;string&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">To_unit</span>&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"(to_unit&nbsp;%s)"</span>&nbsp;(to_string&nbsp;a)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Fastq"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Bam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Vcf</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Vcf"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gtf</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Gtf"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2hla_result</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Seq2hla_result"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype_result</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"Optitype_result"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gz</span>&nbsp;a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"(gz&nbsp;%s)"</span>&nbsp;(to_string&nbsp;a)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"[%s]"</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;l&nbsp;~f:to_string&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">";&nbsp;"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Pair</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"(%s,&nbsp;%s)"</span>&nbsp;(to_string&nbsp;a)&nbsp;(to_string&nbsp;b)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Lambda</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"--LAMBDA--"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"##UNKNOWN##"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fail_get&nbsp;other&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;failwith&nbsp;<span class="string">"Error&nbsp;while&nbsp;extracting&nbsp;File_type_specification.t&nbsp;(%s&nbsp;case,&nbsp;in&nbsp;%s),&nbsp;this&nbsp;usually&nbsp;means&nbsp;that&nbsp;the&nbsp;type&nbsp;has&nbsp;been&nbsp;wrongly&nbsp;extended,&nbsp;and&nbsp;provides&nbsp;more&nbsp;than&nbsp;one&nbsp;[&nbsp;`%s&nbsp;]&nbsp;t&nbsp;case"</span>&nbsp;name&nbsp;(to_string&nbsp;other)&nbsp;name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_fastq&nbsp;:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Fastq</span>&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fastq_reads&nbsp;workflow_node&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"Fastq"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_bam&nbsp;:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam_file&nbsp;workflow_node&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"Bam"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_vcf&nbsp;:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;single_file&nbsp;workflow_node&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Vcf</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"Vcf"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_gtf&nbsp;:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gtf</span>&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;single_file&nbsp;workflow_node&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gtf</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"Gtf"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_seq2hla_result&nbsp;:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Seq2hla_result</span>&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;list_of_files&nbsp;workflow_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2hla_result</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"Seq2hla_result"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_optitype_result&nbsp;:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Optitype_result</span>&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;unknown_product&nbsp;workflow_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype_result</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"Optitype_result"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_gz&nbsp;:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gz</span>&nbsp;<span class="keyword">of</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gz</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"Gz"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_list&nbsp;:&nbsp;&nbsp;<span class="keywordsign">'</span>a&nbsp;list&nbsp;&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;list&nbsp;=&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;v<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;o&nbsp;<span class="string">"List"</span><br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair&nbsp;a&nbsp;b&nbsp;=&nbsp;<span class="constructor">Pair</span>&nbsp;(a,&nbsp;b)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_first&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Pair</span>&nbsp;(a,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;other&nbsp;<span class="string">"Pair"</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_second&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Pair</span>&nbsp;(_,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;other&nbsp;<span class="string">"Pair"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;as_dependency_edges&nbsp;:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;a&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;workflow_edge&nbsp;list&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;one_depends_on&nbsp;wf&nbsp;=&nbsp;[depends_on&nbsp;wf]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">To_unit</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;as_dependency_edges&nbsp;v<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;wf&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;one_depends_on&nbsp;wf<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam</span>&nbsp;wf&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;&nbsp;one_depends_on&nbsp;wf<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Vcf</span>&nbsp;wf&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;&nbsp;one_depends_on&nbsp;wf<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Gtf</span>&nbsp;wf&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;&nbsp;one_depends_on&nbsp;wf<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Seq2hla_result</span>&nbsp;wf&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;one_depends_on&nbsp;wf<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Optitype_result</span>&nbsp;wf&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;one_depends_on&nbsp;wf<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">List</span>.concat_map&nbsp;l&nbsp;~f:as_dependency_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Pair</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;as_dependency_edges&nbsp;a&nbsp;@&nbsp;as_dependency_edges&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;other&nbsp;<span class="string">"as_dependency_edges"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_unit_workflow&nbsp;:&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unit&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;unknown_product&nbsp;workflow_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~name&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;f&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">To_unit</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;without_product<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name&nbsp;~edges:(as_dependency_edges&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail_get&nbsp;other&nbsp;<span class="string">"get_unit_workflow"</span><br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="constructor">Compiler_configuration</span>&nbsp;=&nbsp;<span class="keyword">sig</span><br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;work_dir:&nbsp;string<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;machine&nbsp;:&nbsp;<span class="constructor">Machine</span>.t<br>
&nbsp;&nbsp;<span class="keyword">val</span>&nbsp;map_reduce_gatk_indel_realigner&nbsp;:&nbsp;bool<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Defaults</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;map_reduce_gatk_indel_realigner&nbsp;=&nbsp;<span class="keyword">true</span><br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Make</span>&nbsp;(<span class="constructor">Config</span>&nbsp;:&nbsp;<span class="constructor">Compiler_configuration</span>)&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span class="constructor">Semantics</span>.<span class="constructor">Bioinformatics_base</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">with</span>&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">File_type_specification</span>.t&nbsp;<span class="keyword">and</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">File_type_specification</span>.t<br>
=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">File_type_specification</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Tools</span>&nbsp;=&nbsp;<span class="constructor">Biokepi_bfx_tools</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;=&nbsp;<span class="constructor">Common</span>.<span class="constructor">KEDSL</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;failf&nbsp;fmt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;failwith&nbsp;fmt<br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;t&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;repr<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;observe&nbsp;:&nbsp;(unit&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;observation&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;()<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lambda&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;repr)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Lambda</span>&nbsp;f<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;apply&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;repr&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;f_repr&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;f_repr&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Lambda</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;repr&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;list&nbsp;repr&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">List</span>&nbsp;l<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list_map&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;list&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f:(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;repr&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;list&nbsp;repr&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;l&nbsp;~f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;l&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;v&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;apply&nbsp;f&nbsp;v)&nbsp;l)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keyword">assert</span>&nbsp;<span class="keyword">false</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_unit&nbsp;x&nbsp;=&nbsp;<span class="constructor">To_unit</span>&nbsp;x<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.as_host&nbsp;<span class="constructor">Config</span>.machine<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_with&nbsp;=&nbsp;<span class="constructor">Config</span>.machine<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Fastq</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;(<span class="constructor">KEDSL</span>.fastq_reads&nbsp;~host&nbsp;~name:sample_name&nbsp;r1&nbsp;r2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"Input-fastq:&nbsp;%s&nbsp;(%s)"</span>&nbsp;sample_name&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value&nbsp;fragment_id&nbsp;~default:(<span class="constructor">Filename</span>.basename&nbsp;r1)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_gz<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name&nbsp;?fragment_id&nbsp;~r1&nbsp;?r2&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gz</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Fastq</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;(<span class="constructor">KEDSL</span>.fastq_reads&nbsp;~host&nbsp;~name:sample_name&nbsp;r1&nbsp;r2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"Input-fastq-gz:&nbsp;%s&nbsp;(%s)"</span>&nbsp;sample_name&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value&nbsp;fragment_id&nbsp;~default:(<span class="constructor">Filename</span>.basename&nbsp;r1)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;~path&nbsp;?sorting&nbsp;~reference_build&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">KEDSL</span>.bam_file&nbsp;~host&nbsp;?sorting&nbsp;~reference_build&nbsp;path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"Input-bam:&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_aligner<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;~make_workflow&nbsp;~config_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~reference_build&nbsp;fastq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;freads&nbsp;=&nbsp;get_fastq&nbsp;fastq&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Config</span>.work_dir&nbsp;//&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s_%s-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;freads<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value&nbsp;freads<span class="keywordsign">#</span>product<span class="keywordsign">#</span>fragment_id&nbsp;~default:<span class="string">""</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(config_name&nbsp;configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;make_workflow<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~configuration&nbsp;~result_prefix&nbsp;~run_with&nbsp;freads<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_aln<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_aligner&nbsp;<span class="string">"bwaaln"</span>&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~config_name:<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~result_prefix&nbsp;~run_with&nbsp;freads&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.align_to_sam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~configuration&nbsp;~fastq:freads<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;~run_with&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~reference_build&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_mem<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_aligner&nbsp;<span class="string">"bwamem"</span>&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~config_name:<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~result_prefix&nbsp;~run_with&nbsp;freads&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Bwa</span>.mem_align_to_sam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build&nbsp;~configuration&nbsp;~fastq:freads<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;~run_with&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~reference_build&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.default)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_aligner&nbsp;<span class="string">"star"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~config_name:<span class="constructor">Tools</span>.<span class="constructor">Star</span>.<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~reference_build&nbsp;~configuration&nbsp;~result_prefix&nbsp;~run_with&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Star</span>.align&nbsp;~configuration&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.default_v1)&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_aligner&nbsp;<span class="string">"hisat"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~config_name:<span class="constructor">Tools</span>.<span class="constructor">Hisat</span>.<span class="constructor">Configuration</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~reference_build&nbsp;~configuration&nbsp;~result_prefix&nbsp;~run_with&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Hisat</span>.align&nbsp;~configuration&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Samtools</span>.sam_to_bam&nbsp;~reference_build&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;make_aligner&nbsp;<span class="string">"mosaik"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration:()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~config_name:(<span class="keyword">fun</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"default"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make_workflow:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;~reference_build&nbsp;~configuration&nbsp;~result_prefix&nbsp;~run_with&nbsp;fastq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Mosaik</span>.align&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;~result_prefix&nbsp;~run_with&nbsp;())<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Gz</span>&nbsp;<span class="keyword">of</span>&nbsp;a&nbsp;]&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;t&nbsp;=&nbsp;<span class="keyword">fun</span>&nbsp;gz&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;inside&nbsp;=&nbsp;get_gz&nbsp;gz&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;inside&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_result_path&nbsp;read&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;base&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;read&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Config</span>.work_dir&nbsp;//<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;base&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;fastqgz&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;base&nbsp;<span class="string">".fastq.gz"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_suffix&nbsp;base&nbsp;<span class="string">".gz"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;fqz&nbsp;<span class="keyword">when</span>&nbsp;<span class="constructor">Filename</span>.check_suffix&nbsp;base&nbsp;<span class="string">".fqz"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_suffix&nbsp;base&nbsp;<span class="string">".fqz"</span>&nbsp;^&nbsp;<span class="string">".fastq"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;failwith&nbsp;<span class="string">"To_workflow.gunzip:&nbsp;cannot&nbsp;recognize&nbsp;Gz-Fastq&nbsp;extension:&nbsp;%S"</span>&nbsp;other)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip&nbsp;read&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_path&nbsp;=&nbsp;make_result_path&nbsp;read<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Gunzip</span>.concat<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;[read]&nbsp;~result_path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_r1&nbsp;=&nbsp;gunzip&nbsp;f<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_r2&nbsp;=&nbsp;<span class="constructor">Option</span>.map&nbsp;f<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r2&nbsp;~f:gunzip&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Fastq</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.fastq_node_of_single_file_nodes&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:f<span class="keywordsign">#</span>product<span class="keywordsign">#</span>sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?fragment_id:f<span class="keywordsign">#</span>product<span class="keywordsign">#</span>fragment_id<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_r1&nbsp;fastq_r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;failwith&nbsp;<span class="string">"To_workflow.gunzip:&nbsp;non-FASTQ&nbsp;input&nbsp;not&nbsp;implemented"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gunzip_concat&nbsp;gzl&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;failwith&nbsp;<span class="string">"To_workflow.gunzip_concat:&nbsp;not&nbsp;implemented"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat&nbsp;:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;a&nbsp;list&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;l&nbsp;=&nbsp;get_list&nbsp;l&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;l&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fastq</span>&nbsp;first_fastq&nbsp;::&nbsp;_&nbsp;<span class="keyword">as</span>&nbsp;lfq&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fqs&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;lfq&nbsp;~f:get_fastq&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1s&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;fqs&nbsp;~f:(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r1)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2s&nbsp;=&nbsp;<span class="constructor">List</span>.filter_map&nbsp;fqs&nbsp;~f:(<span class="keyword">fun</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;f<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r2)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;TODO&nbsp;add&nbsp;some&nbsp;verifications&nbsp;that&nbsp;they&nbsp;have&nbsp;the&nbsp;same&nbsp;number&nbsp;of&nbsp;files?<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;i.e.&nbsp;that&nbsp;we&nbsp;are&nbsp;not&nbsp;mixing&nbsp;SE&nbsp;and&nbsp;PE&nbsp;fastqs<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concat_files&nbsp;~read&nbsp;l&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Config</span>.work_dir&nbsp;//<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-Read%d-Concat.fastq"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;first_fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name&nbsp;read&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Cat</span>.concat&nbsp;~run_with&nbsp;l&nbsp;~result_path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;read_1&nbsp;=&nbsp;concat_files&nbsp;r1s&nbsp;~read:1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;read_2&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2s&nbsp;<span class="keyword">with</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">|</span>&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;(concat_files&nbsp;more&nbsp;~read:2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Fastq</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.fastq_node_of_single_file_nodes&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name:first_fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~fragment_id:<span class="string">"edsl-concat"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;read_1&nbsp;read_2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ksprintf&nbsp;failwith&nbsp;<span class="string">"To_workflow.concat:&nbsp;not&nbsp;implemented"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;merge_bams:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;list&nbsp;t&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">Bam</span>&nbsp;]&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>&nbsp;[&nbsp;one_bam&nbsp;]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;one_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List</span>&nbsp;bam_files&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bams&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;bam_files&nbsp;~f:get_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;one&nbsp;=&nbsp;<span class="constructor">List</span>.hd_exn&nbsp;bams&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;one<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"-merged-%s.bam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;bams&nbsp;~f:(<span class="keyword">fun</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Digest</span>.string&nbsp;|&gt;&nbsp;<span class="constructor">Digest</span>.to_hex)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam</span>&nbsp;(<span class="constructor">Tools</span>.<span class="constructor">Samtools</span>.merge_bams&nbsp;~run_with&nbsp;bams&nbsp;output_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail_get&nbsp;other&nbsp;<span class="string">"To_workflow.merge_bams:&nbsp;not&nbsp;a&nbsp;list&nbsp;of&nbsp;bams?"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stringtie&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.default)&nbsp;bamt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam&nbsp;=&nbsp;get_bam&nbsp;bamt&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"_stringtie-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(configuration.<span class="constructor">Tools</span>.<span class="constructor">Stringtie</span>.<span class="constructor">Configuration</span>.name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Gtf</span>&nbsp;(<span class="constructor">Tools</span>.<span class="constructor">Stringtie</span>.run&nbsp;~configuration&nbsp;~bam&nbsp;~result_prefix&nbsp;~run_with&nbsp;())<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;indel_realigner_function:<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;?configuration:&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;<span class="constructor">KEDSL</span>.bam_or_bams&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.default_indel_realigner)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_what&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">Config</span>.map_reduce_gatk_indel_realigner&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.indel_realigner_map_reduce&nbsp;~run_with&nbsp;~compress:<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;on_what<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.indel_realigner&nbsp;~run_with&nbsp;~compress:<span class="keyword">false</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;on_what<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner&nbsp;?configuration&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;get_bam&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam</span>&nbsp;(indel_realigner_function&nbsp;?configuration&nbsp;(<span class="constructor">KEDSL</span>.<span class="constructor">Single_bam</span>&nbsp;input_bam))<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_indel_realigner_joint&nbsp;?configuration&nbsp;bam_pair&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam1&nbsp;=&nbsp;bam_pair&nbsp;|&gt;&nbsp;pair_first&nbsp;|&gt;&nbsp;get_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam2&nbsp;=&nbsp;bam_pair&nbsp;|&gt;&nbsp;pair_second&nbsp;|&gt;&nbsp;get_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_list_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel_realigner_function&nbsp;(<span class="constructor">KEDSL</span>.<span class="constructor">Bam_workflow_list</span>&nbsp;[bam1;&nbsp;bam2])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;<span class="constructor">KEDSL</span>.explode_bam_list_node&nbsp;bam_list_node&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[realigned_normal;&nbsp;realigned_tumor]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pair&nbsp;(<span class="constructor">Bam</span>&nbsp;realigned_normal)&nbsp;(<span class="constructor">Bam</span>&nbsp;realigned_tumor)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failf&nbsp;<span class="string">"Gatk.indel_realigner&nbsp;did&nbsp;not&nbsp;return&nbsp;the&nbsp;correct&nbsp;list&nbsp;of&nbsp;length&nbsp;2&nbsp;(tumor,&nbsp;normal):&nbsp;it&nbsp;gave&nbsp;%d&nbsp;bams"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.length&nbsp;other)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_mark_duplicates<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Picard</span>.<span class="constructor">Mark_duplicates_settings</span>.default)&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;get_bam&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;assume&nbsp;that&nbsp;the&nbsp;settings&nbsp;do&nbsp;not&nbsp;impact&nbsp;the&nbsp;actual&nbsp;result.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;^&nbsp;<span class="string">"_markdup.bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Picard</span>.mark_duplicates&nbsp;~settings:configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~input_bam&nbsp;output_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_bqsr&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.default_bqsr)&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;get_bam&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;(bqsr,&nbsp;preads)&nbsp;=&nbsp;configuration&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"_bqsr-B%sP%s.bam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bqsr.<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Bqsr</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;preads.<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Print_reads</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Bam</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.base_quality_score_recalibrator&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~input_bam&nbsp;~output_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;seq2hla&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;get_fastq&nbsp;fq&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>r2&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;r<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failf&nbsp;<span class="string">"Seq2HLA&nbsp;doesn't&nbsp;support&nbsp;Single_end_sample(s)."</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;work_dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Config</span>.work_dir&nbsp;//<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s_seq2hla-workdir"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>fragment_id_forced<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Seq2hla_result</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Seq2HLA</span>.hla_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~work_dir&nbsp;~run_with&nbsp;~run_name:fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name&nbsp;~r1&nbsp;~r2<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;optitype&nbsp;how&nbsp;fq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq&nbsp;=&nbsp;get_fastq&nbsp;fq&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;work_dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Config</span>.work_dir&nbsp;//<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s_optitype-%s-workdir"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">RNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"RNA"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">DNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"DNA"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>fragment_id_forced<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Optitype_result</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Optitype</span>.hla_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~work_dir&nbsp;~run_with&nbsp;~run_name:fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name&nbsp;~fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;how<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&gt;&nbsp;<span class="constructor">KEDSL</span>.unknown_product&nbsp;<span class="constructor">KEDSL</span>.workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_haplotype_caller&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;get_bam&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"_gatkhaplo"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Vcf</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.haplotype_caller&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~input_bam&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_to_fastq&nbsp;~sample_name&nbsp;?fragment_id&nbsp;how&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;get_bam&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sample_type&nbsp;=&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">SE</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">PE</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Config</span>.work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;sprintf&nbsp;<span class="string">"%s-b2fq-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.(chop_extension&nbsp;(basename&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">PE</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"PE"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">SE</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"SE"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Fastq</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Picard</span>.bam_to_fastq&nbsp;~run_with&nbsp;~sample_type<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name&nbsp;~output_prefix&nbsp;input_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somatic_vc<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;confname&nbsp;default_conf&nbsp;runfun<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?configuration&nbsp;~normal&nbsp;~tumor&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal_bam&nbsp;=&nbsp;get_bam&nbsp;normal&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor_bam&nbsp;=&nbsp;get_bam&nbsp;tumor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;configuration&nbsp;=&nbsp;<span class="constructor">Option</span>.value&nbsp;configuration&nbsp;~default:default_conf&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;tumor_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"_%s-%s"</span>&nbsp;name&nbsp;(confname&nbsp;configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Vcf</span>&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;runfun<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal:normal_bam&nbsp;~tumor:tumor_bam&nbsp;~result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_vc&nbsp;<span class="string">"mutect"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Mutect</span>.<span class="constructor">Configuration</span>.default<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Mutect</span>.run&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect2&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_vc&nbsp;<span class="string">"mutect2"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.default<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Gatk</span>.mutect2&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~input_normal_bam:normal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~input_tumor_bam:tumor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;somaticsniper&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_vc&nbsp;<span class="string">"somaticsniper"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Somaticsniper</span>.<span class="constructor">Configuration</span>.default<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Somaticsniper</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;())<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;strelka&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_vc&nbsp;<span class="string">"strelka"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Strelka</span>.<span class="constructor">Configuration</span>.default<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Strelka</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~normal&nbsp;~tumor&nbsp;~run_with&nbsp;~result_prefix&nbsp;())<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_somatic&nbsp;?adjust_mapq&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_vc&nbsp;<span class="string">"varscan_somatic"</span>&nbsp;(<span class="keyword">fun</span>&nbsp;()&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"Amq%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value_map&nbsp;adjust_mapq&nbsp;~default:<span class="string">"N"</span>&nbsp;~f:<span class="constructor">Int</span>.to_string))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;()<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Varscan</span>.somatic_map_reduce&nbsp;?adjust_mapq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;())<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration:()<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_vc&nbsp;<span class="string">"muse"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Tools</span>.<span class="constructor">Muse</span>.<span class="constructor">Configuration</span>.default&nbsp;<span class="keywordsign">`</span><span class="constructor">WGS</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Muse</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_vc&nbsp;<span class="string">"virmid"</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Virmid</span>.<span class="constructor">Configuration</span>.default<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Tools</span>.<span class="constructor">Virmid</span>.run<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~normal&nbsp;~tumor&nbsp;~run_with&nbsp;~result_prefix&nbsp;())<br>
<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Transform_applications</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** 
<p>

   We use here the <code class="code"><span class="constructor">Optimization_framework</span></code> module to apply a bit more than
   <a href="https://en.wikipedia.org/wiki/Lambda_calculus">Β-reduction</a>:  we also try
   to apply the <code class="code"><span class="constructor">List_repr</span>.map</code>, and build <code class="code"><span class="constructor">List_repr</span>.make</code> values.
<p>

   This optimization-pass is a good example of use of the
   <code class="code"><span class="constructor">Optimization_framework</span></code>.
*)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Nonstd</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Apply_optimization_framework</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Input</span>&nbsp;:&nbsp;<span class="constructor">Semantics</span>.<span class="constructor">Bioinformatics_base</span>)<br>
=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** The “core” of the transformation is implemented here.
<p>

      <code class="code"><span class="constructor">Input</span></code> is the input language.
<p>

      <code class="code"><span class="constructor">Transformation_types</span></code> defines a GADT that encodes the subset of the
      EDSL that is of interest to the transformation.
<p>

      <code class="code"><span class="keywordsign">'</span>a <span class="constructor">Transformation_types</span>.term</code> is designed to allow us to pattern match
      (in the function <code class="code"><span class="constructor">Transformation_types</span>.bwd</code>).
<p>

      All the terms of the input language that are not relevant to the
      transformation are wrapped in <code class="code"><span class="constructor">Transformation_types</span>.<span class="constructor">Unknown</span></code>.
  *)</span></td></tr></table><code class="code"><br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Transformation_types</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;from&nbsp;=&nbsp;<span class="keywordsign">'</span>a&nbsp;<span class="constructor">Input</span>.repr<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;term&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Unknown</span>&nbsp;:&nbsp;<span class="keywordsign">'</span>a&nbsp;from&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Apply</span>&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;term&nbsp;*&nbsp;<span class="keywordsign">'</span>a&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Lambda</span>&nbsp;:&nbsp;(<span class="keywordsign">'</span>a&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;term)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List_make</span>:&nbsp;(<span class="keywordsign">'</span>a&nbsp;term)&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;list&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List_map</span>:&nbsp;(<span class="keywordsign">'</span>a&nbsp;list&nbsp;term&nbsp;*&nbsp;(<span class="keywordsign">'</span>a&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b)&nbsp;term)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;list&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Pair</span>:&nbsp;<span class="keywordsign">'</span>a&nbsp;term&nbsp;*&nbsp;<span class="keywordsign">'</span>b&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="keywordsign">'</span>a&nbsp;*&nbsp;<span class="keywordsign">'</span>b)&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fst</span>:&nbsp;&nbsp;(<span class="keywordsign">'</span>a&nbsp;*&nbsp;<span class="keywordsign">'</span>b)&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>a&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Snd</span>:&nbsp;&nbsp;(<span class="keywordsign">'</span>a&nbsp;*&nbsp;<span class="keywordsign">'</span>b)&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">'</span>b&nbsp;term<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fwd&nbsp;x&nbsp;=&nbsp;<span class="constructor">Unknown</span>&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;bwd&nbsp;:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;a&nbsp;term&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;from&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Apply</span>&nbsp;(<span class="constructor">Lambda</span>&nbsp;f,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bwd&nbsp;(f&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Apply</span>&nbsp;(other,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Input</span>.apply&nbsp;(bwd&nbsp;other)&nbsp;(bwd&nbsp;v)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List_map</span>&nbsp;(<span class="constructor">List_make</span>&nbsp;l,&nbsp;<span class="constructor">Lambda</span>&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Input</span>.list&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bwd&nbsp;(f&nbsp;x))&nbsp;l)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List_map</span>&nbsp;(x,&nbsp;f)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Input</span>.list_map&nbsp;~f:(bwd&nbsp;f)&nbsp;(bwd&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Lambda</span>&nbsp;f&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Input</span>.lambda&nbsp;(<span class="keyword">fun</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(bwd&nbsp;(f&nbsp;(fwd&nbsp;x))))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">List_make</span>&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Input</span>.list&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:bwd&nbsp;l)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fst</span>&nbsp;(<span class="constructor">Pair</span>&nbsp;(a,&nbsp;b))&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bwd&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Snd</span>&nbsp;(<span class="constructor">Pair</span>&nbsp;(a,&nbsp;b))&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bwd&nbsp;b<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Pair</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Input</span>.pair&nbsp;(bwd&nbsp;a)&nbsp;(bwd&nbsp;b)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Fst</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Input</span>.pair_first&nbsp;(bwd&nbsp;b)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Snd</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Input</span>.pair_second&nbsp;(bwd&nbsp;b)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Unknown</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;x<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** Applying this functor just adds functions that we don't use yet; so this
      could be simplified in the future. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Transformation</span>&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Optimization_framework</span>.<span class="constructor">Define_transformation</span>(<span class="constructor">Transformation_types</span>)<br>
&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Transformation</span><br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** <code class="code"><span class="constructor">Language_delta</span></code> is where we “intercept” the terms of the language that
      are interesting.
<p>

      For all the other ones <code class="code"><span class="constructor">Transformation_types</span>.fwd</code> will be used
      by <code class="code"><span class="constructor">Optimization_framework</span>.<span class="constructor">Generic_optimizer</span></code>.
<p>

  *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Language_delta</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Transformation_types</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;apply&nbsp;f&nbsp;x&nbsp;=&nbsp;<span class="constructor">Apply</span>&nbsp;(f,&nbsp;x)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lambda&nbsp;f&nbsp;=&nbsp;<span class="constructor">Lambda</span>&nbsp;f<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list&nbsp;l&nbsp;=&nbsp;<span class="constructor">List_make</span>&nbsp;l<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;list_map&nbsp;l&nbsp;~f&nbsp;=&nbsp;<span class="constructor">List_map</span>&nbsp;(l,&nbsp;f)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair&nbsp;a&nbsp;b&nbsp;=&nbsp;<span class="constructor">Pair</span>&nbsp;(a,&nbsp;b)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_first&nbsp;p&nbsp;=&nbsp;<span class="constructor">Fst</span>&nbsp;p<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pair_second&nbsp;p&nbsp;=&nbsp;<span class="constructor">Snd</span>&nbsp;p<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<span class="keyword">end</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** <code class="code"><span class="constructor">Apply</span></code> is the entry point that transforms EDSL terms.  *)</span></td></tr></table><code class="code"><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Apply</span>&nbsp;(<span class="constructor">Input</span>&nbsp;:&nbsp;<span class="constructor">Semantics</span>.<span class="constructor">Bioinformatics_base</span>)&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">The_pass</span>&nbsp;=&nbsp;<span class="constructor">Apply_optimization_framework</span>(<span class="constructor">Input</span>)<br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** We populate the module with the default implementations (which do
      nothing). *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Optimization_framework</span>.<span class="constructor">Generic_optimizer</span>(<span class="constructor">The_pass</span>.<span class="constructor">Transformation</span>)(<span class="constructor">Input</span>)<br>
<br>
&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;</td><td><span class="comment">(** We override the few functions we're interested in. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">The_pass</span>.<span class="constructor">Language_delta</span><br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">end</span><br>
</code></body></html>