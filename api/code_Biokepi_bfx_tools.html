<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of extensions" rel=Appendix href="index_extensions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Biokepi_run_environment" rel="Chapter" href="Biokepi_run_environment.html">
<link title="Biokepi_environment_setup" rel="Chapter" href="Biokepi_environment_setup.html">
<link title="Biokepi_bfx_tools" rel="Chapter" href="Biokepi_bfx_tools.html">
<link title="Biokepi_pipeline_edsl" rel="Chapter" href="Biokepi_pipeline_edsl.html">
<link title="All_downloads" rel="Chapter" href="All_downloads.html">
<link title="Main" rel="Chapter" href="Main.html">
<link title="Ttfi_pipeline" rel="Chapter" href="Ttfi_pipeline.html">
<link title="Biokepi" rel="Chapter" href="Biokepi.html"><title>Biokepi API : Biokepi_bfx_tools</title>
</head>
<body>
<code class="code"><span class="comment">(*&nbsp;code&nbsp;generated&nbsp;with&nbsp;[/Volumes/Encrypted_zzz/dev/biokepi/tools/build-doc.sh&nbsp;ketrew,ppx_deriving.std]&nbsp;*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Bedtools</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Intersect</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;params:&nbsp;string&nbsp;list;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Catch-all list of parameters to be concatted
                                    together and passed to the command. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with_headers:&nbsp;bool;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** The header of A will be prepended to the
                                   output. <code class="code">-header</code>. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=&nbsp;{&nbsp;params&nbsp;=&nbsp;[];&nbsp;with_headers&nbsp;=&nbsp;<span class="keyword">true</span>;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;render&nbsp;{params;&nbsp;with_headers}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;with_headers&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"&nbsp;-header&nbsp;"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">"&nbsp;"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;params)<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;bamtofastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;~sample_type&nbsp;~output_prefix&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;input_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_output_options,&nbsp;r1,&nbsp;r2opt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;sample_type&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s_R1.fastq"</span>&nbsp;output_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s_R2.fastq"</span>&nbsp;output_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([<span class="string">"-fq"</span>;&nbsp;r1;&nbsp;<span class="string">"-fq2"</span>;&nbsp;r2],&nbsp;r1,&nbsp;<span class="constructor">Some</span>&nbsp;r2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.fastq"</span>&nbsp;output_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([<span class="string">"-fq"</span>;&nbsp;r1],&nbsp;r1,&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bedtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.bedtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src_bam&nbsp;=&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;bedtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;r1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;(<span class="string">"bedtools"</span>&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"bamtofastq"</span>&nbsp;::&nbsp;&nbsp;<span class="string">"-i"</span>&nbsp;::&nbsp;src_bam&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq_output_options))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"bedtools-bamtofastq-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;src_bam&nbsp;|&gt;&nbsp;chop_extension)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;bedtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;input_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;r1);<br>
&nbsp;&nbsp;&nbsp;&nbsp;on_success_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path);<br>
&nbsp;&nbsp;]&nbsp;|&gt;&nbsp;<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;r2opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;r2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;r2)&nbsp;::&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;(fastq_reads&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with)&nbsp;r1&nbsp;r2opt)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges&nbsp;~name&nbsp;~make<br>
<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Used to determine if features in multiple sets intersect with one another.
<p>

Feature sets include BED, VCF, GFF, and BAM files.
<p>
<ul>
<li><code class="code">primary</code>: The primary set file (workflow_node with #path).</li>
<li><code class="code">intersect_with</code>: List of set file workflow_nodes to intersect with.</li>
<li><code class="code">result</code>: Path to the resulting set.</li>
</ul>

*)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;intersect<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(configuration=<span class="constructor">Configuration</span>.<span class="constructor">Intersect</span>.default)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~primary&nbsp;~intersect_with&nbsp;output<br>
&nbsp;&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bedtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.bedtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;arguments&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"-a&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;primary<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))&nbsp;^<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;n<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))&nbsp;intersect_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">","</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;sprintf&nbsp;<span class="string">"&nbsp;-b&nbsp;%s&nbsp;"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;(<span class="constructor">Configuration</span>.<span class="constructor">Intersect</span>.render&nbsp;configuration)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;bedtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;(<span class="string">"bedtools&nbsp;intersect&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;arguments&nbsp;^&nbsp;<span class="string">"&nbsp;&gt;&nbsp;"</span>&nbsp;^&nbsp;output))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"bedtools-intersect-%s-with-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;primary<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"__"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;n<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))&nbsp;intersect_with))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;run_with&nbsp;~name&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;primary;<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;bedtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;run_with&nbsp;output)<br>
&nbsp;&nbsp;]&nbsp;@&nbsp;(<span class="constructor">List</span>.map&nbsp;~f:depends_on&nbsp;intersect_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.as_host&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;out&nbsp;=&nbsp;single_file&nbsp;~host&nbsp;output&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;out&nbsp;~name&nbsp;~edges&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~done_when:(<span class="keywordsign">`</span><span class="constructor">Is_verified</span>&nbsp;(out<span class="keywordsign">#</span>is_bigger_than&nbsp;1))<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Bwa</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_gap_open_penalty&nbsp;=&nbsp;11<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_gap_extension_penalty&nbsp;=&nbsp;4<br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Common</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gap_open_penalty:&nbsp;int;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gap_extension_penalty:&nbsp;int;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span class="string">"default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gap_open_penalty&nbsp;=&nbsp;default_gap_open_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gap_extension_penalty&nbsp;=&nbsp;default_gap_extension_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;gap_open_penalty;&nbsp;gap_extension_penalty}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"gap_open_penalty"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Int</span>&nbsp;gap_open_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"gap_extension_penalty"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Int</span>&nbsp;gap_extension_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Aln</span>&nbsp;=&nbsp;<span class="constructor">Common</span><br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Mem</span>&nbsp;=&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;`bwa&nbsp;index`&nbsp;creates&nbsp;a&nbsp;bunch&nbsp;of&nbsp;files,&nbsp;c.f.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[this&nbsp;question](https://www.biostars.org/p/73585/)&nbsp;we&nbsp;detect&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`.bwt`&nbsp;one.&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.bwa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"bwa-index-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.bwt"</span>&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))&nbsp;result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;bwa_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"bwa"</span>;&nbsp;<span class="string">"index"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;bwa_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"bwa&nbsp;index&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)))<br>
<br>
<span class="keyword">let</span>&nbsp;read_group_header_option&nbsp;algorithm&nbsp;~sample_name&nbsp;~read_group_id&nbsp;=<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;this&nbsp;option&nbsp;should&nbsp;magically&nbsp;make&nbsp;the&nbsp;sam&nbsp;file&nbsp;compatible<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mutect&nbsp;and&nbsp;other&nbsp;GATK-like&nbsp;pieces&nbsp;of&nbsp;software<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://seqanswers.com/forums/showthread.php?t=17233<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;`LB`&nbsp;one&nbsp;seems&nbsp;“necessary”&nbsp;for&nbsp;somatic&nbsp;sniper:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`[bam_header_parse]&nbsp;missing&nbsp;LB&nbsp;tag&nbsp;in&nbsp;@RG&nbsp;lines.`<br>
&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;algorithm&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span><span class="keywordsign">`</span><span class="constructor">Mem</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"-R&nbsp;'@RG\\tID:%s\\tSM:%s\\tLB:ga\\tPL:Illumina'"</span>&nbsp;read_group_id&nbsp;sample_name<br>
&nbsp;&nbsp;<span class="keywordsign">|</span><span class="keywordsign">`</span><span class="constructor">Aln</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"-r&nbsp;'@RG\\tID:%s\\tSM:%s\\tLB:ga\\tPL:Illumina'"</span>&nbsp;read_group_id&nbsp;sample_name<br>
<br>
<span class="keyword">let</span>&nbsp;mem_align_to_sam<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.default)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;~(r1:&nbsp;KEDSL.single_file&nbsp;KEDSL.workflow_node)&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;?(r2:&nbsp;KEDSL.single_file&nbsp;KEDSL.workflow_node&nbsp;option)&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;~(result_prefix:string)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_work_dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;(dirname&nbsp;result_prefix))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;`bwa&nbsp;index`&nbsp;creates&nbsp;a&nbsp;bunch&nbsp;of&nbsp;files,&nbsp;c.f.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[this&nbsp;question](https://www.biostars.org/p/73585/)&nbsp;we&nbsp;detect&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`.bwt`&nbsp;one.&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.bwa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_index&nbsp;=&nbsp;index&nbsp;~reference_build&nbsp;~run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.sam"</span>&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_path,&nbsp;r2_path_opt&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>paths&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"bwa-mem-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_base_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"bwa&nbsp;mem"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(read_group_header_option&nbsp;<span class="keywordsign">`</span><span class="constructor">Mem</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name:fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~read_group_id:(<span class="constructor">Filename</span>.basename&nbsp;r1_path));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-t"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;processors;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-O"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;configuration.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.gap_open_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-E"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;configuration.<span class="constructor">Configuration</span>.<span class="constructor">Mem</span>.gap_extension_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_base_target&nbsp;~bwa_command&nbsp;&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;result&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;bwa_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;depends_on&nbsp;bwa_index<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;depends_on&nbsp;fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~processors&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"bwa"</span>;&nbsp;<span class="string">"mem"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;bwa_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;in_work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;bwa_command))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2_path_opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;read2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bwa_base_command;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;read2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&gt;"</span>;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;bwa_base_target&nbsp;~bwa_command<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bwa_base_command;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&gt;"</span>;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;bwa_base_target&nbsp;~bwa_command<br>
<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;align_to_sam<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.default)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(result_prefix:string)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_work_dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;(dirname&nbsp;result_prefix))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;`bwa&nbsp;index`&nbsp;creates&nbsp;a&nbsp;bunch&nbsp;of&nbsp;files,&nbsp;c.f.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[this&nbsp;question](https://www.biostars.org/p/73585/)&nbsp;we&nbsp;detect&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`.bwt`&nbsp;one.&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.bwa&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_index&nbsp;=&nbsp;index&nbsp;~reference_build&nbsp;~run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_aln&nbsp;read_number&nbsp;read&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"bwa-aln-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;read)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s-R%d.sai"</span>&nbsp;result_prefix&nbsp;read_number&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bwa_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"bwa&nbsp;aln"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-t"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;processors;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-O"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;configuration.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.gap_open_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-E"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;configuration.<span class="constructor">Configuration</span>.<span class="constructor">Aln</span>.gap_extension_penalty;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;read);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&gt;"</span>;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;result&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fastq;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;bwa_index;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;bwa_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~processors&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"bwa"</span>;&nbsp;<span class="string">"aln"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;bwa_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;in_work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;bwa_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_path,&nbsp;r2_path_opt&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>paths&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_sai&nbsp;=&nbsp;bwa_aln&nbsp;1&nbsp;r1_path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2_sai_opt&nbsp;=&nbsp;<span class="constructor">Option</span>.map&nbsp;r2_path_opt&nbsp;~f:(<span class="keyword">fun</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(bwa_aln&nbsp;2&nbsp;r,&nbsp;r))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"bwa-sam-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;result_prefix)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.sam"</span>&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program,&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;common_edges&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;r1_sai;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;bwa_index;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;bwa_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2_sai_opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(r2_sai,&nbsp;r2)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;bwa_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;in_work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"bwa&nbsp;sampe&nbsp;%s&nbsp;%s&nbsp;%s&nbsp;%s&nbsp;%s&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(read_group_header_option&nbsp;<span class="keywordsign">`</span><span class="constructor">Aln</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name:fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~read_group_id:(<span class="constructor">Filename</span>.basename&nbsp;r1_path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_sai<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r2_sai<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;result)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(depends_on&nbsp;r2_sai&nbsp;::&nbsp;common_edges)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;bwa_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;in_work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"bwa&nbsp;samse&nbsp;%s&nbsp;%s&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(read_group_header_option&nbsp;<span class="keywordsign">`</span><span class="constructor">Aln</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sample_name:fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>escaped_sample_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~read_group_id:(<span class="constructor">Filename</span>.basename&nbsp;r1_path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_sai<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;result)),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;common_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;result&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name&nbsp;~edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~processors:1&nbsp;~name&nbsp;&nbsp;program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"bwa"</span>;&nbsp;<span class="string">"sampe"</span>])<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sam<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Cufflinks</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;run&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~processors&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;~bam&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"cufflinks-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;result_prefix)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_dir&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-cufflinks_output"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;genes_gtf_output&nbsp;=&nbsp;output_dir&nbsp;//&nbsp;<span class="string">"genes.fpkm_tracking"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_annotations&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.gtf_exn&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cufflinks_tool&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.cufflinks&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"cufflinks"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;cufflinks_tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;output_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cufflinks&nbsp;-p&nbsp;%d&nbsp;-G&nbsp;%s&nbsp;-o&nbsp;%s&nbsp;%s<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_annotations<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;genes_gtf_output&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_annotations;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;cufflinks_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_bam);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Cycledash</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;post_to_cycledash_script&nbsp;=<br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;we&nbsp;use&nbsp;rawgit.com&nbsp;and&nbsp;not&nbsp;cdn.rawgit.com&nbsp;because&nbsp;the&nbsp;CDN&nbsp;caches<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;old&nbsp;version&nbsp;for&nbsp;ever&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="string">"https://gist.githubusercontent.com/smondet/4beec3cbd7c6a3a922bc/raw"</span><br>
<br>
<span class="keyword">let</span>&nbsp;post_vcf<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;~vcf<br>
&nbsp;&nbsp;&nbsp;&nbsp;~variant_caller_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;~dataset_name<br>
&nbsp;&nbsp;&nbsp;&nbsp;?truth_vcf<br>
&nbsp;&nbsp;&nbsp;&nbsp;?normal_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;?tumor_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;?params<br>
&nbsp;&nbsp;&nbsp;&nbsp;?witness_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;url&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;unik_script&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"/tmp/upload_to_cycledash_%s"</span>&nbsp;(<span class="constructor">Unique_id</span>.create&nbsp;())&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;script_options&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;with_path&nbsp;opt&nbsp;s&nbsp;=&nbsp;opt,&nbsp;s<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.filter_opt&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="string">"-V"</span>,&nbsp;vcf<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="string">"-v"</span>,&nbsp;variant_caller_name);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="string">"-P"</span>,&nbsp;dataset_name);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.map&nbsp;truth_vcf&nbsp;~f:(with_path&nbsp;<span class="string">"-T"</span>);&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="string">"-U"</span>,&nbsp;url);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.map&nbsp;tumor_bam&nbsp;~f:(with_path&nbsp;<span class="string">"-t"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.map&nbsp;normal_bam&nbsp;~f:(with_path&nbsp;<span class="string">"-n"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.map&nbsp;params&nbsp;~f:(<span class="keyword">fun</span>&nbsp;p&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"-N"</span>,&nbsp;p);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="string">"-w"</span>,&nbsp;<span class="constructor">Option</span>.value&nbsp;witness_output&nbsp;~default:<span class="string">"/tmp/www"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(x,&nbsp;y)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[x;&nbsp;y])&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"upload+cycledash:&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;vcf<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_download_program&nbsp;run_with&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"curl&nbsp;-f&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;post_to_cycledash_script)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;unik_script)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exec&nbsp;(<span class="string">"sh"</span>&nbsp;::&nbsp;unik_script&nbsp;::&nbsp;script_options)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dep&nbsp;=&nbsp;<span class="constructor">Option</span>.map&nbsp;~f:depends_on&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;dep&nbsp;(<span class="constructor">Some</span>&nbsp;vcf);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dep&nbsp;truth_vcf;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dep&nbsp;normal_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dep&nbsp;tumor_bam;&nbsp;]&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.filter_opt&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;witness_output&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;nothing&nbsp;~name&nbsp;~make&nbsp;~edges<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;path&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make&nbsp;~edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;path&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;forget_product<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Gatk</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Gatk_config</span>&nbsp;()&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** The name of the configuration, specific to Biokepi. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** MalformedReadFilter options.
<p>

         This filter is applied automatically by all GATK tools in order to protect them
         from crashing on reads that are grossly malformed. There are a few
         issues (such as the absence of sequence bases) that will cause the run
         to fail with an error, but these cases can be preempted by setting
         flags that cause the problem reads to also be filtered. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Ignore reads with CIGAR containing the N operator, instead of failing
         with an error *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_reads_with_n_cigar:&nbsp;bool;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Ignore reads with mismatching numbers of bases and base qualities,
         instead of failing with an error.*)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_mismatching_base_and_quals:&nbsp;bool;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Ignore reads with no stored bases (i.e. '*' where the sequence should
         be), instead of failing with an error *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_bases_not_stored:&nbsp;bool;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Other parameters: *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters:&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;t:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_reads_with_n_cigar;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_mismatching_base_and_quals;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_bases_not_stored;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters}&nbsp;=&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"filter_reads_with_N_cigar"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;filter_reads_with_n_cigar;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"filter_mismatching_base_and_quals"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;filter_mismatching_base_and_quals;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"filter_bases_not_stored"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;filter_bases_not_stored;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"parameters"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;b));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;render&nbsp;{name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_reads_with_n_cigar;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_mismatching_base_and_quals;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_bases_not_stored;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;filter_reads_with_n_cigar<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"--filter_reads_with_N_cigar"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>)&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;filter_mismatching_base_and_quals<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"--filter_mismatching_base_and_quals"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>)&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;filter_bases_not_stored<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"--filter_bases_not_stored"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">""</span>)&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[a;&nbsp;b])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.filter&nbsp;~f:(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;not&nbsp;(<span class="constructor">String</span>.is_empty&nbsp;s))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{name&nbsp;=&nbsp;<span class="string">"default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_reads_with_n_cigar&nbsp;=&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_mismatching_base_and_quals&nbsp;=&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;filter_bases_not_stored&nbsp;=&nbsp;<span class="keyword">false</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[]}<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Indel_realigner</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Gatk_config</span>&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Realigner_target_creator</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Gatk_config</span>&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Bqsr</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Gatk_config</span>&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Print_reads</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">include</span>&nbsp;<span class="constructor">Gatk_config</span>&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;indel_realigner&nbsp;=&nbsp;(<span class="constructor">Indel_realigner</span>.t&nbsp;*&nbsp;<span class="constructor">Realigner_target_creator</span>.t)<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;bqsr&nbsp;=&nbsp;(<span class="constructor">Bqsr</span>.t&nbsp;*&nbsp;<span class="constructor">Print_reads</span>.t)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_indel_realigner&nbsp;=&nbsp;(<span class="constructor">Indel_realigner</span>.default,&nbsp;<span class="constructor">Realigner_target_creator</span>.default)<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_bqsr&nbsp;=&nbsp;(<span class="constructor">Bqsr</span>.default,&nbsp;<span class="constructor">Print_reads</span>.default)<br>
<br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Mutect2</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;use_dbsnp:&nbsp;bool;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;use_cosmic:&nbsp;bool;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;additional_arguments:&nbsp;string&nbsp;list;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;create<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(use_dbsnp&nbsp;=&nbsp;<span class="keyword">true</span>)&nbsp;?(use_cosmic&nbsp;=&nbsp;<span class="keyword">true</span>)&nbsp;name&nbsp;additional_arguments&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{name;&nbsp;use_dbsnp;&nbsp;use_cosmic;&nbsp;additional_arguments}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;use_dbsnp;&nbsp;use_cosmic;&nbsp;additional_arguments}<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"use-cosmic"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;use_cosmic;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"use-dbsnp"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;use_dbsnp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"additional-arguments"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">List</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;additional_arguments&nbsp;~f:(<span class="keyword">fun</span>&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;s));<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=&nbsp;create&nbsp;<span class="string">"default"</span>&nbsp;[]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;compile&nbsp;~reference&nbsp;{name;&nbsp;use_dbsnp;&nbsp;use_cosmic;&nbsp;additional_arguments}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;with_db&nbsp;use&nbsp;opt_name&nbsp;get_exn&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;not&nbsp;use&nbsp;<span class="keyword">then</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;node&nbsp;=&nbsp;get_exn&nbsp;reference&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Some</span>&nbsp;(&nbsp;[opt_name;&nbsp;node<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path],&nbsp;[<span class="constructor">KEDSL</span>.depends_on&nbsp;node])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;args,&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.filter_opt&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with_db&nbsp;use_dbsnp&nbsp;&nbsp;<span class="string">"--dbsnp"</span>&nbsp;<span class="constructor">Reference_genome</span>.dbsnp_exn;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with_db&nbsp;use_cosmic&nbsp;&nbsp;<span class="string">"--cosmic"</span>&nbsp;<span class="constructor">Reference_genome</span>.cosmic_exn;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">List</span>.split<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span><span class="constructor">Arguments</span>&nbsp;(<span class="constructor">List</span>.concat&nbsp;args&nbsp;@&nbsp;additional_arguments),<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Edges</span>&nbsp;(<span class="constructor">List</span>.concat&nbsp;edges))<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">end</span><br>
<br>
&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;For&nbsp;now&nbsp;we&nbsp;have&nbsp;the&nbsp;two&nbsp;steps&nbsp;in&nbsp;the&nbsp;same&nbsp;target&nbsp;but&nbsp;this&nbsp;could<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be&nbsp;split&nbsp;in&nbsp;two.<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c.f.&nbsp;https://www.broadinstitute.org/gatk/guide/tooldocs/org_broadinstitute_gatk_tools_walkers_indels_IndelRealigner.php<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&nbsp;want&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;run&nbsp;the&nbsp;indel-realigner&nbsp;on&nbsp;mutliple&nbsp;bams,&nbsp;so&nbsp;we<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cannot&nbsp;use&nbsp;the&nbsp;usual&nbsp;`~result_prefix`&nbsp;argument:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See&nbsp;the&nbsp;documentation&nbsp;for&nbsp;the&nbsp;`--nWayOut`&nbsp;option:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;https://www.broadinstitute.org/gatk/guide/tooldocs/org_broadinstitute_gatk_tools_walkers_indels_IndelRealigner.php#--nWayOut<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;See&nbsp;also<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://gatkforums.broadinstitute.org/gatk/discussion/5588/best-practice-for-multi-sample-non-human-indel-realignment<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Also,&nbsp;the&nbsp;documentation&nbsp;is&nbsp;incomplete&nbsp;(or&nbsp;buggy),&nbsp;the&nbsp;option&nbsp;`--nWayOut`<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;will&nbsp;output&nbsp;the&nbsp;Bam&nbsp;files&nbsp;in&nbsp;the&nbsp;current&nbsp;directory&nbsp;(i.e.&nbsp;the&nbsp;one&nbsp;GATK&nbsp;is<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;running&nbsp;in).<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;So,&nbsp;unless&nbsp;the&nbsp;user&nbsp;uses&nbsp;the&nbsp;`?run_directory`&nbsp;option,&nbsp;we&nbsp;extract&nbsp;that<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directory&nbsp;from&nbsp;the&nbsp;input-bams;&nbsp;if&nbsp;they&nbsp;do&nbsp;not&nbsp;coincide&nbsp;we&nbsp;consider&nbsp;this&nbsp;an<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error.<br>
<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On&nbsp;top&nbsp;of&nbsp;that&nbsp;we&nbsp;use&nbsp;the&nbsp;GADT&nbsp;`_&nbsp;KEDSL.bam_or_bams`&nbsp;to&nbsp;return&nbsp;have&nbsp;2<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;possible&nbsp;return&nbsp;types:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_file&nbsp;workflow_node&nbsp;or&nbsp;bam_list&nbsp;workflow_node<br>
&nbsp;&nbsp;*)</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Configuration</span><br>
<br>
<span class="keyword">let</span>&nbsp;indel_realigner_output_filename_tag<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration:(ir_config,&nbsp;target_config)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?region&nbsp;input_bams&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;digest_of_input&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;input_bams&nbsp;~f:(<span class="keyword">fun</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;o<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;we&nbsp;make&nbsp;this&nbsp;file&nbsp;“unique”&nbsp;with&nbsp;an&nbsp;MD5&nbsp;sum&nbsp;of&nbsp;the&nbsp;input&nbsp;paths&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Digest</span>.string&nbsp;|&gt;&nbsp;<span class="constructor">Digest</span>.to_hex&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_number&nbsp;=&nbsp;<span class="constructor">List</span>.length&nbsp;input_bams&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">""</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"_indelreal-"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;ir_config.<span class="constructor">Configuration</span>.<span class="constructor">Indel_realigner</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;target_config.<span class="constructor">Configuration</span>.<span class="constructor">Realigner_target_creator</span>.name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"-%dx"</span>&nbsp;bam_number;<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;bam_number&nbsp;=&nbsp;1&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">"-"</span>&nbsp;^&nbsp;digest_of_input&nbsp;());<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~f:(<span class="keyword">fun</span>&nbsp;r&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"-"</span>&nbsp;^&nbsp;<span class="constructor">Region</span>.to_filename&nbsp;r)&nbsp;region&nbsp;~default:<span class="string">""</span>;<br>
&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;indel_realigner&nbsp;:<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;a.<br>
&nbsp;&nbsp;?compress:bool&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;?on_region:&nbsp;<span class="constructor">Region</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;configuration:(<span class="constructor">Indel_realigner</span>.t&nbsp;*&nbsp;<span class="constructor">Realigner_target_creator</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;run_with:<span class="constructor">Machine</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;?run_directory:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;a&nbsp;<span class="constructor">KEDSL</span>.bam_or_bams&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;a&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;?(compress=<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(on_region&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Full</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with&nbsp;?run_directory<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_bam_or_bams&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam_1,&nbsp;more_input_bams&nbsp;=&nbsp;<span class="comment">(*&nbsp;this&nbsp;an&nbsp;at-least-length-1&nbsp;list&nbsp;:)&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input_bam_or_bams&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_bam</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam,&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_workflow_list</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Empty&nbsp;bam-list&nbsp;in&nbsp;Gatk.indel_realigner`"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_workflow_list</span>&nbsp;(one&nbsp;::&nbsp;more)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(one,&nbsp;more)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_directory&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;run_directory&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dir&nbsp;=&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;input_bam_1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.iter&nbsp;more_input_bams&nbsp;~f:(<span class="keyword">fun</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;&lt;&gt;&nbsp;dir&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"These&nbsp;two&nbsp;BAMS&nbsp;are&nbsp;not&nbsp;in&nbsp;the&nbsp;same&nbsp;directory:\n\&nbsp;&nbsp;&nbsp;&nbsp;%s\n\&nbsp;&nbsp;&nbsp;&nbsp;%s\nGATK.indel_realigner&nbsp;when&nbsp;running&nbsp;on&nbsp;multiple&nbsp;bams&nbsp;requires&nbsp;a&nbsp;proper&nbsp;run-directory,&nbsp;clean-up&nbsp;your&nbsp;bams&nbsp;or&nbsp;provide&nbsp;the&nbsp;option&nbsp;~run_directory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"</span>&nbsp;input_bam_1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;rundir&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;rundir<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;indel_config,&nbsp;target_config&nbsp;=&nbsp;configuration&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_sorted_bam_1&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;input_bam_1&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;more_input_sorted_bams&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;more_input_bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="constructor">Samtools</span>.sort_bam_if_necessary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;more_input_bams&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Use_the_sorted_ones_please</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam_1&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Use_the_sorted_ones_please</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;ignore&nbsp;(more_input_bams,&nbsp;input_bam_1);<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"gatk-indelrealign-%s-%dx-%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Region</span>.to_filename&nbsp;on_region)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.length&nbsp;more_input_sorted_bams&nbsp;+&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;input_sorted_bam_1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.gatk&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_genome&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_build&nbsp;=&nbsp;input_sorted_bam_1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference_genome&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;let&nbsp;digest_of_input&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List.map&nbsp;(input_sorted_bam_1&nbsp;::&nbsp;more_input_sorted_bams)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(fun&nbsp;o&nbsp;-&gt;&nbsp;o#product#path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;String.concat&nbsp;~sep:""<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(*&nbsp;we&nbsp;make&nbsp;this&nbsp;file&nbsp;“unique”&nbsp;with&nbsp;an&nbsp;MD5&nbsp;sum&nbsp;of&nbsp;the&nbsp;input&nbsp;paths&nbsp;*)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;Digest.string&nbsp;|&gt;&nbsp;Digest.to_hex&nbsp;in<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_suffix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel_realigner_output_filename_tag<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~region:on_region<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(input_sorted_bam_1&nbsp;::&nbsp;more_input_sorted_bams)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;~bam_number:(List.length&nbsp;more_input_sorted_bams&nbsp;+&nbsp;1)&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;~digest_of_input&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;"_indelreal-%s-%s-%dx%s"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target_config.Configuration.Indel_realigner.name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Region.to_filename&nbsp;on_region)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(List.length&nbsp;more_input_sorted_bams&nbsp;+&nbsp;1)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(if&nbsp;more_input_sorted_bams&nbsp;=&nbsp;[]&nbsp;then&nbsp;""&nbsp;else&nbsp;"-"&nbsp;^&nbsp;digest_of_input)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;intervals_file&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_suffix&nbsp;input_sorted_bam_1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="string">".bam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;output_suffix&nbsp;^&nbsp;<span class="string">".intervals"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_bam_path&nbsp;input&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_directory&nbsp;//&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;input<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;^&nbsp;output_suffix&nbsp;^&nbsp;<span class="string">".bam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Filename</span>.basename)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;target_creation_args&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-R"</span>;&nbsp;<span class="constructor">Filename</span>.quote&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-I"</span>;&nbsp;<span class="constructor">Filename</span>.quote&nbsp;input_sorted_bam_1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-o"</span>;&nbsp;<span class="constructor">Filename</span>.quote&nbsp;intervals_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-nt"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;processors;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="constructor">Realigner_target_creator</span>.render&nbsp;target_config<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="constructor">List</span>.concat_map&nbsp;more_input_sorted_bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[<span class="string">"-I"</span>;&nbsp;<span class="constructor">Filename</span>.quote&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;indel_real_args&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;<span class="string">"-R"</span>;&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-I"</span>;&nbsp;input_sorted_bam_1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-targetIntervals"</span>;&nbsp;intervals_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;@&nbsp;<span class="constructor">Indel_realigner</span>.render&nbsp;indel_config&nbsp;@<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;more_input_sorted_bams&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="string">"-o"</span>;&nbsp;output_bam_path&nbsp;input_sorted_bam_1]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;more&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;more<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[<span class="string">"-I"</span>;&nbsp;<span class="constructor">Filename</span>.quote&nbsp;b<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<span class="string">"--nWayOut"</span>;&nbsp;output_suffix&nbsp;^&nbsp;<span class="string">".bam"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;intervals_option&nbsp;=&nbsp;<span class="constructor">Region</span>.to_gatk_option&nbsp;on_region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"gatk"</span>;&nbsp;<span class="string">"indel-realigner"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;gatk)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;run_directory)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$GATK_JAR&nbsp;-T&nbsp;RealignerTargetCreator&nbsp;%s&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;intervals_option<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;target_creation_args)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;(<span class="string">"java&nbsp;-jar&nbsp;$GATK_JAR&nbsp;-T&nbsp;IndelRealigner&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;intervals_option<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;(<span class="keyword">if</span>&nbsp;compress&nbsp;<span class="keyword">then</span>&nbsp;<span class="string">"&nbsp;"</span>&nbsp;<span class="keyword">else</span>&nbsp;<span class="string">"&nbsp;-compress&nbsp;0&nbsp;"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;indel_real_args)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sequence_dict&nbsp;=&nbsp;<span class="comment">(*&nbsp;implicit&nbsp;dependency&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Picard</span>.create_dict&nbsp;~run_with&nbsp;fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;gatk);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;RealignerTargetCreator&nbsp;wants&nbsp;the&nbsp;`.fai`:&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.faidx&nbsp;~run_with&nbsp;fasta);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sequence_dict;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;intervals_file);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="constructor">List</span>.concat_map&nbsp;(input_sorted_bam_1&nbsp;::&nbsp;more_input_sorted_bams)&nbsp;~f:(<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;b;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;b);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;(output_bam_path&nbsp;b));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;node&nbsp;:&nbsp;<span class="keyword">type</span>&nbsp;a.&nbsp;a&nbsp;bam_or_bams&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;we&nbsp;need&nbsp;a&nbsp;function&nbsp;to&nbsp;force&nbsp;`type&nbsp;a.`&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">function</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_bam</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;is&nbsp;what&nbsp;we&nbsp;give&nbsp;to&nbsp;the&nbsp;`-o`&nbsp;option:&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;&nbsp;~name&nbsp;~make&nbsp;~edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(transform_bam&nbsp;input_sorted_bam_1<span class="keywordsign">#</span>product<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(output_bam_path&nbsp;input_sorted_bam_1))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_workflow_list</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;&nbsp;~name&nbsp;~make&nbsp;~edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bam_list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;(input_sorted_bam_1&nbsp;::&nbsp;more_input_sorted_bams)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;b&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;This&nbsp;is&nbsp;what&nbsp;the&nbsp;documentation&nbsp;says&nbsp;it&nbsp;will&nbsp;to<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;the&nbsp;`--nWayOut`&nbsp;option&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transform_bam&nbsp;b<span class="keywordsign">#</span>product&nbsp;(output_bam_path&nbsp;b))))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;node&nbsp;input_bam_or_bams<br>
<br>
<span class="keyword">let</span>&nbsp;indel_realigner_map_reduce&nbsp;:<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;a.<br>
&nbsp;&nbsp;?compress:bool&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;configuration:(<span class="constructor">Indel_realigner</span>.t&nbsp;*&nbsp;<span class="constructor">Realigner_target_creator</span>.t)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;run_with:<span class="constructor">Machine</span>.t&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;?run_directory:&nbsp;string&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;a&nbsp;<span class="constructor">KEDSL</span>.bam_or_bams&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;a&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">fun</span>&nbsp;?compress<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;?run_directory<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_bam_or_bams&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;input_bam_or_bams&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Single_bam</span>&nbsp;bam_node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;all_nodes&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;on_region&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel_realigner&nbsp;?compress<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~on_region<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with&nbsp;?run_directory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_bam_or_bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bam_node<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;~f&nbsp;(<span class="constructor">Reference_genome</span>.major_contigs&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;bam_node<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;indel_realigner_output_filename_tag<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;[bam_node]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"-merged.bam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.merge_bams&nbsp;~run_with&nbsp;all_nodes&nbsp;result_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Bam_workflow_list</span>&nbsp;bams&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;all_nodes&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;A&nbsp;list&nbsp;of&nbsp;lists&nbsp;that&nbsp;looks&nbsp;like:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[bam1_reg1;&nbsp;bam2_reg1;&nbsp;bam3_reg1];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[bam1_reg2;&nbsp;bam2_reg2;&nbsp;bam3_reg2];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[bam1_reg3;&nbsp;bam2_reg3;&nbsp;bam3_reg3];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[bam1_reg4;&nbsp;bam2_reg4;&nbsp;bam3_reg4];<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;f&nbsp;on_region&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bam_list_node&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel_realigner&nbsp;?compress<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~on_region<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;~run_with&nbsp;?run_directory<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_bam_or_bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;exploded&nbsp;=&nbsp;<span class="constructor">KEDSL</span>.explode_bam_list_node&nbsp;bam_list_node&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exploded<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.hd_exn&nbsp;bams)<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;~f&nbsp;(<span class="constructor">Reference_genome</span>.major_contigs&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;merged_bams&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.mapi&nbsp;bams&nbsp;~f:(<span class="keyword">fun</span>&nbsp;index&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;all_regions_for_this_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;all_nodes&nbsp;~f:(<span class="keyword">fun</span>&nbsp;region_n&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.nth&nbsp;region_n&nbsp;index&nbsp;|&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_exn&nbsp;~msg:<span class="string">"bug&nbsp;in&nbsp;Gatk.indel_realigner_map_reduce"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_extension&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"-%d-"</span>&nbsp;index&nbsp;<span class="comment">(*&nbsp;the&nbsp;index&nbsp;is&nbsp;there&nbsp;as&nbsp;debug/witness&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;indel_realigner_output_filename_tag<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~configuration&nbsp;bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"-merged.bam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.merge_bams&nbsp;~run_with&nbsp;all_regions_for_this_bam&nbsp;result_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name:<span class="string">"Indel-realigner-map-reduce"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(<span class="constructor">List</span>.map&nbsp;merged_bams&nbsp;~f:depends_on)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bam_list&nbsp;(<span class="constructor">List</span>.map&nbsp;merged_bams&nbsp;~f:(<span class="keyword">fun</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;n<span class="keywordsign">#</span>product)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
<br>
<br>
<br>
<span class="comment">(*&nbsp;Again&nbsp;doing&nbsp;two&nbsp;steps&nbsp;in&nbsp;one&nbsp;target&nbsp;for&nbsp;now:<br>
&nbsp;&nbsp;&nbsp;http://gatkforums.broadinstitute.org/discussion/44/base-quality-score-recalibrator<br>
&nbsp;&nbsp;&nbsp;https://www.broadinstitute.org/gatk/guide/tooldocs/org_broadinstitute_gatk_tools_walkers_bqsr_BaseRecalibrator.php<br>
*)</span><br>
<span class="keyword">let</span>&nbsp;call_gatk&nbsp;~analysis&nbsp;?(region=<span class="keywordsign">`</span><span class="constructor">Full</span>)&nbsp;args&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>.<span class="constructor">Program</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;escaped_args&nbsp;=&nbsp;<span class="constructor">List</span>.map&nbsp;~f:<span class="constructor">Filename</span>.quote&nbsp;args&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;intervals_option&nbsp;=&nbsp;<span class="constructor">Region</span>.to_gatk_option&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;sh&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="string">"java&nbsp;-jar&nbsp;$GATK_JAR&nbsp;-T&nbsp;"</span>&nbsp;::&nbsp;analysis&nbsp;::&nbsp;intervals_option&nbsp;::&nbsp;escaped_args))<br>
<br>
<span class="keyword">let</span>&nbsp;base_quality_score_recalibrator<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration:(bqsr_configuration,&nbsp;print_reads_configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;~input_bam&nbsp;~output_bam&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"gatk-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;output_bam)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.gatk&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_genome&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference_genome&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;db_snp&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.dbsnp_exn&nbsp;reference_genome&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;input_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_bam&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">Please_use_the_sorted_one</span>&nbsp;<span class="keyword">in</span>&nbsp;ignore&nbsp;input_bam;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;recal_data_table&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_suffix&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="string">".bam"</span>&nbsp;^&nbsp;<span class="string">"-recal_data.table"</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"gatk"</span>;&nbsp;<span class="string">"bqsr"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;gatk)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;call_gatk&nbsp;~analysis:<span class="string">"BaseRecalibrator"</span>&nbsp;([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-nct"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;processors;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-I"</span>;&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-R"</span>;&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-knownSites"</span>;&nbsp;db_snp<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-o"</span>;&nbsp;recal_data_table;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;@&nbsp;<span class="constructor">Configuration</span>.<span class="constructor">Bqsr</span>.render&nbsp;bqsr_configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;call_gatk&nbsp;~analysis:<span class="string">"PrintReads"</span>&nbsp;([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-nct"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;processors;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-R"</span>;&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-I"</span>;&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-BQSR"</span>;&nbsp;recal_data_table;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-o"</span>;&nbsp;output_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;@&nbsp;<span class="constructor">Configuration</span>.<span class="constructor">Print_reads</span>.render&nbsp;print_reads_configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;(transform_bam&nbsp;sorted_bam<span class="keywordsign">#</span>product&nbsp;~path:output_bam)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;gatk);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta;&nbsp;depends_on&nbsp;db_snp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_bam);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_bam);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;recal_data_table);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;haplotype_caller<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(more_edges&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~input_bam&nbsp;~result_prefix&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_on_region&nbsp;~add_edges&nbsp;region&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;region_name&nbsp;=&nbsp;<span class="constructor">Region</span>.to_filename&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s%s"</span>&nbsp;result_prefix&nbsp;region_name&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_vcf&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-germline.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.gatk&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_path&nbsp;=&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;output_vcf&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_dot_fai&nbsp;=&nbsp;<span class="constructor">Samtools</span>.faidx&nbsp;~run_with&nbsp;reference_fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sequence_dict&nbsp;=&nbsp;<span class="constructor">Picard</span>.create_dict&nbsp;~run_with&nbsp;reference_fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.dbsnp_exn&nbsp;reference&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;input_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_gatk_haplotype_caller&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;output_vcf)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"gatk"</span>;&nbsp;<span class="string">"haplotype-caller"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;gatk)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;call_gatk&nbsp;~region&nbsp;~analysis:<span class="string">"HaplotypeCaller"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-I"</span>;&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-R"</span>;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--dbsnp"</span>;&nbsp;dbsnp<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-o"</span>;&nbsp;output_vcf;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--filter_reads_with_N_cigar"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_vcf&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.variant_caller]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(add_edges&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;gatk);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;dbsnp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_dot_fai;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sequence_dict;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_bam);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_vcf);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;run_gatk_haplotype_caller<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Region</span>&nbsp;region&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;run_on_region&nbsp;~add_edges:more_edges&nbsp;region<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;targets&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="constructor">Reference_genome</span>.major_contigs&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(run_on_region&nbsp;~add_edges:[])&nbsp;<span class="comment">(*&nbsp;we&nbsp;add&nbsp;edges&nbsp;only&nbsp;to&nbsp;the&nbsp;last&nbsp;step&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;final_vcf&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">"-merged.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Vcftools</span>.vcf_concat&nbsp;~run_with&nbsp;targets&nbsp;~final_vcf&nbsp;~more_edges<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Call somatic variants with Mutect2.
<p>

    Mutect2 comes within the GATK (as opposed to <code class="code"><span class="constructor">Mutect</span></code>).
<p>

    Cf. also
    https://www.broadinstitute.org/gatk/guide/tooldocs/org_broadinstitute_gatk_tools_walkers_cancer_m2_MuTect2.php
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;mutect2<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(more_edges&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;~input_normal_bam&nbsp;~input_tumor_bam&nbsp;<span class="comment">(*&nbsp;The&nbsp;doc&nbsp;says&nbsp;only&nbsp;one&nbsp;of&nbsp;each&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_normal_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_on_region&nbsp;~add_edges&nbsp;region&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;region_name&nbsp;=&nbsp;<span class="constructor">Region</span>.to_filename&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s%s"</span>&nbsp;result_prefix&nbsp;region_name&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_vcf&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-mutect2.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.gatk&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_path&nbsp;=&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;output_vcf&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_dot_fai&nbsp;=&nbsp;<span class="constructor">Samtools</span>.faidx&nbsp;~run_with&nbsp;reference_fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sequence_dict&nbsp;=&nbsp;<span class="constructor">Picard</span>.create_dict&nbsp;~run_with&nbsp;reference_fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_normal_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;input_normal_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_tumor_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;input_tumor_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Arguments</span>&nbsp;config_arguments,&nbsp;<span class="keywordsign">`</span><span class="constructor">Edges</span>&nbsp;confg_edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Configuration</span>.<span class="constructor">Mutect2</span>.compile&nbsp;~reference&nbsp;configuration&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_caller&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;output_vcf)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"gatk"</span>;&nbsp;<span class="string">"mutect2"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;gatk)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;call_gatk&nbsp;~region&nbsp;~analysis:<span class="string">"MuTect2"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([&nbsp;<span class="string">"-I:normal"</span>;&nbsp;sorted_normal_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-I:tumor"</span>;&nbsp;sorted_tumor_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-R"</span>;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-o"</span>;&nbsp;output_vcf;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;config_arguments)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_vcf&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.variant_caller]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(add_edges&nbsp;@&nbsp;confg_edges&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;gatk);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_normal_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_tumor_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_dot_fai;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sequence_dict;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_normal_bam);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_tumor_bam);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_vcf);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;run_caller<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Region</span>&nbsp;region&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;run_on_region&nbsp;~add_edges:more_edges&nbsp;region<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;targets&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="constructor">Reference_genome</span>.major_contigs&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(run_on_region&nbsp;~add_edges:[])&nbsp;<span class="comment">(*&nbsp;we&nbsp;add&nbsp;edges&nbsp;only&nbsp;to&nbsp;the&nbsp;last&nbsp;step&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;final_vcf&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">"-merged.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Vcftools</span>.vcf_concat&nbsp;~run_with&nbsp;targets&nbsp;~final_vcf&nbsp;~more_edges<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Hisat</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;version&nbsp;:&nbsp;[<span class="keywordsign">`</span><span class="constructor">V_0_1_6_beta</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V_2_0_2_beta</span>];<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;version}:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"version"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;version&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span><span class="keywordsign">`</span><span class="constructor">V_0_1_6_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;<span class="string">"V_0_1_6_beta"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span><span class="keywordsign">`</span><span class="constructor">V_2_0_2_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;<span class="string">"V_2_0_2_beta"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_v1&nbsp;=&nbsp;{name&nbsp;=&nbsp;<span class="string">"default_v1"</span>;&nbsp;version&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">V_0_1_6_beta</span>}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_v2&nbsp;=&nbsp;{name&nbsp;=&nbsp;<span class="string">"default_v2"</span>;&nbsp;version&nbsp;=&nbsp;<span class="keywordsign">`</span><span class="constructor">V_2_0_2_beta</span>}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;get_tool&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;t.version&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span><span class="keywordsign">`</span><span class="constructor">V_0_1_6_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;hisat<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span><span class="keywordsign">`</span><span class="constructor">V_2_0_2_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;hisat2<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~index_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_dir&nbsp;=&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;index_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;version&nbsp;=&nbsp;configuration.<span class="constructor">Configuration</span>.version&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat_tool&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;(<span class="constructor">Configuration</span>.get_tool&nbsp;configuration)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;build_binary&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;version&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V_0_1_6_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"hisat-build"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V_2_0_2_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"hisat2-build"</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s"</span>&nbsp;build_binary&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;first_index_file&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;version&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V_0_1_6_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s.1.bt2"</span>&nbsp;index_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V_2_0_2_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s.1.ht2"</span>&nbsp;index_prefix<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))&nbsp;first_index_file)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.directory&nbsp;~run_with&nbsp;result_dir);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;hisat_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"hisat"</span>;&nbsp;<span class="string">"index"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;hisat_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;%s"</span>&nbsp;result_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"%s&nbsp;%s&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;build_binary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<span class="keyword">let</span>&nbsp;align<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;~fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(result_prefix:string)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_dir&nbsp;=&nbsp;(<span class="constructor">Filename</span>.dirname&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;version&nbsp;=&nbsp;configuration.<span class="constructor">Configuration</span>.version&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat_binary&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;version&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V_0_1_6_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"hisat"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">V_2_0_2_beta</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"hisat2"</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_dir&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s/%s-index/"</span>&nbsp;reference_dir&nbsp;hisat_binary&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_prefix&nbsp;=&nbsp;index_dir&nbsp;//&nbsp;(sprintf&nbsp;&nbsp;<span class="string">"%s-index"</span>&nbsp;hisat_binary)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_work_dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;(dirname&nbsp;result_prefix))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat_tool&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;(<span class="constructor">Configuration</span>.get_tool&nbsp;configuration)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat_index&nbsp;=&nbsp;index&nbsp;~index_prefix&nbsp;~reference_build&nbsp;~run_with&nbsp;~configuration&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.sam"</span>&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_path,&nbsp;r2_path_opt&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>paths&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s-rna-align-%s"</span>&nbsp;hisat_binary&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat_base_command&nbsp;=&nbsp;sprintf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"%s&nbsp;-p&nbsp;%d&nbsp;-x&nbsp;%s&nbsp;-S&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hisat_binary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;index_prefix)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;result)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;base_hisat_target&nbsp;~hisat_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;hisat_index;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fastq;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;hisat_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~processors&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"hisat"</span>;&nbsp;<span class="string">"align"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;hisat_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;in_work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;hisat_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2_path_opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;read2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hisat_base_command;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-1"</span>;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-2"</span>;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;read2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;base_hisat_target&nbsp;~hisat_command<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;hisat_command&nbsp;=&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hisat_base_command;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-U"</span>;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;base_hisat_target&nbsp;~hisat_command<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Kallisto</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(** Workflow-nodes to run <a href="https://pachterlab.github.io/kallisto/about.html">kallisto</a>. *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Create a kallisto specific index of the transcriptome (cDNA) *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_transcriptome&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.cdna_exn&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kallisto_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.kallisto&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"kallisto-index-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;reference_transcriptome<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_dir&nbsp;=&nbsp;(<span class="constructor">Filename</span>.dirname&nbsp;reference_transcriptome<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.kallisto.idx"</span>&nbsp;reference_dir&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))&nbsp;result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_transcriptome;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;kallisto_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"kallisto"</span>;&nbsp;<span class="string">"index"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;kallisto_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"kallisto&nbsp;index&nbsp;-i&nbsp;%s&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_transcriptome<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Quantify transcript abundance from RNA fastqs, results in abundance.tsv file *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;run<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(bootstrap_samples=100)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~processors&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;~fastq&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"kallisto-%s-bootstrap_%d"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;result_prefix)&nbsp;bootstrap_samples&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_dir&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-kallisto"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;abundance_file&nbsp;=&nbsp;output_dir&nbsp;//&nbsp;<span class="string">"abundance.tsv"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kallisto_index&nbsp;=&nbsp;index&nbsp;~reference_build&nbsp;~run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kallisto_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.kallisto&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_path,&nbsp;r2_path_opt&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>paths&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kallisto_quant_base_cmd&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"kallisto&nbsp;quant&nbsp;-i&nbsp;%s&nbsp;-o&nbsp;%s&nbsp;-b&nbsp;%d&nbsp;-t&nbsp;%d&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;kallisto_index<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bootstrap_samples<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r1_path<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;kallisto_quant&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2_path_opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;r2_path&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"%s&nbsp;%s"</span>&nbsp;kallisto_quant_base_cmd&nbsp;r2_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;kallisto_quant_base_cmd<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"kallisto"</span>;&nbsp;<span class="string">"quant"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;kallisto_tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;kallisto_quant<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;abundance_file&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span>.directory&nbsp;~run_with&nbsp;output_dir);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;kallisto_index;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;kallisto_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Mosaik</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<span class="keyword">let</span>&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.mosaik&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"mosaik-build-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.mosaik.dat"</span>&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jump_file_result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.mosaik-index"</span>&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik_tmp_dir&nbsp;=&nbsp;(<span class="constructor">Filename</span>.dirname&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;//&nbsp;<span class="string">"mosaik-tmp"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))&nbsp;index_result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;jump_file_result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;index_result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;mosaik_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"mosaik"</span>;&nbsp;<span class="string">"index"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;mosaik_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;mosaik_tmp_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"export&nbsp;MOSAIK_TMP=%s"</span>&nbsp;mosaik_tmp_dir&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Command&nbsp;to&nbsp;build&nbsp;basic&nbsp;MOSAIK&nbsp;reference&nbsp;file&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"MosaikBuild&nbsp;-fr&nbsp;%s&nbsp;-oa&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index_result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Command&nbsp;to&nbsp;build&nbsp;MOSAIK&nbsp;index&nbsp;file&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"MosaikJump&nbsp;-ia&nbsp;%s&nbsp;-hs&nbsp;15&nbsp;-out&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index_result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump_file_result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;<br>
<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;align&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(sequencer=<span class="string">"illumina"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(result_prefix:string)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;jump_file_result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.mosaik-index"</span>&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index_result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.mosaik.dat"</span>&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_work_dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;(dirname&nbsp;result_prefix))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.mosaik&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik_index&nbsp;=&nbsp;index&nbsp;~reference_build&nbsp;~run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_path,&nbsp;r2_path_opt&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>paths&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"mosaik-align-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mka_out&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.mka"</span>&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mkb_out&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.mkb"</span>&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.bam"</span>&nbsp;mka_out&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik_align_command&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"MosaikAligner&nbsp;-in&nbsp;%s&nbsp;-out&nbsp;%s&nbsp;-ia&nbsp;%s&nbsp;-j&nbsp;%s&nbsp;-annpe&nbsp;$MOSAIK_PE_ANN&nbsp;-annse&nbsp;$MOSAIK_SE_ANN"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mkb_out<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mka_out<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index_result<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jump_file_result<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik_build_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Build&nbsp;MOSAIK&nbsp;specific&nbsp;input&nbsp;file&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mosaik_build_base_command&nbsp;=&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"MosaikBuild&nbsp;-q&nbsp;%s&nbsp;-st&nbsp;%s&nbsp;-out&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sequencer<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mkb_out<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2_path_opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;read2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mosaik_build_base_command;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-q2"</span>;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;read2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;mosaik_build_base_command&nbsp;&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">in</span>&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bam_file&nbsp;~reference_build&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))&nbsp;result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;mosaik_index;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fastq;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;mosaik_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"mosaik"</span>;&nbsp;<span class="string">"align"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;mosaik_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;in_work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;mosaik_build_command&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;mosaik_align_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Muse</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
</code><table><tr><td></td><td><span class="comment">(** Workflow-nodes to run <a href="http://bioinformatics.mdanderson.org/main/MuSE">MuSE</a>. *)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_type:&nbsp;[&nbsp;<span class="keywordsign">`</span><span class="constructor">WGS</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">WES</span>&nbsp;];<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_type_to_string&nbsp;input_type&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input_type&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">WGS</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"WGS"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">WES</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"WES"</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;input_type}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"input-type"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;(input_type_to_string&nbsp;input_type);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;input_type&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;is&nbsp;=&nbsp;input_type_to_string&nbsp;input_type&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;name&nbsp;=&nbsp;<span class="string">"default-"</span>&nbsp;^&nbsp;is;&nbsp;input_type}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wgs&nbsp;=&nbsp;default&nbsp;<span class="keywordsign">`</span><span class="constructor">WGS</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;wes&nbsp;=&nbsp;default&nbsp;<span class="keywordsign">`</span><span class="constructor">WES</span><br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;run<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;?(more_edges&nbsp;=&nbsp;[])&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.muse&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse_call_on_region&nbsp;region&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;region_name&nbsp;=&nbsp;<span class="constructor">Region</span>.to_filename&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s%s"</span>&nbsp;result_prefix&nbsp;region_name&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;intervals_option&nbsp;=&nbsp;<span class="constructor">Region</span>.to_samtools_specification&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file_prefix&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-out"</span>&nbsp;<span class="keyword">in</span>&nbsp;<span class="comment">(*&nbsp;MuSE&nbsp;adds&nbsp;`.MuSE.txt`&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file&nbsp;=&nbsp;output_file_prefix&nbsp;^&nbsp;<span class="string">".MuSE.txt"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_path&nbsp;=&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;output_file&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fasta_dot_fai&nbsp;=&nbsp;<span class="constructor">Samtools</span>.faidx&nbsp;~run_with&nbsp;fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;let&nbsp;sequence_dict&nbsp;=&nbsp;Picard.create_dict&nbsp;~run_with&nbsp;fasta&nbsp;in&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_normal&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;normal&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_tumor&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;tumor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_muse_call&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"muse-call-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;output_file)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;run_with&nbsp;~name&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;muse_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"$muse_bin&nbsp;call&nbsp;-f&nbsp;%s&nbsp;%s&nbsp;-O&nbsp;%s&nbsp;%s&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;intervals_option&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"-r&nbsp;%s"</span>&nbsp;o<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_file_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_tumor<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;yes,&nbsp;the&nbsp;help&nbsp;message&nbsp;says&nbsp;tumor&nbsp;then&nbsp;normal&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_file&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.variant_caller;&nbsp;<span class="string">"muse"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;muse_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_tumor;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta_dot_fai;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_tumor);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_file);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;run_muse_call<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;muse_sump&nbsp;call_file&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcf_output&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">".vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.dbsnp_exn&nbsp;reference&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;bgzipped_dbsnp&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.bgzip&nbsp;~run_with&nbsp;dbsnp&nbsp;(dbsnp<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;^&nbsp;<span class="string">".bgz"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"muse-sump-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;vcf_output)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;run_with&nbsp;~name&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;muse_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"$muse_bin&nbsp;sump&nbsp;-I&nbsp;%s&nbsp;%s&nbsp;-O&nbsp;%s&nbsp;-D&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call_file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Configuration</span>.(<span class="keyword">match</span>&nbsp;configuration.input_type&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">WGS</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"-G"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">WES</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"-E"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vcf_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bgzipped_dbsnp<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;vcf_output&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.variant_caller;&nbsp;<span class="string">"muse"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:(more_edges&nbsp;@&nbsp;[&nbsp;<span class="comment">(*&nbsp;muse_sump&nbsp;is&nbsp;the&nbsp;last&nbsp;step&nbsp;in&nbsp;every&nbsp;case&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;muse_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;call_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;bgzipped_dbsnp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Samtools</span>.tabix&nbsp;~run_with&nbsp;~tabular_format:<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;bgzipped_dbsnp);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;vcf_output);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Region</span>&nbsp;region&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;muse_call_on_region&nbsp;region&nbsp;|&gt;&nbsp;muse_sump<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;call_files&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="constructor">Reference_genome</span>.major_contigs&nbsp;reference)&nbsp;~f:muse_call_on_region<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;concatenated&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Cat</span>.concat&nbsp;~run_with&nbsp;call_files<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~result_path:(result_prefix&nbsp;^&nbsp;<span class="string">"-concat.txt"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;muse_sump&nbsp;concatenated<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Mutect</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;with_cosmic:&nbsp;bool;<br>
&nbsp;&nbsp;&nbsp;&nbsp;with_dbsnp:&nbsp;bool;<br>
&nbsp;&nbsp;&nbsp;&nbsp;parameters:&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list;<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;with_cosmic;&nbsp;with_dbsnp;&nbsp;parameters}:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"with-cosmic"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;with_cosmic;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"with-dbsnp"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;with_dbsnp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"parameters"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;b));<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;render&nbsp;{parameters;&nbsp;_}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[a;&nbsp;b])<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{name&nbsp;=&nbsp;<span class="string">"default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with_cosmic&nbsp;=&nbsp;<span class="keyword">true</span>;&nbsp;with_dbsnp&nbsp;=&nbsp;<span class="keyword">true</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[]}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default_without_cosmic&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{name&nbsp;=&nbsp;<span class="string">"default_without_cosmic"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with_cosmic&nbsp;=&nbsp;<span class="keyword">false</span>;&nbsp;with_dbsnp&nbsp;=&nbsp;<span class="keyword">true</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[]}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;run<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(more_edges&nbsp;=&nbsp;[])&nbsp;~configuration&nbsp;how&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_on_region&nbsp;~add_edges&nbsp;region&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;region_name&nbsp;=&nbsp;<span class="constructor">Region</span>.to_filename&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s%s"</span>&nbsp;result_prefix&nbsp;region_name&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;intervals_option&nbsp;=&nbsp;<span class="constructor">Region</span>.to_gatk_option&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-somatic.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dot_out_file&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-output.out"</span><span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;coverage_file&nbsp;=&nbsp;result_file&nbsp;<span class="string">"coverage.wig"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;mutect&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.mutect&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_path&nbsp;=&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;output_file&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cosmic&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;configuration.<span class="constructor">Configuration</span>.with_cosmic&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Reference_genome</span>.cosmic_exn&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;configuration.<span class="constructor">Configuration</span>.with_dbsnp&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="constructor">Reference_genome</span>.dbsnp_exn&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fasta_dot_fai&nbsp;=&nbsp;<span class="constructor">Samtools</span>.faidx&nbsp;~run_with&nbsp;fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sequence_dict&nbsp;=&nbsp;<span class="constructor">Picard</span>.create_dict&nbsp;~run_with&nbsp;fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_normal&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;normal&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_tumor&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;tumor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_mutect&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;output_file)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cosmic_option&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:<span class="string">""</span>&nbsp;cosmic&nbsp;~f:(<span class="keyword">fun</span>&nbsp;node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"--cosmic&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;node<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dbsnp_option&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:<span class="string">""</span>&nbsp;dbsnp&nbsp;~f:(<span class="keyword">fun</span>&nbsp;node&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"--dbsnp&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;node<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"mutect"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;mutect)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;(<span class="string">"java&nbsp;-Xmx2g&nbsp;-jar&nbsp;$mutect_HOME/muTect-*.jar&nbsp;--analysis_type&nbsp;MuTect&nbsp;"</span>&nbsp;^<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--reference_sequence"</span>;&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cosmic_option;&nbsp;dbsnp_option;&nbsp;intervals_option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--input_file:normal"</span>;&nbsp;sorted_normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--input_file:tumor"</span>;&nbsp;sorted_tumor<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--out"</span>;&nbsp;dot_out_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--vcf"</span>;&nbsp;output_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--coverage_file"</span>;&nbsp;coverage_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;@&nbsp;<span class="constructor">Configuration</span>.render&nbsp;configuration))))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;cosmic&nbsp;~default:[]&nbsp;~f:(<span class="keyword">fun</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[depends_on&nbsp;n])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="constructor">Option</span>.value_map&nbsp;dbsnp&nbsp;~default:[]&nbsp;~f:(<span class="keyword">fun</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[depends_on&nbsp;n])<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;add_edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;mutect);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_tumor;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta_dot_fai;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sequence_dict;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_tumor);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_file);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_file&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.variant_caller]&nbsp;~edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;run_mutect<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;how&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Region</span>&nbsp;region&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;run_on_region&nbsp;~add_edges:more_edges&nbsp;region<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Map_reduce</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;targets&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="constructor">Reference_genome</span>.major_contigs&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;pass&nbsp;the&nbsp;more_edges&nbsp;only&nbsp;to&nbsp;the&nbsp;last&nbsp;step&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(run_on_region&nbsp;~add_edges:[])&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;final_vcf&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">"-merged.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Vcftools</span>.vcf_concat&nbsp;~run_with&nbsp;targets&nbsp;~final_vcf&nbsp;~more_edges<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Optitype</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(**
   Run OptiType in <code class="code"><span class="keywordsign">`</span><span class="constructor">RNA</span></code> or <code class="code"><span class="keywordsign">`</span><span class="constructor">DNA</span></code> mode.
<p>

   Please provide a fresh <code class="code">work_dir</code> directory, it will be deleted in case of
   failure.
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;hla_type&nbsp;~work_dir&nbsp;~run_with&nbsp;~fastq&nbsp;~run_name&nbsp;nt&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.optitype&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_path,&nbsp;r2_path_opt&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>paths&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"optitype-%s"</span>&nbsp;run_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"optitype"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;work_dir]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;[<span class="string">"cd"</span>;&nbsp;work_dir]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;<span class="string">"cp&nbsp;-r&nbsp;${OPTITYPE_DATA}/data&nbsp;."</span>&nbsp;<span class="comment">(*&nbsp;HLA&nbsp;reference&nbsp;data&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;<span class="comment">(*&nbsp;config&nbsp;example&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sh&nbsp;<span class="string">"cp&nbsp;-r&nbsp;${OPTITYPE_DATA}/config.ini.example&nbsp;config.ini"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;<span class="comment">(*&nbsp;adjust&nbsp;config&nbsp;razers3&nbsp;path&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sh&nbsp;<span class="string">"sed&nbsp;-i.bak&nbsp;\"s|\\/path\\/to\\/razers3|$(which&nbsp;razers3)|g\"&nbsp;config.ini"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"OptiTypePipeline&nbsp;--verbose&nbsp;--input&nbsp;%s&nbsp;%s&nbsp;%s&nbsp;-o&nbsp;%s&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Option</span>.value_map&nbsp;~default:<span class="string">""</span>&nbsp;r2_path_opt&nbsp;~f:<span class="constructor">Filename</span>.quote)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;nt&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">DNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"--dna"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">RNA</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"--rna"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_name)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.as_host&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vol&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Ketrew_pure</span>.<span class="constructor">Target</span>.<span class="constructor">Volume</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;create&nbsp;(dir&nbsp;run_name&nbsp;[])&nbsp;~host<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~root:(<span class="constructor">Ketrew_pure</span>.<span class="constructor">Path</span>.absolute_directory_exn&nbsp;work_dir)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">object</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;is_done&nbsp;=&nbsp;<span class="constructor">Some</span>&nbsp;(<span class="keywordsign">`</span><span class="constructor">Volume_exists</span>&nbsp;vol)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">method</span>&nbsp;path&nbsp;=&nbsp;work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">end</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;product&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.depends_on&nbsp;fastq;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.on_failure_activate<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span>.directory&nbsp;~run_with&nbsp;work_dir);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Picard</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<br>
<br>
<span class="keyword">let</span>&nbsp;create_dict&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;fasta&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_create_dict&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.picard&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;(<span class="constructor">Filename</span>.chop_suffix&nbsp;src&nbsp;<span class="string">".fasta"</span>)&nbsp;<span class="string">"dict"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;picard_create_dict)&nbsp;<span class="keywordsign">&amp;&amp;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$PICARD_JAR&nbsp;CreateSequenceDictionary&nbsp;R=&nbsp;%s&nbsp;O=&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;src)&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;dest))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"picard-create-dict-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;src)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_stream_processor&nbsp;run_with&nbsp;program&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"picard"</span>;&nbsp;<span class="string">"create-dict"</span>]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;(single_file&nbsp;dest&nbsp;~host)&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;picard_create_dict);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;dest);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="comment">(*&nbsp;Sort&nbsp;the&nbsp;given&nbsp;VCF.<br>
<br>
-&nbsp;[?sequence_dict]&nbsp;A&nbsp;sequence&nbsp;dictionary&nbsp;by&nbsp;which&nbsp;the&nbsp;VCF&nbsp;will&nbsp;be&nbsp;sorted.<br>
*)</span><br>
<span class="keyword">let</span>&nbsp;sort_vcf&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;?(sequence_dict)&nbsp;input_vcf&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.picard&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sequence_name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;sequence_dict&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"default"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;d&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Filename</span>.basename&nbsp;d<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;input_vcf<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;input_vcf_base&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;src&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s.sorted-by-%s.vcf"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.chop_suffix&nbsp;src&nbsp;<span class="string">".vcf"</span>)&nbsp;sequence_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"picard-sort-vcf-%s-by-%s"</span>&nbsp;input_vcf_base&nbsp;sequence_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sequence_dict_opt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;sequence_dict&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;d&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"SEQUENCE_DICTIONARY=&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;d<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sequence_dict_edge&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;sequence_dict&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;d&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[depends_on&nbsp;d]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;picard)&nbsp;<span class="keywordsign">&amp;&amp;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(shf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$PICARD_JAR&nbsp;SortVcf&nbsp;%s&nbsp;I=&nbsp;%s&nbsp;O=&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sequence_dict_opt<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;src)&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;dest)))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_stream_processor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run_with&nbsp;program&nbsp;~name&nbsp;~self_ids:[<span class="string">"picard"</span>;&nbsp;<span class="string">"sort-vcf"</span>]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;(single_file&nbsp;dest&nbsp;~host)&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;input_vcf;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;picard);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;dest)<br>
&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;@&nbsp;sequence_dict_edge)<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Mark_duplicates_settings</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;tmpdir:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_sequences_for_disk_read_ends_map:&nbsp;int;<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_file_handles_for_read_ends_map:&nbsp;int;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sorting_collection_size_ratio:&nbsp;float;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mem_param:&nbsp;string&nbsp;option;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;factory&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span class="string">"factory"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;tmpdir&nbsp;=&nbsp;<span class="string">"/tmp"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_sequences_for_disk_read_ends_map&nbsp;=&nbsp;50000;<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_file_handles_for_read_ends_map&nbsp;=&nbsp;8000;<br>
&nbsp;&nbsp;&nbsp;&nbsp;sorting_collection_size_ratio&nbsp;=&nbsp;0.25;<br>
&nbsp;&nbsp;&nbsp;&nbsp;mem_param&nbsp;=&nbsp;<span class="constructor">None</span>;<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;factory&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span class="string">"default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;max_file_handles_for_read_ends_map&nbsp;=&nbsp;20_000;<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_java_shell_call&nbsp;t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"TMPDIR=%s&nbsp;MAX_SEQUENCES_FOR_DISK_READ_ENDS_MAP=%d&nbsp;MAX_FILE_HANDLES_FOR_READ_ENDS_MAP=%d&nbsp;SORTING_COLLECTION_SIZE_RATIO=%f&nbsp;java&nbsp;%s&nbsp;-Djava.io.tmpdir=%s&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.tmpdir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.max_sequences_for_disk_read_ends_map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.max_file_handles_for_read_ends_map<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.sorting_collection_size_ratio<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;t.mem_param&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;some&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"-Xmx%s"</span>&nbsp;some)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;t.tmpdir<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;mark_duplicates<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(settings&nbsp;=&nbsp;<span class="constructor">Mark_duplicates_settings</span>.default)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;~input_bam&nbsp;output_bam_path&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_jar&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.picard&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;metrics_path&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;(<span class="constructor">Filename</span>.chop_suffix&nbsp;output_bam_path&nbsp;<span class="string">".bam"</span>)&nbsp;<span class="string">".metrics"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;input_bam&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;java_call&nbsp;=&nbsp;<span class="constructor">Mark_duplicates_settings</span>.to_java_shell_call&nbsp;settings&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;picard_jar)&nbsp;<span class="keywordsign">&amp;&amp;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"%s&nbsp;-jar&nbsp;$PICARD_JAR&nbsp;MarkDuplicates&nbsp;VALIDATION_STRINGENCY=LENIENT&nbsp;INPUT=%s&nbsp;OUTPUT=%s&nbsp;METRICS_FILE=%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java_call<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;output_bam_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;metrics_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"picard-markdups-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;~name&nbsp;run_with&nbsp;program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"picard"</span>;&nbsp;<span class="string">"mark-duplicates"</span>]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=&nbsp;transform_bam&nbsp;&nbsp;input_bam<span class="keywordsign">#</span>product&nbsp;output_bam_path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;product<br>
&nbsp;&nbsp;&nbsp;&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;picard_jar);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_bam_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;metrics_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;bam_to_fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;?sample_name&nbsp;~run_with&nbsp;~sample_type&nbsp;~output_prefix&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;input_bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fastq_output_options,&nbsp;r1,&nbsp;r2opt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;sample_type&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Paired_end</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s_R1.fastq"</span>&nbsp;output_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s_R2.fastq"</span>&nbsp;output_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([sprintf&nbsp;<span class="string">"FASTQ=%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;r1);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"SECOND_END_FASTQ=%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;r2)],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r1,&nbsp;<span class="constructor">Some</span>&nbsp;r2)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Single_end</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.fastq"</span>&nbsp;output_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([sprintf&nbsp;<span class="string">"FASTQ=%s"</span>&nbsp;r1],&nbsp;r1,&nbsp;<span class="constructor">None</span>)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;picard_jar&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.picard&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;picard_jar)&nbsp;<span class="keywordsign">&amp;&amp;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$PICARD_JAR&nbsp;SamToFastq&nbsp;INPUT=%s&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;fastq_output_options)<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"picard-bam2fastq-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;~name&nbsp;run_with&nbsp;program<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"picard"</span>;&nbsp;<span class="string">"bam-to-fastq"</span>]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">fun</span>&nbsp;list&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;r2&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;r2)&nbsp;::&nbsp;list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;picard_jar);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;r1);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;(fastq_reads&nbsp;?name:sample_name&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with)&nbsp;r1&nbsp;r2opt)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~name&nbsp;~make&nbsp;~edges<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Samtools</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<span class="keyword">let</span>&nbsp;sam_to_bam&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;~reference_build&nbsp;file_t&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;file_t<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;(<span class="constructor">Filename</span>.chop_suffix&nbsp;src&nbsp;<span class="string">".sam"</span>)&nbsp;<span class="string">"bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;[<span class="string">"samtools"</span>;&nbsp;<span class="string">"view"</span>;&nbsp;<span class="string">"-b"</span>;&nbsp;<span class="string">"-o"</span>;&nbsp;dest;&nbsp;src])<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"sam-to-bam-%s"</span>&nbsp;(<span class="constructor">Filename</span>.chop_suffix&nbsp;src&nbsp;<span class="string">".sam"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;(bam_file&nbsp;~reference_build&nbsp;dest&nbsp;~host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;file_t;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;dest);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_success_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;src);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;faidx&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;fasta&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;src&nbsp;<span class="string">"fai"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;[<span class="string">"samtools"</span>;&nbsp;<span class="string">"faidx"</span>;&nbsp;src])&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"samtools-faidx-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;src)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;dest&nbsp;~host)&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;dest);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;flagstat&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;bam&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;src&nbsp;<span class="string">"flagstat"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)&nbsp;<span class="keywordsign">&amp;&amp;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"samtools&nbsp;flagstat&nbsp;%s&nbsp;&gt;&nbsp;%s"</span>&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;src)&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;dest)<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"samtools-flagstat-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;src)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;dest&nbsp;~host)&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;dest);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;bgzip&nbsp;~run_with&nbsp;input_file&nbsp;output_path&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"bgzip&nbsp;%s&nbsp;-c&nbsp;&gt;&nbsp;%s"</span>&nbsp;input_file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;output_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"samtools-bgzip-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;input_file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_path&nbsp;~host)&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;input_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;tabix&nbsp;~run_with&nbsp;~tabular_format&nbsp;input_file&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_path&nbsp;=&nbsp;input_file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;^&nbsp;<span class="string">".tbi"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;minus_p_argument&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;tabular_format&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Gff</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"gff"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Bed</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"bed"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Sam</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"sam"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Vcf</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"vcf"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Psltab</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"psltab"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"tabix&nbsp;-p&nbsp;%s&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;minus_p_argument<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"samtools-tabix-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;input_file<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_path&nbsp;~host)&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;input_file;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_path);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">let</span>&nbsp;do_on_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(more_depends_on=[])&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(more_requirements:&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Make_fun</span>.<span class="constructor">Requirement</span>.t&nbsp;list&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_bam&nbsp;~product&nbsp;~make_command&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub_command&nbsp;=&nbsp;make_command&nbsp;src&nbsp;product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;(<span class="string">"samtools"</span>&nbsp;::&nbsp;sub_command))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~requirements:more_requirements&nbsp;~name&nbsp;run_with&nbsp;program<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;product&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;depends_on&nbsp;input_bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;more_depends_on)<br>
<br>
<span class="keyword">let</span>&nbsp;sort_bam_no_check&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;~by&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;source&nbsp;=&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest_suffix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;by&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"sorted"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"read-name-sorted"</span><br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest_prefix&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"%s-%s"</span>&nbsp;(<span class="constructor">Filename</span>.chop_suffix&nbsp;source&nbsp;<span class="string">".bam"</span>)&nbsp;dest_suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;dest&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;dest_prefix&nbsp;<span class="string">"bam"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.transform_bam&nbsp;~change_sorting:by&nbsp;input_bam<span class="keywordsign">#</span>product&nbsp;~path:dest&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_command&nbsp;src&nbsp;des&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;command&nbsp;=&nbsp;[<span class="string">"-@"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;processors;&nbsp;src;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-T"</span>;&nbsp;dest_prefix;&nbsp;<span class="string">"-o"</span>;&nbsp;dest]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;by&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"sort"</span>&nbsp;::&nbsp;command<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"sort"</span>&nbsp;::&nbsp;<span class="string">"-n"</span>&nbsp;::&nbsp;command<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;do_on_bam&nbsp;~run_with&nbsp;input_bam&nbsp;~product&nbsp;~make_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;~more_requirements:[<span class="keywordsign">`</span><span class="constructor">Memory</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Big</span>;&nbsp;<span class="keywordsign">`</span><span class="constructor">Processors</span>&nbsp;processors]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"Samtools-sort&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
</code><table><tr><td></td><td><span class="comment">(**
    Uses <code class="code"><span class="string">"samtools sort"</span></code> if the <code class="code">input_bam</code> is not tagged as
    “sorted as the <code class="code">~by</code> argument.”
    If it is indeed already sorted the function returns the <code class="code">input_bam</code> node as
    is.
 *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;sort_bam_if_necessary&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;~by<br>
&nbsp;&nbsp;&nbsp;&nbsp;input_bam&nbsp;:&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>sorting&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;some&nbsp;<span class="keyword">when</span>&nbsp;some&nbsp;=&nbsp;by&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="comment">(*&nbsp;Already&nbsp;sorted&nbsp;“the&nbsp;same&nbsp;way”&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;input_bam<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;other&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;sort_bam_no_check&nbsp;~run_with&nbsp;input_bam&nbsp;~by<br>
<br>
<span class="comment">(*&nbsp;Produce&nbsp;an&nbsp;index&nbsp;for&nbsp;the&nbsp;given&nbsp;BAM&nbsp;file.<br>
<br>
-&nbsp;[?check_sorted]&nbsp;First&nbsp;check&nbsp;that&nbsp;the&nbsp;BAM&nbsp;is&nbsp;sorted,&nbsp;and&nbsp;fail&nbsp;if&nbsp;not.<br>
&nbsp;&nbsp;(default:&nbsp;true)<br>
*)</span><br>
<span class="keyword">let</span>&nbsp;index_to_bai&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;?(check_sorted=<span class="keyword">true</span>)&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">begin</span>&nbsp;<span class="keyword">match</span>&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>sorting&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;(<span class="constructor">Some</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Read_name</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>)&nbsp;<span class="keyword">when</span>&nbsp;check_sorted&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"In&nbsp;function&nbsp;Samtools.index_to_bai&nbsp;the&nbsp;input&nbsp;bam&nbsp;%s&nbsp;is&nbsp;not&nbsp;declared&nbsp;as&nbsp;sorted-by-coordinate&nbsp;(samtools-index&nbsp;requires&nbsp;that)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;()<br>
&nbsp;&nbsp;<span class="keyword">end</span>;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.single_file&nbsp;&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"%s.%s"</span>&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="string">"bai"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make_command&nbsp;src&nbsp;des&nbsp;=&nbsp;[<span class="string">"index"</span>;&nbsp;<span class="string">"-b"</span>;&nbsp;src]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;do_on_bam&nbsp;~run_with&nbsp;input_bam&nbsp;~product&nbsp;~make_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;~name:(sprintf&nbsp;<span class="string">"Samtools-index&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
<br>
<span class="keyword">let</span>&nbsp;mpileup&nbsp;~run_with&nbsp;?adjust_mapq&nbsp;~region&nbsp;input_bam&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;src&nbsp;=&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;adjust_mapq_option&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;adjust_mapq&nbsp;<span class="keyword">with</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;n&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"-C%d"</span>&nbsp;n&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools_region_option&nbsp;=&nbsp;<span class="constructor">Region</span>.to_samtools_option&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_genome&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;input_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference_genome&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;pileup&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Filename</span>.chop_suffix&nbsp;src&nbsp;<span class="string">".bam"</span>&nbsp;^<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"-%s%s.mpileup"</span>&nbsp;(<span class="constructor">Region</span>.to_filename&nbsp;region)&nbsp;adjust_mapq_option<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sort_bam_if_necessary&nbsp;~run_with&nbsp;input_bam&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"samtools&nbsp;mpileup&nbsp;%s&nbsp;%s&nbsp;-Bf&nbsp;%s&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;adjust_mapq_option&nbsp;samtools_region_option&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pileup<br>
&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"samtools-mpileup-%s"</span>&nbsp;<span class="constructor">Filename</span>.(basename&nbsp;pileup&nbsp;|&gt;&nbsp;chop_extension)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools);<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;index_to_bai&nbsp;~run_with&nbsp;sorted_bam&nbsp;|&gt;&nbsp;depends_on;<br>
&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;pileup);<br>
&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;(single_file&nbsp;pileup&nbsp;~host)&nbsp;~make&nbsp;~edges<br>
<br>
</code><table><tr><td></td><td><span class="comment">(**
   Merge a list of BAM files.
<p>

   The BAMs will be sorted, by coordinate, if they are not already.
<p>

   <code class="code"><span class="string">"samtools merge"</span></code> fails if the list of bams has only one (or zero) bams, so
   this functions raises an exception if <code class="code">input_bam_list</code> has lenth <code class="code">&lt;</code> 2.
<p>

   By default, duplicate @PG and @RG IDs will be automatically uniquified with a
   random suffix.
<p>
<ul>
<li><code class="code">?delete_input_on_success</code>: Delete the list of input BAMs when this node
   succeeds. (default: true)</li>
<li><code class="code">?attach_rg_tag</code>: Attach an RG tag to each alignment. The tag value is
   inferred from file names.(default: false)</li>
<li><code class="code">?uncompressed_bam_output</code>: Uncompressed BAM output. (default: false)</li>
<li><code class="code">?compress_level_one</code>: Use zlib compression level 1 to compress the output.
   (default: false)</li>
<li><code class="code">?combine_rg_headers</code>: When several input files contain @RG headers with the
   same ID, emit only one the first of them. (default: false)</li>
<li><code class="code">?combine_pg_headers</code>: When several input files contain @PG headers with the
   same ID, emit only one the first of them. (default: false)
</li>
</ul>
*)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;merge_bams<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(delete_input_on_success&nbsp;=&nbsp;<span class="keyword">true</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(attach_rg_tag&nbsp;=&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(uncompressed_bam_output&nbsp;=&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(compress_level_one&nbsp;=&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(combine_rg_headers&nbsp;=&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(combine_pg_headers&nbsp;=&nbsp;<span class="keyword">false</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;(input_bam_list&nbsp;:&nbsp;<span class="constructor">KEDSL</span>.bam_file&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;(output_bam_path&nbsp;:&nbsp;string)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;samtools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.samtools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;lgth&nbsp;=&nbsp;<span class="constructor">List</span>.length&nbsp;input_bam_list&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;lgth&nbsp;&lt;&nbsp;2&nbsp;<span class="keyword">then</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Samtools.merge_bams:&nbsp;%d&nbsp;input-bam%s&nbsp;provided&nbsp;and&nbsp;`samtools&nbsp;merge`&nbsp;will&nbsp;fail&nbsp;with&nbsp;less&nbsp;than&nbsp;2&nbsp;Bam&nbsp;files"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lgth<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;lgth&nbsp;<span class="keyword">with</span>&nbsp;1&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"&nbsp;was"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"s&nbsp;were"</span>)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bams&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;input_bam_list&nbsp;~f:(sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;options&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">if</span>&nbsp;attach_rg_tag&nbsp;<span class="keyword">then</span>&nbsp;[<span class="string">"-r"</span>]&nbsp;<span class="keyword">else</span>&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="keyword">if</span>&nbsp;uncompressed_bam_output&nbsp;<span class="keyword">then</span>&nbsp;[<span class="string">"-u"</span>]&nbsp;<span class="keyword">else</span>&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="keyword">if</span>&nbsp;compress_level_one&nbsp;<span class="keyword">then</span>&nbsp;[<span class="string">"-1"</span>]&nbsp;<span class="keyword">else</span>&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="keyword">if</span>&nbsp;combine_rg_headers&nbsp;<span class="keyword">then</span>&nbsp;[<span class="string">"-c"</span>]&nbsp;<span class="keyword">else</span>&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="keyword">if</span>&nbsp;combine_pg_headers&nbsp;<span class="keyword">then</span>&nbsp;[<span class="string">"-p"</span>]&nbsp;<span class="keyword">else</span>&nbsp;[])<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;program&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;&nbsp;<span class="constructor">Program</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;samtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="string">"samtools"</span>;&nbsp;<span class="string">"merge"</span>]&nbsp;@&nbsp;options&nbsp;@&nbsp;[output_bam_path]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="constructor">List</span>.map&nbsp;sorted_bams&nbsp;~f:(<span class="keyword">fun</span>&nbsp;bam&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"merge-%d-bams-into-%s"</span>&nbsp;(<span class="constructor">List</span>.length&nbsp;input_bam_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;output_bam_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;~name&nbsp;run_with&nbsp;program&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;remove_input_bams&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;input_bam_list&nbsp;~f:(<span class="keyword">fun</span>&nbsp;src&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_success_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;src<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;samtools)<br>
&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_bam_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;::&nbsp;<span class="constructor">List</span>.map&nbsp;sorted_bams&nbsp;~f:depends_on<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;<span class="keyword">if</span>&nbsp;delete_input_on_success&nbsp;<span class="keyword">then</span>&nbsp;remove_input_bams&nbsp;<span class="keyword">else</span>&nbsp;[]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;product&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;samtools&nbsp;merge&nbsp;creates&nbsp;sorted&nbsp;bams:&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;one&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.hd&nbsp;input_bam_list<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Option</span>.value_exn<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~msg:(sprintf&nbsp;<span class="string">"Samtools.merge_bams:&nbsp;input&nbsp;is&nbsp;empty&nbsp;list"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;(transform_bam&nbsp;one<span class="keywordsign">#</span>product&nbsp;~path:output_bam_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;product&nbsp;~make&nbsp;~edges<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Seq2HLA</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">let</span>&nbsp;hla_type&nbsp;~work_dir&nbsp;~run_with&nbsp;~r1&nbsp;~r2&nbsp;~run_name&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.seq2hla&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Why&nbsp;quote&nbsp;this&nbsp;here?&nbsp;Seems&nbsp;like&nbsp;it&nbsp;easy&nbsp;to&nbsp;create&nbsp;a&nbsp;bug,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;why&nbsp;not&nbsp;enforce&nbsp;this&nbsp;at&nbsp;node&nbsp;construction&nbsp;?*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1pt&nbsp;=&nbsp;<span class="constructor">Filename</span>.quote&nbsp;r1<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r2pt&nbsp;=&nbsp;<span class="constructor">Filename</span>.quote&nbsp;r2<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"seq2HLA-%s"</span>&nbsp;run_name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.as_host&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;[<span class="string">"mkdir"</span>;&nbsp;<span class="string">"-p"</span>;&nbsp;work_dir]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;[<span class="string">"cd"</span>;&nbsp;work_dir]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"seq2HLA&nbsp;-1&nbsp;%s&nbsp;-2&nbsp;%s&nbsp;-r&nbsp;%s&nbsp;-p&nbsp;%d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r1pt&nbsp;r2pt&nbsp;run_name&nbsp;processors)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;class1&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;(sprintf&nbsp;<span class="string">"%s-ClassI.HLAgenotype4digits"</span>&nbsp;run_name)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;class2&nbsp;=&nbsp;work_dir&nbsp;//&nbsp;(sprintf&nbsp;<span class="string">"%s-ClassII.HLAgenotype4digits"</span>&nbsp;run_name)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;cond&nbsp;=&nbsp;<span class="constructor">KEDSL</span>.list_of_files&nbsp;~host&nbsp;[class1;&nbsp;class2]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">KEDSL</span>.workflow_node&nbsp;~name&nbsp;cond&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.depends_on&nbsp;r1;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">KEDSL</span>.depends_on&nbsp;r2;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Somaticsniper</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;default_prior_probability&nbsp;=&nbsp;0.01<br>
<span class="keyword">let</span>&nbsp;default_theta&nbsp;=&nbsp;0.85<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;prior_probability:&nbsp;float;<br>
&nbsp;&nbsp;&nbsp;&nbsp;theta:&nbsp;float<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;prior_probability;&nbsp;theta}:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"prior_probability"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Float</span>&nbsp;prior_probability;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"theta"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Float</span>&nbsp;theta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;{name;&nbsp;_}&nbsp;=&nbsp;name<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;render&nbsp;{name;&nbsp;prior_probability;&nbsp;theta}&nbsp;&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;[<span class="string">"-s"</span>;&nbsp;<span class="constructor">Float</span>.to_string&nbsp;prior_probability;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-T"</span>;&nbsp;<span class="constructor">Float</span>.to_string&nbsp;theta]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span class="string">"default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;prior_probability&nbsp;=&nbsp;default_prior_probability;<br>
&nbsp;&nbsp;&nbsp;&nbsp;theta&nbsp;=&nbsp;default_theta;<br>
&nbsp;&nbsp;}<br>
<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;run<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Configuration</span>.default)&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s-%s"</span>&nbsp;result_prefix&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"somaticsniper:&nbsp;%s"</span>&nbsp;(result_file&nbsp;<span class="string">""</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sniper&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.somaticsniper&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-snvs.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_path&nbsp;=&nbsp;<span class="constructor">Filename</span>.dirname&nbsp;output_file&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_normal&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;normal&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_tumor&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;tumor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"somaticsniper"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~name&nbsp;~processors:1&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;sniper<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;run_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;exec&nbsp;(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[<span class="string">"somaticsniper"</span>;&nbsp;<span class="string">"-F"</span>;&nbsp;<span class="string">"vcf"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;(<span class="constructor">Configuration</span>.render&nbsp;configuration)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<span class="string">"-f"</span>;&nbsp;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_tumor<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_file]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_file&nbsp;~host:<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;~metadata:(<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.variant_caller;&nbsp;<span class="string">"somaticsniper"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;sniper);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_tumor;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_tumor);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(&nbsp;<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;output_file&nbsp;);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Star</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">module</span>&nbsp;<span class="constructor">Align</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** The mapping quality MAPQ (column 5) is 255 for uniquely mapping reads,
          and int(-10*log10(1- 1/Nmap)) for multi-mapping reads. This scheme is
          same as the one used by TopHat and is compatible with Cufflinks. The
          default MAPQ=255 for the unique mappers maybe changed with to an
          integer between 0 and 255 to ensure compatibility with downstream tools
          such as GATK. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sam_mapq_unique:&nbsp;int&nbsp;option;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><table><tr><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td><span class="comment">(** Specifies the length of the genomic sequence around the annotated
          junction to be used in constructing the splice junctions
          database. Ideally, this length should be equal to the ReadLength-1,
          where ReadLength is the length of the reads. *)</span></td></tr></table><code class="code"><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overhang_length:&nbsp;int&nbsp;option;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters:&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list;<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;=&nbsp;<span class="string">"default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sam_mapq_unique&nbsp;=&nbsp;<span class="constructor">None</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overhang_length&nbsp;=&nbsp;<span class="constructor">None</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[];<br>
&nbsp;&nbsp;&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;t:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;{name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sam_mapq_unique;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overhang_length;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters}&nbsp;=&nbsp;t&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sam_mapq_unique"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;sam_mapq_unique&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Null</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Int</span>&nbsp;x);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"overhang_length"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;overhang_length&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Null</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="keywordsign">`</span><span class="constructor">Int</span>&nbsp;x);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"parameters"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;b));<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;render&nbsp;{name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sam_mapq_unique;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;overhang_length;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;overhang_length&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"--sjdbOverhang&nbsp;%d"</span>&nbsp;x<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keyword">match</span>&nbsp;sam_mapq_unique&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;x&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;0&nbsp;&gt;&nbsp;x&nbsp;<span class="keywordsign">||</span>&nbsp;x&nbsp;&gt;&nbsp;255<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">then</span>&nbsp;failwith&nbsp;<span class="string">"STAR&nbsp;Align&nbsp;sam_mapq_unique&nbsp;must&nbsp;be&nbsp;between&nbsp;0&nbsp;and&nbsp;255"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;();<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"--outSAMmapqUnique&nbsp;%d"</span>&nbsp;x)&nbsp;::<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[a;&nbsp;b])<br>
&nbsp;&nbsp;<span class="keyword">end</span><br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;index<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.star&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"star-index-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_annotations&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.gtf_exn&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_dir&nbsp;=&nbsp;(<span class="constructor">Filename</span>.dirname&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_dir&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s/star-index/"</span>&nbsp;reference_dir&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;suffix_array_result&nbsp;=&nbsp;result_dir&nbsp;//&nbsp;<span class="string">"SA"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))&nbsp;suffix_array_result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.directory&nbsp;~run_with&nbsp;result_dir);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;star_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~processors&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"star"</span>;&nbsp;<span class="string">"index"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;star_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;%s"</span>&nbsp;result_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"STAR&nbsp;--runMode&nbsp;genomeGenerate&nbsp;--genomeDir&nbsp;%s&nbsp;--genomeFastaFiles&nbsp;%s&nbsp;--sjdbGTFfile&nbsp;%s&nbsp;--runThreadN&nbsp;%d"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;reference_annotations<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
<br>
<span class="keyword">let</span>&nbsp;align<br>
&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;~fastq<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(result_prefix:string)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with&nbsp;:&nbsp;<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(configuration=<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.default)<br>
&nbsp;&nbsp;&nbsp;&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;in_work_dir&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;(dirname&nbsp;result_prefix))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.star&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star_index&nbsp;=&nbsp;index&nbsp;~reference_build&nbsp;~run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_dir&nbsp;=&nbsp;(<span class="constructor">Filename</span>.dirname&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star_index_dir&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%s/star-index/"</span>&nbsp;reference_dir&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="comment">(*&nbsp;STAR&nbsp;appends&nbsp;Aligned.sortedByCoord.out.bam&nbsp;to&nbsp;the&nbsp;filename&nbsp;*)</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"%sAligned.sortedByCoord.out.bam"</span>&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;r1_path,&nbsp;r2_path_opt&nbsp;=&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>paths&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"star-rna-align-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1_path)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star_base_command&nbsp;=&nbsp;sprintf<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"STAR&nbsp;--outSAMtype&nbsp;BAM&nbsp;SortedByCoordinate&nbsp;--outSAMstrandField&nbsp;intronMotif&nbsp;--outSAMattributes&nbsp;NH&nbsp;HI&nbsp;NM&nbsp;MD&nbsp;--outFilterIntronMotifs&nbsp;RemoveNoncanonical&nbsp;--genomeDir&nbsp;%s&nbsp;--runThreadN&nbsp;%d&nbsp;--outFileNamePrefix&nbsp;%s&nbsp;--outSAMattrRGline&nbsp;%s&nbsp;%s&nbsp;--readFilesIn&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;star_index_dir)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"ID:%s&nbsp;SM:\"%s\""</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;r1_path)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fastq<span class="keywordsign">#</span>product<span class="keywordsign">#</span>sample_name)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Configuration</span>.<span class="constructor">Align</span>.render&nbsp;configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;r1_path)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;base_star_target&nbsp;~star_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(bam_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~sorting:<span class="keywordsign">`</span><span class="constructor">Coordinate</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~host:(<span class="constructor">Machine</span>.(as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;result);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;star_index;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;fastq;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(ensure&nbsp;star_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags:[<span class="constructor">Target_tags</span>.aligner]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~make:(<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~processors&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"star"</span>;&nbsp;<span class="string">"align"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.(init&nbsp;star_tool)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;in_work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;star_command<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;))<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;r2_path_opt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;read2&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star_command&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;star_base_command;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Filename</span>.quote&nbsp;read2);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;base_star_target&nbsp;~star_command<br>
&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;star_command&nbsp;=&nbsp;star_base_command&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;base_star_target&nbsp;~star_command<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Strelka</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
&nbsp;&nbsp;<span class="comment">(*<br>
They&nbsp;happen&nbsp;to&nbsp;have&nbsp;a<br>
[website](https://sites.google.com/site/strelkasomaticvariantcaller/).<br>
<br>
The&nbsp;usage&nbsp;is:<br>
<br>
-&nbsp;create&nbsp;a&nbsp;config&nbsp;file,<br>
-&nbsp;generate&nbsp;a&nbsp;`Makefile`&nbsp;with&nbsp;`configureStrelkaWorkflow.pl`,<br>
-&nbsp;run&nbsp;`make&nbsp;-j&lt;n&gt;`.<br>
&nbsp;*)</span><br>
<br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;parameters:&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;parameters}:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"parameters"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;b));<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;generate_config_file&nbsp;~path&nbsp;config&nbsp;:&nbsp;<span class="constructor">KEDSL</span>.<span class="constructor">Program</span>.t&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"echo&nbsp;'[user]'&nbsp;&gt;&nbsp;%s"</span>&nbsp;path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;chain<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">List</span>.map&nbsp;config.parameters&nbsp;(<span class="keyword">fun</span>&nbsp;(k,&nbsp;v)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shf&nbsp;<span class="string">"echo&nbsp;'%s&nbsp;=&nbsp;%s'&nbsp;&gt;&gt;&nbsp;%s"</span>&nbsp;k&nbsp;v&nbsp;path))<br>
&nbsp;&nbsp;&nbsp;&nbsp;)<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;name&nbsp;=&nbsp;<span class="string">"default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"isSkipDepthFilters"</span>,&nbsp;<span class="string">"0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"maxInputDepth"</span>,&nbsp;<span class="string">"10000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"depthFilterMultiple"</span>,&nbsp;<span class="string">"3.0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"snvMaxFilteredBasecallFrac"</span>,&nbsp;<span class="string">"0.4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"snvMaxSpanningDeletionFrac"</span>,&nbsp;<span class="string">"0.75"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxRefRepeat"</span>,&nbsp;<span class="string">"8"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxWindowFilteredBasecallFrac"</span>,&nbsp;<span class="string">"0.3"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxIntHpolLength"</span>,&nbsp;<span class="string">"14"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvPrior"</span>,&nbsp;<span class="string">"0.000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelPrior"</span>,&nbsp;<span class="string">"0.000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvNoise"</span>,&nbsp;<span class="string">"0.0000005"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelNoise"</span>,&nbsp;<span class="string">"0.0000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvNoiseStrandBiasFrac"</span>,&nbsp;<span class="string">"0.5"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"minTier1Mapq"</span>,&nbsp;<span class="string">"40"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"minTier2Mapq"</span>,&nbsp;<span class="string">"5"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvQuality_LowerBound"</span>,&nbsp;<span class="string">"15"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelQuality_LowerBound"</span>,&nbsp;<span class="string">"30"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"isWriteRealignedBam"</span>,&nbsp;<span class="string">"0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"binSize"</span>,&nbsp;<span class="string">"25000000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"extraStrelkaArguments"</span>,&nbsp;<span class="string">"--eland-compatibility"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;test1&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;name&nbsp;=&nbsp;<span class="string">"test1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"isSkipDepthFilters"</span>,&nbsp;<span class="string">"0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"maxInputDepth"</span>,&nbsp;<span class="string">"10000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"depthFilterMultiple"</span>,&nbsp;<span class="string">"3.0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"snvMaxFilteredBasecallFrac"</span>,&nbsp;<span class="string">"0.4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"snvMaxSpanningDeletionFrac"</span>,&nbsp;<span class="string">"0.75"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxRefRepeat"</span>,&nbsp;<span class="string">"8"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxWindowFilteredBasecallFrac"</span>,&nbsp;<span class="string">"0.3"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxIntHpolLength"</span>,&nbsp;<span class="string">"14"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvPrior"</span>,&nbsp;<span class="string">"0.000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelPrior"</span>,&nbsp;<span class="string">"0.000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvNoise"</span>,&nbsp;<span class="string">"0.0000005"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelNoise"</span>,&nbsp;<span class="string">"0.0000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvNoiseStrandBiasFrac"</span>,&nbsp;<span class="string">"0.5"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"minTier1Mapq"</span>,&nbsp;<span class="string">"40"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"minTier2Mapq"</span>,&nbsp;<span class="string">"5"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvQuality_LowerBound"</span>,&nbsp;<span class="string">"15"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelQuality_LowerBound"</span>,&nbsp;<span class="string">"30"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"isWriteRealignedBam"</span>,&nbsp;<span class="string">"0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"binSize"</span>,&nbsp;<span class="string">"25000000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"extraStrelkaArguments"</span>,&nbsp;<span class="string">"--eland-compatibility"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"priorSomaticSnvRate"</span>,&nbsp;<span class="string">"1e-06"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"germlineSnvTheta"</span>,&nbsp;<span class="string">"0.001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;empty_exome&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;name&nbsp;=&nbsp;<span class="string">"empty-exome"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"isSkipDepthFilters"</span>,&nbsp;<span class="string">"1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;exome_default&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;name&nbsp;=&nbsp;<span class="string">"exome-default"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"isSkipDepthFilters"</span>,&nbsp;<span class="string">"1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"maxInputDepth"</span>,&nbsp;<span class="string">"10000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"depthFilterMultiple"</span>,&nbsp;<span class="string">"3.0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"snvMaxFilteredBasecallFrac"</span>,&nbsp;<span class="string">"0.4"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"snvMaxSpanningDeletionFrac"</span>,&nbsp;<span class="string">"0.75"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxRefRepeat"</span>,&nbsp;<span class="string">"8"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxWindowFilteredBasecallFrac"</span>,&nbsp;<span class="string">"0.3"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"indelMaxIntHpolLength"</span>,&nbsp;<span class="string">"14"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvPrior"</span>,&nbsp;<span class="string">"0.000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelPrior"</span>,&nbsp;<span class="string">"0.000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvNoise"</span>,&nbsp;<span class="string">"0.0000005"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelNoise"</span>,&nbsp;<span class="string">"0.0000001"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvNoiseStrandBiasFrac"</span>,&nbsp;<span class="string">"0.5"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"minTier1Mapq"</span>,&nbsp;<span class="string">"40"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"minTier2Mapq"</span>,&nbsp;<span class="string">"5"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"ssnvQuality_LowerBound"</span>,&nbsp;<span class="string">"15"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"sindelQuality_LowerBound"</span>,&nbsp;<span class="string">"30"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"isWriteRealignedBam"</span>,&nbsp;<span class="string">"0"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"binSize"</span>,&nbsp;<span class="string">"25000000"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"extraStrelkaArguments"</span>,&nbsp;<span class="string">"--eland-compatibility"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}<br>
<br>
<span class="keyword">end</span><br>
<br>
<br>
<span class="keyword">let</span>&nbsp;run<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;?(more_edges&nbsp;=&nbsp;[])<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(configuration&nbsp;=&nbsp;<span class="constructor">Configuration</span>.default)&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_dir&nbsp;=&nbsp;result_file&nbsp;<span class="string">"strelka_output"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;config_file_path&nbsp;=&nbsp;result_file&nbsp;&nbsp;<span class="string">"configuration"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file_path&nbsp;=&nbsp;output_dir&nbsp;//&nbsp;<span class="string">"results/passed_somatic_combined.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;strelka_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.strelka&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gatk_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.gatk&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_normal&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;normal&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_tumor&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;tumor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;working_dir&nbsp;=&nbsp;<span class="constructor">Filename</span>.(dirname&nbsp;result_prefix)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"strelka"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;strelka_tool&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;gatk_tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;&nbsp;working_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;working_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;generate_config_file&nbsp;~path:config_file_path&nbsp;configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"rm&nbsp;-fr&nbsp;%s"</span>&nbsp;output_dir&nbsp;<span class="comment">(*&nbsp;strelka&nbsp;won't&nbsp;start&nbsp;if&nbsp;this<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;directory&nbsp;exists&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"$STRELKA_BIN/configureStrelkaWorkflow.pl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--normal=%s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--tumor=%s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--ref=%s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--config=%s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--output-dir=%s&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_tumor<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;config_file_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"cd&nbsp;%s"</span>&nbsp;output_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"make&nbsp;-j%d"</span>&nbsp;processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;<span class="constructor">Gatk</span>.call_gatk&nbsp;~analysis:<span class="string">"CombineVariants"</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--variant:snvs"</span>;&nbsp;<span class="string">"results/passed.somatic.snvs.vcf"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"--variant:indels"</span>;&nbsp;<span class="string">"results/passed.somatic.indels.vcf"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-R"</span>;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-genotypeMergeOptions"</span>;&nbsp;<span class="string">"PRIORITIZE"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-o"</span>;&nbsp;output_file_path;&nbsp;<span class="string">"-priority"</span>;&nbsp;<span class="string">"snvs,indels"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_file_path&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:(more_edges&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;tumor;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;strelka_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;gatk_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_tumor;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Picard</span>.create_dict&nbsp;~run_with&nbsp;reference_fasta);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.faidx&nbsp;~run_with&nbsp;reference_fasta);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_normal);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_tumor);<br>
&nbsp;&nbsp;&nbsp;&nbsp;])<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Stringtie</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name&nbsp;:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;use_reference_gtf&nbsp;:&nbsp;bool;<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;use_reference_gtf}:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"use-reference-gtf"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">Bool</span>&nbsp;use_reference_gtf;<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=&nbsp;{name&nbsp;=&nbsp;<span class="string">"default"</span>;&nbsp;use_reference_gtf&nbsp;=&nbsp;<span class="keyword">true</span>}<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;run<br>
&nbsp;&nbsp;&nbsp;&nbsp;~configuration<br>
&nbsp;&nbsp;&nbsp;&nbsp;~(run_with:<span class="constructor">Machine</span>.t)<br>
&nbsp;&nbsp;&nbsp;&nbsp;~bam<br>
&nbsp;&nbsp;&nbsp;&nbsp;~result_prefix&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;sprintf&nbsp;<span class="string">"stringtie-%s"</span>&nbsp;(<span class="constructor">Filename</span>.basename&nbsp;result_prefix)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_dir&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-stringtie_output"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file_path&nbsp;=&nbsp;output_dir&nbsp;//&nbsp;<span class="string">"output.gtf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_genome&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;reference_genome&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sorted_bam&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Samtools</span>.sort_bam_if_necessary&nbsp;~run_with&nbsp;~by:<span class="keywordsign">`</span><span class="constructor">Coordinate</span>&nbsp;bam&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_annotations&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;gtf&nbsp;=&nbsp;<span class="constructor">Reference_genome</span>.gtf&nbsp;reference_genome&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;use_the_gtf&nbsp;=&nbsp;configuration.<span class="constructor">Configuration</span>.use_reference_gtf&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;use_the_gtf,&nbsp;gtf&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>,&nbsp;<span class="constructor">Some</span>&nbsp;some&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">Some</span>&nbsp;some<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">false</span>,&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="constructor">None</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="keyword">true</span>,&nbsp;<span class="constructor">None</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwithf&nbsp;<span class="string">"Stringtie:&nbsp;use_reference_gtf&nbsp;is&nbsp;`true`&nbsp;but&nbsp;the&nbsp;genome&nbsp;%s&nbsp;does&nbsp;not&nbsp;provide&nbsp;one&nbsp;(use&nbsp;another&nbsp;genome&nbsp;or&nbsp;allow&nbsp;this&nbsp;to&nbsp;run&nbsp;without&nbsp;GTF&nbsp;by&nbsp;giving&nbsp;another&nbsp;Configuration.t)"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Reference_genome</span>.name&nbsp;reference_genome)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;stringtie_tool&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.stringtie&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_annotations_option&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:<span class="string">""</span>&nbsp;reference_annotations<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;sprintf&nbsp;<span class="string">"-G&nbsp;%s"</span>&nbsp;<span class="constructor">Filename</span>.(quote&nbsp;o<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"stringtie"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;stringtie_tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;output_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"stringtie&nbsp;%s&nbsp;-p&nbsp;%d&nbsp;%s&nbsp;-o&nbsp;%s&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sorted_bam<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reference_annotations_option<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;output_file_path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;edges&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Option</span>.value_map&nbsp;~default:[]&nbsp;reference_annotations<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;o&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[depends_on&nbsp;o])<br>
&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;sorted_bam;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;stringtie_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Samtools</span>.index_to_bai&nbsp;~run_with&nbsp;sorted_bam);<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make&nbsp;~edges<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_file_path&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with))<br>
<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Varscan</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Remove</span>&nbsp;=&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Remove</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(**
<p>

   Expects the tool <code class="code"><span class="string">"varscan"</span></code> to provide the environment variable 
   <code class="code"><span class="string">"$VARSCAN_JAR"</span></code>.
*)</span></td></tr></table><code class="code"><br>
<br>
<span class="keyword">let</span>&nbsp;empty_vcf&nbsp;=&nbsp;<span class="string">"##fileformat=VCFv4.1<br>
##source=VarScan2<br>
##INFO=&lt;ID=DP,Number=1,Type=Integer,Description=\"Total&nbsp;depth&nbsp;of&nbsp;quality&nbsp;bases\"&gt;<br>
##INFO=&lt;ID=SOMATIC,Number=0,Type=Flag,Description=\"Indicates&nbsp;if&nbsp;record&nbsp;is&nbsp;a&nbsp;somatic&nbsp;mutation\"&gt;<br>
##INFO=&lt;ID=SS,Number=1,Type=String,Description=\"Somatic&nbsp;status&nbsp;of&nbsp;variant&nbsp;(0=Reference,1=Germline,2=Somatic,3=LOH,&nbsp;or&nbsp;5=Unknown)\"&gt;<br>
##INFO=&lt;ID=SSC,Number=1,Type=String,Description=\"Somatic&nbsp;score&nbsp;in&nbsp;Phred&nbsp;scale&nbsp;(0-255)&nbsp;derived&nbsp;from&nbsp;somatic&nbsp;p-value\"&gt;<br>
##INFO=&lt;ID=GPV,Number=1,Type=Float,Description=\"Fisher's&nbsp;Exact&nbsp;Test&nbsp;P-value&nbsp;of&nbsp;tumor+normal&nbsp;versus&nbsp;no&nbsp;variant&nbsp;for&nbsp;Germline&nbsp;calls\"&gt;<br>
##INFO=&lt;ID=SPV,Number=1,Type=Float,Description=\"Fisher's&nbsp;Exact&nbsp;Test&nbsp;P-value&nbsp;of&nbsp;tumor&nbsp;versus&nbsp;normal&nbsp;for&nbsp;Somatic/LOH&nbsp;calls\"&gt;<br>
##FILTER=&lt;ID=str10,Description=\"Less&nbsp;than&nbsp;10%&nbsp;or&nbsp;more&nbsp;than&nbsp;90%&nbsp;of&nbsp;variant&nbsp;supporting&nbsp;reads&nbsp;on&nbsp;one&nbsp;strand\"&gt;<br>
##FILTER=&lt;ID=indelError,Description=\"Likely&nbsp;artifact&nbsp;due&nbsp;to&nbsp;indel&nbsp;reads&nbsp;at&nbsp;this&nbsp;position\"&gt;<br>
##FORMAT=&lt;ID=GT,Number=1,Type=String,Description=\"Genotype\"&gt;<br>
##FORMAT=&lt;ID=GQ,Number=1,Type=Integer,Description=\"Genotype&nbsp;Quality\"&gt;<br>
##FORMAT=&lt;ID=DP,Number=1,Type=Integer,Description=\"Read&nbsp;Depth\"&gt;<br>
##FORMAT=&lt;ID=RD,Number=1,Type=Integer,Description=\"Depth&nbsp;of&nbsp;reference-supporting&nbsp;bases&nbsp;(reads1)\"&gt;<br>
##FORMAT=&lt;ID=AD,Number=1,Type=Integer,Description=\"Depth&nbsp;of&nbsp;variant-supporting&nbsp;bases&nbsp;(reads2)\"&gt;<br>
##FORMAT=&lt;ID=FREQ,Number=1,Type=String,Description=\"Variant&nbsp;allele&nbsp;frequency\"&gt;<br>
##FORMAT=&lt;ID=DP4,Number=1,Type=String,Description=\"Strand&nbsp;read&nbsp;counts:&nbsp;ref/fwd,&nbsp;ref/rev,&nbsp;var/fwd,&nbsp;var/rev\"&gt;<br>
#CHROM\tPOS\tID\tREF\tALT\tQUAL\tFILTER\tINFO\tFORMAT\tNORMAL\tTUMOR<br>
"</span><br>
<br>
<span class="keyword">let</span>&nbsp;somatic_on_region<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;?adjust_mapq&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;region&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.varscan&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;snp_output&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-snp.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;indel_output&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-indel.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;normal_pileup&nbsp;=&nbsp;<span class="constructor">Samtools</span>.mpileup&nbsp;~run_with&nbsp;~region&nbsp;?adjust_mapq&nbsp;normal&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tumor_pileup&nbsp;=&nbsp;<span class="constructor">Samtools</span>.mpileup&nbsp;~run_with&nbsp;~region&nbsp;?adjust_mapq&nbsp;tumor&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.as_host&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;tags&nbsp;=&nbsp;[<span class="constructor">Target_tags</span>.variant_caller;&nbsp;<span class="string">"varscan"</span>]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_somatic&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"somatic-"</span>&nbsp;^&nbsp;name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;big_one_liner&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"if&nbsp;[&nbsp;-s&nbsp;"</span>&nbsp;^&nbsp;normal_pileup<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&nbsp;]&nbsp;&amp;&amp;&nbsp;[&nbsp;-s&nbsp;"</span>&nbsp;^&nbsp;tumor_pileup<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;^&nbsp;<span class="string">"&nbsp;]&nbsp;;&nbsp;then&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;sprintf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$VARSCAN_JAR&nbsp;somatic&nbsp;%s&nbsp;%s&nbsp;--output-snp&nbsp;%s&nbsp;--output-indel&nbsp;%s&nbsp;--output-vcf&nbsp;1&nbsp;;&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;normal_pileup<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tumor_pileup<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snp_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&nbsp;else&nbsp;&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"echo&nbsp;'"</span>&nbsp;^&nbsp;empty_vcf&nbsp;^&nbsp;<span class="string">"'&nbsp;&gt;&nbsp;"</span>&nbsp;^&nbsp;snp_output&nbsp;^&nbsp;<span class="string">"&nbsp;;&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"echo&nbsp;'"</span>&nbsp;^&nbsp;empty_vcf&nbsp;^&nbsp;<span class="string">"'&nbsp;&gt;&nbsp;"</span>&nbsp;^&nbsp;indel_output&nbsp;^&nbsp;<span class="string">"&nbsp;;&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^&nbsp;<span class="string">"&nbsp;fi&nbsp;"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;varscan_tool&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;big_one_liner)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors:1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"varscan"</span>;&nbsp;<span class="string">"somatic"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;snp_output&nbsp;~host)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~tags<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;varscan_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;normal_pileup;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;tumor_pileup;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;snp_output);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;indel_output);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;snp_filtered&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-snpfiltered.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;indel_filtered&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-indelfiltered.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;varscan_filter&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="string">"filter-"</span>&nbsp;^&nbsp;name&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;varscan_tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$VARSCAN_JAR&nbsp;somaticFilter&nbsp;%s&nbsp;--indel-file&nbsp;%s&nbsp;--output-file&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snp_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;indel_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;snp_filtered<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$VARSCAN_JAR&nbsp;processSomatic&nbsp;%s"</span>&nbsp;snp_filtered<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$VARSCAN_JAR&nbsp;processSomatic&nbsp;%s"</span>&nbsp;indel_output<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors:1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"varscan"</span>;&nbsp;<span class="string">"somaticfilter"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;workflow_node&nbsp;~name<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;snp_filtered&nbsp;~host)&nbsp;~make&nbsp;~tags<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~edges:[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;varscan_somatic;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;snp_filtered);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;on_failure_activate&nbsp;(<span class="constructor">Remove</span>.file&nbsp;~run_with&nbsp;indel_filtered);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;varscan_filter<br>
<br>
<span class="keyword">let</span>&nbsp;somatic_map_reduce<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(more_edges&nbsp;=&nbsp;[])&nbsp;~run_with&nbsp;?adjust_mapq<br>
&nbsp;&nbsp;&nbsp;&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_on_region&nbsp;region&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_prefix&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">"-"</span>&nbsp;^&nbsp;<span class="constructor">Region</span>.to_filename&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;somatic_on_region&nbsp;~run_with<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;?adjust_mapq&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix&nbsp;region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;targets&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.map&nbsp;(<span class="constructor">Reference_genome</span>.major_contigs&nbsp;reference)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~f:run_on_region&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;final_vcf&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;<span class="string">"-merged.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Vcftools</span>.vcf_concat&nbsp;~run_with&nbsp;targets&nbsp;~final_vcf&nbsp;~more_edges<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Vcftools</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<span class="comment">(*&nbsp;<br>
<br>
&nbsp;&nbsp;&nbsp;Most&nbsp;of&nbsp;the&nbsp;“implementation”&nbsp;part&nbsp;of&nbsp;this&nbsp;module&nbsp;is&nbsp;in&nbsp;the<br>
&nbsp;&nbsp;&nbsp;{!Workflow_utilities}&nbsp;module&nbsp;(because&nbsp;functions&nbsp;are&nbsp;used&nbsp;to&nbsp;prepare&nbsp;VCFs<br>
&nbsp;&nbsp;&nbsp;associated&nbsp;with&nbsp;reference&nbsp;genomres).<br>
<br>
*)</span><br>
<br>
</code><table><tr><td></td><td><span class="comment">(** Concatenate VCFs using <code class="code"><span class="string">"vcftools concat"</span></code>. *)</span></td></tr></table><code class="code"><br>
<span class="keyword">let</span>&nbsp;vcf_concat&nbsp;~(run_with:<span class="constructor">Machine</span>.t)&nbsp;?more_edges&nbsp;vcfs&nbsp;~final_vcf&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;vcftools&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.vcftools&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;host&nbsp;=&nbsp;<span class="constructor">Machine</span>.(as_host&nbsp;run_with)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;run_program&nbsp;=&nbsp;<span class="constructor">Machine</span>.run_program&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="constructor">Workflow_utilities</span>.<span class="constructor">Vcftools</span>.vcf_concat_no_machine<br>
&nbsp;&nbsp;&nbsp;&nbsp;~host&nbsp;~vcftools&nbsp;~run_program&nbsp;?more_edges&nbsp;vcfs&nbsp;~final_vcf<br>
<span class="keyword">end</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Virmid</span>&nbsp;<br>
=&nbsp;<span class="keyword">struct</span><br>
<br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Biokepi_run_environment</span><br>
<span class="keyword">open</span>&nbsp;<span class="constructor">Common</span><br>
<br>
<br>
<br>
<span class="comment">(*&nbsp;See&nbsp;http://sourceforge.net/p/virmid/wiki/Home/&nbsp;*)</span><br>
<span class="keyword">module</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;=&nbsp;<span class="keyword">struct</span><br>
<br>
&nbsp;&nbsp;<span class="keyword">type</span>&nbsp;t&nbsp;=&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;name:&nbsp;string;<br>
&nbsp;&nbsp;&nbsp;&nbsp;parameters:&nbsp;(string&nbsp;*&nbsp;string)&nbsp;list<br>
&nbsp;&nbsp;}<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;to_json&nbsp;{name;&nbsp;parameters}:&nbsp;<span class="constructor">Yojson</span>.<span class="constructor">Basic</span>.json&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"name"</span>,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;name;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"parameters"</span>,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span><span class="constructor">Assoc</span>&nbsp;(<span class="constructor">List</span>.map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,&nbsp;b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;a,&nbsp;<span class="keywordsign">`</span><span class="constructor">String</span>&nbsp;b));<br>
&nbsp;&nbsp;&nbsp;&nbsp;]<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;render&nbsp;{parameters;&nbsp;_}&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">List</span>.concat_map&nbsp;parameters&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,b)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[a;&nbsp;b])<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;default&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;{name&nbsp;=&nbsp;<span class="string">"default"</span>;&nbsp;parameters&nbsp;=&nbsp;[]}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;example_1&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;first&nbsp;one:&nbsp;http://sourceforge.net/p/virmid/wiki/Home/#examples&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;{name=&nbsp;<span class="string">"examplel_1"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parameters&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-c1"</span>,&nbsp;<span class="string">"20"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-C1"</span>,&nbsp;<span class="string">"100"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-c2"</span>,&nbsp;<span class="string">"20"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-C2"</span>,&nbsp;<span class="string">"100"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]}<br>
<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;t&nbsp;=&nbsp;t.name<br>
<span class="keyword">end</span><br>
<br>
<span class="keyword">let</span>&nbsp;run<br>
&nbsp;&nbsp;&nbsp;&nbsp;~run_with&nbsp;~normal&nbsp;~tumor&nbsp;~result_prefix<br>
&nbsp;&nbsp;&nbsp;&nbsp;?(more_edges&nbsp;=&nbsp;[])&nbsp;~configuration&nbsp;()&nbsp;=<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">KEDSL</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">open</span>&nbsp;<span class="constructor">Configuration</span>&nbsp;<span class="keyword">in</span>&nbsp;<br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;name&nbsp;=&nbsp;<span class="constructor">Filename</span>.basename&nbsp;result_prefix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;result_file&nbsp;suffix&nbsp;=&nbsp;result_prefix&nbsp;^&nbsp;suffix&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_file&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-somatic.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;output_prefix&nbsp;=&nbsp;<span class="string">"virmid-output"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;work_dir&nbsp;=&nbsp;result_file&nbsp;<span class="string">"-workdir"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;reference_fasta&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.get_reference_genome&nbsp;run_with&nbsp;normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>reference_build<br>
&nbsp;&nbsp;&nbsp;&nbsp;|&gt;&nbsp;<span class="constructor">Reference_genome</span>.fasta&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid_tool&nbsp;=&nbsp;<span class="constructor">Machine</span>.get_tool&nbsp;run_with&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.<span class="constructor">Default</span>.virmid&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;virmid_somatic_broken_vcf&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;maybe&nbsp;it's&nbsp;actually&nbsp;not&nbsp;broken,&nbsp;but&nbsp;later&nbsp;tools&nbsp;can&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;annoyed&nbsp;by&nbsp;the&nbsp;a&nbsp;space&nbsp;in&nbsp;the&nbsp;header.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;work_dir&nbsp;//&nbsp;<span class="constructor">Filename</span>.basename&nbsp;tumor<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path&nbsp;^&nbsp;<span class="string">".virmid.som.passed.vcf"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;processors&nbsp;=&nbsp;<span class="constructor">Machine</span>.max_processors&nbsp;run_with&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;make&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.run_big_program&nbsp;run_with&nbsp;~name&nbsp;~processors<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~self_ids:[<span class="string">"virmid"</span>]<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Program</span>.(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.init&nbsp;virmid_tool<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"mkdir&nbsp;-p&nbsp;%s"</span>&nbsp;work_dir<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;sh&nbsp;(<span class="constructor">String</span>.concat&nbsp;~sep:<span class="string">"&nbsp;"</span>&nbsp;([<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"java&nbsp;-jar&nbsp;$VIRMID_JAR&nbsp;-f"</span>;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-w"</span>;&nbsp;work_dir;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-R"</span>;&nbsp;reference_fasta<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-D"</span>;&nbsp;tumor<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-N"</span>;&nbsp;normal<span class="keywordsign">#</span>product<span class="keywordsign">#</span>path;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-t"</span>;&nbsp;<span class="constructor">Int</span>.to_string&nbsp;processors;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"-o"</span>;&nbsp;output_prefix;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;@&nbsp;<span class="constructor">Configuration</span>.render&nbsp;configuration))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">&amp;&amp;</span>&nbsp;shf&nbsp;<span class="string">"sed&nbsp;'s/\\(##INFO.*Number=A,Type=String,\\)&nbsp;/\\1/'&nbsp;%s&nbsp;&gt;&nbsp;%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;virmid_somatic_broken_vcf&nbsp;output_file<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;We&nbsp;construct&nbsp;the&nbsp;`output_file`&nbsp;out&nbsp;of&nbsp;the&nbsp;“broken”&nbsp;one&nbsp;with&nbsp;`sed`.&nbsp;*)</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;workflow_node&nbsp;~name&nbsp;~make<br>
&nbsp;&nbsp;&nbsp;&nbsp;(single_file&nbsp;output_file&nbsp;~host:(<span class="constructor">Machine</span>.as_host&nbsp;run_with))<br>
&nbsp;&nbsp;&nbsp;&nbsp;~edges:(more_edges&nbsp;@&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;normal;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;tumor;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;reference_fasta;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;depends_on&nbsp;(<span class="constructor">Machine</span>.<span class="constructor">Tool</span>.ensure&nbsp;virmid_tool);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;])<br>
<span class="keyword">end</span><br>
</code></body></html>